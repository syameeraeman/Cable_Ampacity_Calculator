<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cable Ampacity Calculator</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <!-- SheetJS for Excel file reading -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary-color: #61dafb;
      --background-color: #23262c;
      --text-color: #fff;
      --border-color: #444;
      --success-color: #4CAF50;
      --error-color: #f44336;
      --warning-color: #ffb347;
      --secondary-bg: #282c34;
      --table-bg: #2e323a;
      --table-alt-bg: #23262c;
    }

    body {
      background: #f0f8ff;
      color: var(--text-color);
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .container {
      margin-top: 60px;
      background: var(--secondary-bg);
      border-radius: 14px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.18);
      padding: 36px 32px 32px 32px;
      max-width: 800px;
      width: 100%;
      text-align: center;
    }
    h1 {
      margin-bottom: 10px;
      font-size: 2.2rem;
      letter-spacing: 1px;
      color: var(--primary-color);
    }
    .input-group {
      margin: 18px 0 24px 0;
    }
    label {
      font-size: 1.1rem;
      margin-right: 8px;
    }
    input[type="number"] {
      padding: 10px;
      font-size: 1.1rem;
      border-radius: 6px;
      border: 1px solid #bbb;
      width: 120px;
      text-align: center;
      margin-right: 8px;
    }
    .results {
      margin-top: 18px;
      background: var(--background-color);
      border-radius: 10px;
      padding: 18px 10px 10px 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid var(--border-color);
      padding: 8px 12px;
      font-size: 1.05rem;
    }
    th {
      background: #353a45;
      color: var(--primary-color);
    }
    tr:nth-child(even) {
      background: var(--table-bg);
    }
    tr:nth-child(odd) {
      background: var(--table-alt-bg);
    }
    td {
      color: var(--text-color);
    }
    @media (max-width: 600px) {
      .container {
        padding: 18px 4px 18px 4px;
        max-width: 98vw;
      }
      th, td {
        padding: 6px 4px;
        font-size: 0.98rem;
      }
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      background: var(--success-color);
    }
    
    .toast.error {
      background: var(--error-color);
    }
    
    .toast.info {
      background: #2196F3;
    }
    
    /* Print Styles */
    @media print {
      body {
        background: white !important;
        color: black !important;
      }
      
      .container, .cable-library, .circuit-breaker-library, .switch-library {
        background: white !important;
        color: black !important;
        box-shadow: none !important;
        border: 1px solid #ccc !important;
      }
      
      h1, h2, h3 {
        color: black !important;
      }
      
      table {
        border: 1px solid #000 !important;
      }
      
      th, td {
        border: 1px solid #000 !important;
        color: black !important;
        background: white !important;
      }
      
      button, input, select {
        display: none !important;
      }
      
      #minimumComponents {
        page-break-inside: avoid;
      }
    }
    
    /* Library Selection Styles */
    .library-btn:hover {
      transform: scale(1.05);
    }
    
    .library-section {
      display: none;
    }
    
    .library-section.active {
      display: block;
    }
    
    /* Login Modal Styles */
    .login-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    
    .login-modal.show {
      display: flex;
    }
    
    .login-container {
      background: var(--background-color);
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      text-align: center;
      min-width: 350px;
    }
    
    .login-container h2 {
      color: var(--primary-color);
      margin-bottom: 30px;
    }
    
    .login-input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: #333;
      color: white;
      font-size: 1rem;
    }
    
    .login-input::placeholder {
      color: #888;
    }
    
    .login-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary-color);
      color: var(--background-color);
      border: none;
      border-radius: 6px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:hover {
      background: #4fa8c7;
    }
    
    .error-message {
      color: var(--error-color);
      margin-top: 10px;
      font-size: 0.9rem;
    }
    
    /* Edit Modal Styles */
    .edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    
    .edit-modal.show {
      display: flex;
    }
    
    .edit-container {
      background: var(--background-color);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      min-width: 400px;
    }
    
    .edit-container h3 {
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
    }
    
    .edit-input-group {
      margin-bottom: 15px;
    }
    
    .edit-input-group label {
      display: block;
      color: var(--text-color);
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
    
    .edit-input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: #333;
      color: white;
      font-size: 0.9rem;
    }
    
    .edit-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .edit-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .save-btn {
      background: var(--success-color);
      color: white;
    }
    
    .cancel-btn {
      background: #666;
      color: white;
    }
    
    /* Shortcut Button Hover Effects */
    #youtubeBtn:hover, #googleBtn:hover, #renEcosystemBtn:hover {
      transform: scale(1.1);
    }
    
    /* Filter Buttons */
    .min-comp-filter-btn {
      padding: 8px 18px;
      background: #353a45;
      color: var(--primary-color);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s, color 0.2s;
      margin-bottom: 8px;
    }
    .min-comp-filter-btn.active, .min-comp-filter-btn:hover {
      background: var(--primary-color);
      color: var(--background-color);
    }
    
    /* Category Filter Buttons */
    .category-filter-btn {
      padding: 6px 12px;
      background: #353a45;
      color: var(--primary-color);
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s, color 0.2s;
      margin: 2px;
    }
    .category-filter-btn.active, .category-filter-btn:hover {
      background: var(--primary-color);
      color: var(--background-color);
    }
    
    /* Add a CSS rule to ensure all form input, select, and button elements in all library forms have the same height */
    #cableForm input[type="text"],
    #cableForm input[type="number"],
    #cableForm select,
    #cableForm button[type="submit"],
    #cbForm input[type="text"],
    #cbForm input[type="number"],
    #cbForm select,
    #cbForm button[type="submit"],
    #switchForm input[type="text"],
    #switchForm input[type="number"],
    #switchForm select,
    #switchForm button[type="submit"] {
      height: 38px;
      box-sizing: border-box;
      font-size: 1rem;
      vertical-align: middle;
      min-width: 140px;
      padding-left: 10px;
      padding-right: 10px;
    }

    /* Utility Classes */
    .btn-primary {
      background: var(--primary-color);
      color: var(--background-color);
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-secondary {
      background: #666;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: bold;
    }

    .text-center {
      text-align: center;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  
  <!-- Creator Note -->
  <div style="margin-top: 24px; font-size: 0.95rem; color: #000; text-align: center;">
    Page Created by: Syamir
  </div>
  
  <!-- Login Modal -->
  <div id="loginModal" class="login-modal">
    <div class="login-container">
      <h2>🔐 Library Management Login</h2>
      <form id="loginForm">
        <input type="text" id="username" class="login-input" placeholder="Username" required>
        <input type="password" id="password" class="login-input" placeholder="Password" required>
        <button type="submit" class="login-btn">Login</button>
        <div id="loginError" class="error-message" style="display: none;"></div>
      </form>
    </div>
  </div>
  
  <!-- Edit Modal -->
  <div id="editModal" class="edit-modal">
    <div class="edit-container">
      <h3 id="editModalTitle">Edit Item</h3>
      <form id="editForm">
        <div class="edit-input-group">
          <label for="editOEM">OEM Part Number:</label>
          <input type="text" id="editOEM" class="edit-input" required>
        </div>
        <div class="edit-input-group">
          <label for="editDesc">Description:</label>
          <input type="text" id="editDesc" class="edit-input" required>
        </div>
        <div class="edit-input-group">
          <label for="editCores">No. of Cores:</label>
          <input type="number" id="editCores" class="edit-input" min="1" required>
        </div>
        <div class="edit-input-group">
          <label for="editRating">Rating (A):</label>
          <input type="number" id="editRating" class="edit-input" min="1" required>
        </div>
        <div class="edit-buttons">
          <button type="submit" class="edit-btn save-btn">Save</button>
          <button type="button" class="edit-btn cancel-btn" id="cancelEdit">Cancel</button>
          <button type="button" class="edit-btn cancel-btn" id="removeItem" style="background: #ff7675;">🗑️ Remove</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Datasheet Modal -->
  <div id="datasheetModal" class="edit-modal">
    <div class="edit-container">
      <h3 id="datasheetModalTitle">Datasheet Management</h3>
      <div id="datasheetContent">
        <div style="margin-bottom: 20px; text-align: center;">
          <p id="datasheetStatus" style="color: var(--primary-color); font-weight: bold;"></p>
        </div>
        <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
          <button id="uploadDatasheetBtn" class="edit-btn save-btn" style="background: #007bff;">📤 Upload PDF</button>
          <button id="downloadDatasheetBtn" class="edit-btn save-btn" style="background: #28a745; display: none;">📥 Download PDF</button>
          <button id="deleteDatasheetBtn" class="edit-btn cancel-btn" style="background: #dc3545; display: none;">🗑️ Delete PDF</button>
          <button id="cancelDatasheetBtn" class="edit-btn cancel-btn">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="container">
    <h1>Cable Ampacity Calculator</h1>
    <div class="input-group">
      <label for="currentInput">Rated Current (Amps):</label>
      <input type="number" id="currentInput" min="0" placeholder="e.g. 12" />
    </div>
    <div id="results" class="results" style="display:none;"></div>
  </div>
  <div style="margin-top: 24px; font-size: 0.95rem; color: #000; text-align: center;">
    Ampacity data referenced from SEMI S22-1110b Standard.
  </div>
  
  <!-- Library Selection Interface -->
  <div id="librarySelection" style="margin: 40px auto 0 auto; max-width: 800px; background: var(--background-color); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); padding: 28px 18px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
      <h2 style="color: var(--primary-color); margin: 0;">Library Management</h2>
      <div style="display: flex; gap: 10px;">
        <button id="exportDataBtn" class="btn-primary" style="display: inline-block;">📊 Export to Excel</button>
        <button id="logoutBtn" class="btn-secondary" style="display: none;">🚪 Logout</button>
      </div>
    </div>
    <div id="loginSection" style="text-align: center;">
      <button id="loginBtn" class="btn-primary" style="padding: 15px 30px; font-size: 1.1rem;">🔐 Login to Access Libraries</button>
    </div>
    <div id="libraryButtons" style="display: none;">
    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
      <button class="library-btn" data-library="cable" style="padding: 20px 30px; background: white; color: #333; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; min-width: 150px; transition: transform 0.2s;">
        🔌 Cable Library
      </button>
      <button class="library-btn" data-library="circuit-breaker" style="padding: 20px 30px; background: white; color: #333; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; min-width: 150px; transition: transform 0.2s;">
        ⚡ Circuit Breaker Library
      </button>
      <button class="library-btn" data-library="switch" style="padding: 20px 30px; background: white; color: #333; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; min-width: 150px; transition: transform 0.2s;">
        🔄 Switch Library
      </button>
    </div>
    </div>
    <div style="text-align: center; margin-top: 20px;">
      <button id="backToSelection" class="btn-secondary" style="display: none;">← Back to Library Selection</button>
    </div>
  </div>

  <div id="minCompCableCategoryContainer" style="margin: 24px auto 0 auto; max-width: 800px; display: flex; justify-content: center; align-items: center; gap: 10px;">
    <label for="minCompCableCategoryDropdown" style="color:var(--primary-color); font-weight:bold;">Cable Category:</label>
    <select id="minCompCableCategoryDropdown" style="padding: 6px 12px; border-radius: 4px; font-size: 1rem;">
      <option value="all">All Categories</option>
      <option value="Single Core">Single Core</option>
      <option value="Multi Core">Multi Core</option>
      <option value="Robotic Cable">Robotic Cable</option>
      <option value="Flexible Cable">Flexible Cable</option>
      <option value="EtherNET">EtherNET</option>
      <option value="EtherCAT">EtherCAT</option>
    </select>
  </div>

     <div class="cable-library library-section" style="margin: 40px auto 0 auto; max-width: 1200px; width: 100%; background: var(--background-color); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); padding: 28px 18px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
      <h2 style="color: var(--primary-color); margin: 0;">Cable Library</h2>
      <button class="back-to-main-btn btn-secondary">← Back to Main Page</button>
    </div>
    <form id="cableForm" style="display: flex; flex-wrap: nowrap; gap: 18px; align-items: flex-end; justify-content: center; margin-bottom: 0;">
      <div style="min-width: 120px;">
        <label for="cableCategory">Category:</label><br>
        <select id="cableCategory" required style="width: 120px;">
          <option value="Single Core">Single Core</option>
          <option value="Multi Core">Multi Core</option>
          <option value="Robotic Cable">Robotic Cable</option>
          <option value="Flexible Cable">Flexible Cable</option>
          <option value="EtherNET">EtherNET</option>
          <option value="EtherCAT">EtherCAT</option>
        </select>
      </div>
      <div style="min-width: 120px;">
        <label for="oemPart">OEM Part Number:</label><br>
        <input type="text" id="oemPart" required style="width: 120px;" />
      </div>
      <div style="min-width: 350px;">
        <label for="cableDesc">Description:</label><br>
        <input type="text" id="cableDesc" required style="width: 350px;" />
      </div>
      <div style="min-width: 40px;">
        <label for="numCores">No. of Cores:</label><br>
        <input type="number" id="numCores" min="1" required style="width: 40px;" />
      </div>
      <div style="min-width: 40px;">
        <label for="cableRating">Rating (A):</label><br>
        <input type="number" id="cableRating" min="1" required style="width: 40px;" />
      </div>
      <div>
        <button type="submit" class="btn-primary">Add Cable</button>
      </div>
    </form>
    <div style="margin-top: 20px; text-align: center;">
      <h3 style="color: var(--warning-color); margin-bottom: 15px;">Import Excel Files by Category</h3>
      <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
        <div>
          <input type="file" id="singleCoreFile" accept=".xlsx,.xls" style="display: none;" data-category="Single Core" />
          <button type="button" class="import-category-btn" data-category="Single Core" class="btn-primary" style="background: var(--success-color);">📊 Single Core</button>
        </div>
        <div>
          <input type="file" id="multiCoreFile" accept=".xlsx,.xls" style="display: none;" data-category="Multi Core" />
          <button type="button" class="import-category-btn" data-category="Multi Core" class="btn-primary" style="background: #2196F3;">📊 Multi Core</button>
        </div>
        <div>
          <input type="file" id="roboticFile" accept=".xlsx,.xls" style="display: none;" data-category="Robotic Cable" />
          <button type="button" class="import-category-btn" data-category="Robotic Cable" class="btn-primary" style="background: #FF9800;">📊 Robotic Cable</button>
        </div>
        <div>
          <input type="file" id="flexibleFile" accept=".xlsx,.xls" style="display: none;" data-category="Flexible Cable" />
          <button type="button" class="import-category-btn" data-category="Flexible Cable" class="btn-primary" style="background: #9C27B0;">📊 Flexible Cable</button>
        </div>
        <div>
          <input type="file" id="ethernetFile" accept=".xlsx,.xls" style="display: none;" data-category="EtherNET" />
          <button type="button" class="import-category-btn" data-category="EtherNET" class="btn-primary" style="background: #009688;">📊 EtherNET</button>
        </div>
        <div>
          <input type="file" id="ethercatFile" accept=".xlsx,.xls" style="display: none;" data-category="EtherCAT" />
          <button type="button" class="import-category-btn" data-category="EtherCAT" class="btn-primary" style="background: #607D8B;">📊 EtherCAT</button>
        </div>
      </div>
      <div style="margin-top: 18px; display: flex; justify-content: center;">
        <input type="text" id="searchOEM" placeholder="Search by OEM Part No or Rating" style="padding: 7px 12px; border-radius: 6px; border: 1px solid #bbb; width: 300px; font-size: 1rem; text-align: center;" />
      </div>
      <div style="margin-top: 12px; display: flex; justify-content: center; align-items: center; gap: 12px;">
        <label for="cableCategoryDropdown" style="color:var(--primary-color); font-weight:bold;">Category:</label>
        <select id="cableCategoryDropdown" style="padding: 6px 12px; border-radius: 4px; font-size: 1rem;">
          <option value="all">All Categories</option>
          <option value="Single Core">Single Core</option>
          <option value="Multi Core">Multi Core</option>
          <option value="Robotic Cable">Robotic Cable</option>
          <option value="Flexible Cable">Flexible Cable</option>
          <option value="EtherNET">EtherNET</option>
          <option value="EtherCAT">EtherCAT</option>
        </select>
      </div>
    </div>
    <div id="cableTables" style="margin-top: 30px;"></div>
  </div>
  <script>
    // Constants and Configuration
    const CONSTANTS = {
      FIREBASE_CONFIG: {
        apiKey: "AIzaSyB_8ntUz0TnWzTtygzZ-r7d-9yVg-zj254",
        authDomain: "attendance-ac65f.firebaseapp.com",
        projectId: "attendance-ac65f",
        storageBucket: "attendance-ac65f.firebasestorage.app",
        messagingSenderId: "156838355463",
        appId: "1:156838355463:web:c0533dfeae05014a0d40a2",
        measurementId: "G-614JWRFCLQ"
      },
      ADMIN_CREDENTIALS: {
        username: 'Stratus',
        password: '12345678'
      },
      SEARCH_DEBOUNCE_DELAY: 300,
      TOAST_DURATION: 3000
    };

    // Initialize Firebase
    firebase.initializeApp(CONSTANTS.FIREBASE_CONFIG);
    const db = firebase.firestore();

    // Cached DOM Elements
    const elements = {
      currentInput: document.getElementById('currentInput'),
      results: document.getElementById('results'),
      cableForm: document.getElementById('cableForm'),
      cableTables: document.getElementById('cableTables'),
      searchOEM: document.getElementById('searchOEM'),
      loginForm: document.getElementById('loginForm'),
      loginModal: document.getElementById('loginModal'),
      editModal: document.getElementById('editModal'),
      datasheetModal: document.getElementById('datasheetModal'),
      exportDataBtn: document.getElementById('exportDataBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      librarySelection: document.getElementById('librarySelection'),
      libraryButtons: document.getElementById('libraryButtons'),
      loginSection: document.getElementById('loginSection'),
      backToSelection: document.getElementById('backToSelection')
    };

    // Utility Functions
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function measurePerformance(name, fn) {
      const start = performance.now();
      const result = fn();
      const end = performance.now();
      console.log(`${name} took ${end - start}ms`);
      return result;
    }

    function handleError(error, context) {
      console.error(`Error in ${context}:`, error);
      showToast(`Error: ${error.message}`, 'error');
    }

    // Metric ampacity table for 60°C (AWG, mm², Amps, Bending Space mm) from the image
    const ampacityTable = [
      { awg: '26', mm2: 0.14, amps: 0.75, bend_mm: 16.4 },
      { awg: '24', mm2: 0.25, amps: 2, bend_mm: 16.4 },
      { awg: '22', mm2: 0.34, amps: 3, bend_mm: 13 },
      { awg: '20', mm2: 0.5, amps: 5, bend_mm: 13 },
      { awg: '18', mm2: 0.75, amps: 6, bend_mm: 13 },
      { awg: '16', mm2: 1.0, amps: 8, bend_mm: 19 },
      { awg: '14', mm2: 1.5, amps: 11, bend_mm: 19 },
      { awg: '12', mm2: 2.5, amps: 17, bend_mm: 25 },
      { awg: '10', mm2: 4.0, amps: 24, bend_mm: 25 },
      { awg: '8', mm2: 6.0, amps: 32, bend_mm: 38 },
      { awg: '6', mm2: 10.0, amps: 45, bend_mm: 51 },
      { awg: '4', mm2: 16.0, amps: 60, bend_mm: 76 },
    ];

    // Optimized input handling with debounced search
    const debouncedSearch = debounce(renderCableTables, CONSTANTS.SEARCH_DEBOUNCE_DELAY);

    elements.currentInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (isNaN(value) || value <= 0) {
        elements.results.style.display = 'none';
        elements.results.innerHTML = '';
        // Hide minimum components section when input is empty or invalid
        const existingComponents = document.getElementById('minimumComponents');
        if (existingComponents) {
          existingComponents.remove();
        }
        return;
      }
      
      measurePerformance('calculateAmpacity', () => {
      const filtered = ampacityTable.filter(row => value <= row.amps);
      let html = '<h2>Suitable Cable Sizes (60°C)</h2>';
      if (filtered.length > 0) {
          html += '<table><thead><tr><th>AWG</th><th>Metric (mm²)</th><th>Max Amps</th><th>Bending Space (mm)</th></tr></thead><tbody>';
        filtered.forEach(row => {
            html += `<tr><td>${row.awg}</td><td>${row.mm2}</td><td>${row.amps}</td><td>${row.bend_mm}</td></tr>`;
        });
        html += '</tbody></table>';
      } else {
          html += '<div style="margin-top:10px; color:var(--error-color);">No suitable size found</div>';
        }
        elements.results.innerHTML = html;
        elements.results.style.display = 'block';
        
        // Show minimum components from libraries
        showMinimumComponents(value);
      });
    });

    // --- Cable Library Section ---
    const cableForm = document.getElementById('cableForm');
    const cableTablesDiv = document.getElementById('cableTables');
    let cableLibrary = {
      'Single Core': [],
      'Multi Core': [],
      'Robotic Cable': [],
      'Flexible Cable': [],
      'EtherNET': [],
      'EtherCAT': []
    };

    cableForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const cableCategory = document.getElementById('cableCategory').value;
      const oemPart = document.getElementById('oemPart').value.trim();
      const cableDesc = document.getElementById('cableDesc').value.trim();
      const numCores = document.getElementById('numCores').value.trim();
      const cableRating = document.getElementById('cableRating').value.trim();
      if (!cableCategory || !oemPart || !cableDesc || !numCores || !cableRating) return;
      
      // Add to local array
      cableLibrary[cableCategory].push({ oemPart, cableDesc, numCores, cableRating });
      
      // Save to Firebase
      saveCableToFirebase(cableCategory, { oemPart, cableDesc, numCores, cableRating }).then(() => {
        showToast('Cable added successfully!', 'success');
        cableForm.reset();
        renderCableTables();
      }).catch(() => {
        showToast('Error adding cable. Please try again.', 'error');
      });
    });

    // Optimized search with debouncing
    elements.searchOEM.addEventListener('input', debouncedSearch);

    // Optimized search function
    function optimizedSearch(query, data, category) {
      if (!query) return data;
      
      const searchTerms = query.toLowerCase().split(' ').filter(term => term.length > 0);
      return data.filter(item => 
        searchTerms.every(term => {
          if (category === 'EtherNET' || category === 'EtherCAT') {
            return (
              (item.oemPart && item.oemPart.toLowerCase().includes(term)) ||
              (item.description && item.description.toLowerCase().includes(term)) ||
              (item.length && item.length.toString().toLowerCase().includes(term)) ||
              (item.colour && item.colour.toLowerCase().includes(term))
            );
          } else {
            return (
              (item.oemPart && item.oemPart.toLowerCase().includes(term)) ||
              (item.cableDesc && item.cableDesc.toLowerCase().includes(term)) ||
              (item.numCores && item.numCores.toString().includes(term)) ||
              (item.cableRating && item.cableRating.toString().includes(term))
            );
          }
        })
      );
    }

    function renderCableTables() {
      return measurePerformance('renderCableTables', () => {
        const searchVal = elements.searchOEM.value.trim();
        const activeCategoryFilter = document.getElementById('cableCategoryDropdown')?.value || 'all';
        const fragment = document.createDocumentFragment();
        let found = false;
        
        Object.keys(cableLibrary).forEach(cat => {
          if (activeCategoryFilter !== 'all' && cat !== activeCategoryFilter) return;
          
          // Filter cables by search value
          const filteredCables = optimizedSearch(searchVal, cableLibrary[cat], cat);
          
          // Sort cables by rating in ascending order
          filteredCables.sort((a, b) => {
            if (a.cableRating && b.cableRating) return parseInt(a.cableRating) - parseInt(b.cableRating);
            return 0;
          });
          
          if (filteredCables.length === 0) return;
          found = true;
          
          const categoryDiv = document.createElement('div');
          categoryDiv.innerHTML = `<h3 style='color:var(--warning-color); margin-bottom:6px;'>${cat}</h3>`;
          
          const table = document.createElement('table');
          table.style.marginBottom = '18px';
          
          if (cat === 'EtherNET' || cat === 'EtherCAT') {
            table.innerHTML = `
              <thead><tr>
                <th style='text-align:center;'>OEM Part Number</th>
                <th>Description</th>
                <th style='text-align:center;'>Length</th>
                <th style='text-align:center;'>Colour</th>
                <th style='text-align:center;'>Action</th>
              </tr></thead><tbody></tbody>
            `;
          } else {
            table.innerHTML = `
              <thead><tr>
                <th style='text-align:center;'>OEM Part Number</th>
                <th>Description</th>
                <th style='text-align:center;'>No. of Cores</th>
                <th style='text-align:center;'>Rating (A)</th>
                <th style='text-align:center;'>Action</th>
              </tr></thead><tbody></tbody>
            `;
          }
          
          const tbody = table.querySelector('tbody');
          filteredCables.forEach((cable, idx) => {
            const datasheetBgColor = cable.datasheetUrl ? '#007bff' : '#ff7675';
            const row = document.createElement('tr');
            
            if (cat === 'EtherNET' || cat === 'EtherCAT') {
              row.innerHTML = `
                <td style='text-align:center;'>${cable.oemPart}</td>
                <td>${cable.description}</td>
                <td style='text-align:center;'>${cable.length || ''}</td>
                <td style='text-align:center;'>${cable.colour || ''}</td>
                <td style='text-align:center;'>
                  <button class='datasheet-cable-btn' data-cat='${cat}' data-idx='${cableLibrary[cat].indexOf(cable)}' style='padding:4px 8px;background:${datasheetBgColor};color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>📄 Datasheet</button><br>
                  <button class='edit-cable-btn' data-cat='${cat}' data-idx='${cableLibrary[cat].indexOf(cable)}' style='padding:4px 8px;background:#4CAF50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>✏️ Edit</button>
                </td>
              `;
            } else {
              row.innerHTML = `
                <td style='text-align:center;'>${cable.oemPart}</td>
                <td>${cable.cableDesc}</td>
                <td style='text-align:center;'>${cable.numCores}</td>
                <td style='text-align:center;'>${cable.cableRating}</td>
                <td style='text-align:center;'>
                  <button class='datasheet-cable-btn' data-cat='${cat}' data-idx='${cableLibrary[cat].indexOf(cable)}' style='padding:4px 8px;background:${datasheetBgColor};color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>📄 Datasheet</button><br>
                  <button class='edit-cable-btn' data-cat='${cat}' data-idx='${cableLibrary[cat].indexOf(cable)}' style='padding:4px 8px;background:#4CAF50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>✏️ Edit</button>
                </td>
              `;
            }
            tbody.appendChild(row);
          });
          
          categoryDiv.appendChild(table);
          fragment.appendChild(categoryDiv);
        });
        
        elements.cableTables.innerHTML = found ? '' : '<div style="color:#bbb;">No cables found.</div>';
        if (found) {
          elements.cableTables.appendChild(fragment);
        }
      });
    }
    renderCableTables();

    // Optimized event delegation for all table interactions
    elements.cableTables.addEventListener('click', function(e) {
      const target = e.target;
      
      if (target.classList.contains('datasheet-cable-btn')) {
        const cableCategory = target.getAttribute('data-cat');
        const idx = parseInt(target.getAttribute('data-idx'));
        const cable = cableLibrary[cableCategory][idx];
        
        // Show datasheet modal
        showDatasheetModal(cable, 'cable', cableCategory, idx);
      } else if (target.classList.contains('edit-cable-btn')) {
        const cableCategory = target.getAttribute('data-cat');
        const idx = parseInt(target.getAttribute('data-idx'));
        const cableToEdit = cableLibrary[cableCategory][idx];
        
        // Populate edit modal
        document.getElementById('editModalTitle').textContent = 'Edit Cable';
        document.getElementById('editOEM').value = cableToEdit.oemPart;
        document.getElementById('editDesc').value = cableToEdit.cableDesc;
        document.getElementById('editCores').value = cableToEdit.numCores;
        document.getElementById('editRating').value = cableToEdit.cableRating;
        
        // Store current edit item
        currentEditItem = { category: cableCategory, idx: idx, type: 'cable' };
        
        // Show edit modal
        elements.editModal.classList.add('show');
      }
    });



    // Optimized Firebase functions for Cable Library
    function saveCableToFirebase(category, cableData) {
      const submitBtn = elements.cableForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.innerHTML = '<span class="spinner"></span> Save';
      submitBtn.disabled = true;
      
      let firebaseData = {
        category: category,
        oemPart: cableData.oemPart,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (category === 'EtherNET' || category === 'EtherCAT') {
        firebaseData.description = cableData.description;
        firebaseData.length = cableData.length;
        firebaseData.colour = cableData.colour;
      } else {
        firebaseData.cableDesc = cableData.cableDesc;
        firebaseData.numCores = cableData.numCores;
        firebaseData.cableRating = cableData.cableRating;
      }
      
      return db.collection('cables').add(firebaseData)
        .then(() => {
          console.log('Cable saved to Firebase');
          return true;
        })
        .catch((error) => {
          handleError(error, 'saveCableToFirebase');
          return false;
        })
        .finally(() => {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        });
    }

    // Batch operations for better performance
    function batchUpdateCables(cables) {
      const batch = db.batch();
      cables.forEach(cable => {
        const docRef = db.collection('cables').doc(cable.id);
        batch.update(docRef, cable);
      });
      return batch.commit();
    }

    function loadCablesFromFirebase() {
      db.collection('cables').get().then((querySnapshot) => {
        cableLibrary = {
          'Single Core': [],
          'Multi Core': [],
          'Robotic Cable': [],
          'Flexible Cable': [],
          'EtherNET': [],
          'EtherCAT': []
        };
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (cableLibrary[data.category]) {
            if (data.category === 'EtherNET' || data.category === 'EtherCAT') {
              cableLibrary[data.category].push({
                id: doc.id,
                oemPart: data.oemPart,
                description: data.description,
                length: data.length,
                colour: data.colour,
                datasheetUrl: data.datasheetUrl || null
              });
            } else {
              cableLibrary[data.category].push({
                id: doc.id,
                oemPart: data.oemPart,
                cableDesc: data.cableDesc,
                numCores: data.numCores,
                cableRating: data.cableRating,
                datasheetUrl: data.datasheetUrl || null
              });
            }
          }
        });
        renderCableTables();
      }).catch((error) => {
        console.error('Error loading cables: ', error);
      });
    }

    // Global variables for datasheet modal
    let currentDatasheetItem = null;
    let currentDatasheetType = null;
    let currentDatasheetCategory = null;
    let currentDatasheetIndex = null;

    // Function to show datasheet modal
    function showDatasheetModal(item, type, category, index) {
      currentDatasheetItem = item;
      currentDatasheetType = type;
      currentDatasheetCategory = category;
      currentDatasheetIndex = index;
      
      const modal = document.getElementById('datasheetModal');
      const status = document.getElementById('datasheetStatus');
      const uploadBtn = document.getElementById('uploadDatasheetBtn');
      const downloadBtn = document.getElementById('downloadDatasheetBtn');
      const deleteBtn = document.getElementById('deleteDatasheetBtn');
      
      // Update modal title
      const title = document.getElementById('datasheetModalTitle');
      const itemName = type === 'cable' ? item.oemPart : (type === 'cb' ? item.cbOEMPart : item.switchOEMPart);
      title.textContent = `Datasheet Management - ${itemName}`;
      
      if (item.datasheetUrl) {
        // Datasheet exists
        status.textContent = '📄 Datasheet available';
        uploadBtn.style.display = 'none';
        downloadBtn.style.display = 'inline-block';
        deleteBtn.style.display = 'inline-block';
      } else {
        // No datasheet
        status.textContent = '📄 No datasheet uploaded';
        uploadBtn.style.display = 'inline-block';
        downloadBtn.style.display = 'none';
        deleteBtn.style.display = 'none';
      }
      
      modal.classList.add('show');
    }

    // Datasheet modal event handlers
    document.getElementById('uploadDatasheetBtn').addEventListener('click', function() {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.pdf';
      fileInput.style.display = 'none';
      document.body.appendChild(fileInput);
      
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const pdfData = e.target.result;
            currentDatasheetItem.datasheetUrl = pdfData;
            
            // Save to Firebase based on type
            let updatePromise;
            if (currentDatasheetType === 'cable') {
              updatePromise = updateCableInFirebase(currentDatasheetItem.id, currentDatasheetItem);
            } else if (currentDatasheetType === 'cb') {
              updatePromise = updateCBInFirebase(currentDatasheetItem.id, currentDatasheetItem);
            } else if (currentDatasheetType === 'switch') {
              updatePromise = updateSwitchInFirebase(currentDatasheetItem.id, currentDatasheetItem);
            }
            
            updatePromise.then(() => {
              showToast('Datasheet PDF uploaded successfully!', 'success');
              document.getElementById('datasheetModal').classList.remove('show');
              // Refresh the tables
              if (currentDatasheetType === 'cable') renderCableTables();
              else if (currentDatasheetType === 'cb') renderCBTables();
              else if (currentDatasheetType === 'switch') renderSwitchTables();
            }).catch(() => {
              showToast('Error uploading datasheet PDF. Please try again.', 'error');
            });
          };
          reader.readAsDataURL(file);
        }
        document.body.removeChild(fileInput);
      });
      
      fileInput.click();
    });

    document.getElementById('downloadDatasheetBtn').addEventListener('click', function() {
      const link = document.createElement('a');
      link.href = currentDatasheetItem.datasheetUrl;
      link.target = '_blank';
      
      let filename;
      if (currentDatasheetType === 'cable') {
        filename = currentDatasheetItem.oemPart + '_datasheet.pdf';
      } else if (currentDatasheetType === 'cb') {
        filename = currentDatasheetItem.cbOEMPart + '_datasheet.pdf';
      } else if (currentDatasheetType === 'switch') {
        filename = currentDatasheetItem.switchOEMPart + '_datasheet.pdf';
      }
      
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      document.getElementById('datasheetModal').classList.remove('show');
    });

    document.getElementById('deleteDatasheetBtn').addEventListener('click', function() {
      if (confirm('Are you sure you want to delete this datasheet?')) {
        currentDatasheetItem.datasheetUrl = null;
        
        // Save to Firebase based on type
        let updatePromise;
        if (currentDatasheetType === 'cable') {
          updatePromise = updateCableInFirebase(currentDatasheetItem.id, currentDatasheetItem);
        } else if (currentDatasheetType === 'cb') {
          updatePromise = updateCBInFirebase(currentDatasheetItem.id, currentDatasheetItem);
        } else if (currentDatasheetType === 'switch') {
          updatePromise = updateSwitchInFirebase(currentDatasheetItem.id, currentDatasheetItem);
        }
        
        updatePromise.then(() => {
          showToast('Datasheet deleted successfully!', 'success');
          document.getElementById('datasheetModal').classList.remove('show');
          // Refresh the tables
          if (currentDatasheetType === 'cable') renderCableTables();
          else if (currentDatasheetType === 'cb') renderCBTables();
          else if (currentDatasheetType === 'switch') renderSwitchTables();
        }).catch(() => {
          showToast('Error deleting datasheet. Please try again.', 'error');
        });
      }
    });

    document.getElementById('cancelDatasheetBtn').addEventListener('click', function() {
      document.getElementById('datasheetModal').classList.remove('show');
    });

    function deleteCableFromFirebase(docId) {
      return db.collection('cables').doc(docId).delete().then(() => {
        console.log('Cable deleted from Firebase');
        return true;
      }).catch((error) => {
        console.error('Error deleting cable: ', error);
        return false;
      });
    }

    // Load cables on page load
    loadCablesFromFirebase();
    
    // Excel Import Functionality
    const importCategoryBtns = document.querySelectorAll('.import-category-btn');
    
    importCategoryBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const category = this.getAttribute('data-category');
        let fileInput;
        
        // Get the correct file input based on category
        switch(category) {
          case 'Single Core':
            fileInput = document.getElementById('singleCoreFile');
            break;
          case 'Multi Core':
            fileInput = document.getElementById('multiCoreFile');
            break;
          case 'Robotic Cable':
            fileInput = document.getElementById('roboticFile');
            break;
          case 'Flexible Cable':
            fileInput = document.getElementById('flexibleFile');
            break;
          case 'EtherNET':
            fileInput = document.getElementById('ethernetFile');
            break;
          case 'EtherCAT':
            fileInput = document.getElementById('ethercatFile');
            break;
        }
        
        if (fileInput) {
          fileInput.click();
        }
      });
    });
    
    document.getElementById('singleCoreFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'Single Core');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('multiCoreFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'Multi Core');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('roboticFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'Robotic Cable');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('flexibleFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'Flexible Cable');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('ethernetFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'EtherNET');
      }
      e.target.value = '';
    });
    document.getElementById('ethercatFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'EtherCAT');
      }
      e.target.value = '';
    });
    
    function processExcelData(file, category) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          // Process the Excel data
          processExcelDataForCategory(jsonData, category);
          
          showToast('Excel file imported successfully!', 'success');
        } catch (error) {
          console.error('Error reading Excel file:', error);
          showToast('Error reading Excel file. Please check the format.', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processExcelDataForCategory(data, category) {
      let importedCount = 0;
      let updatedCount = 0;
      
      console.log(`Processing Excel data for category: ${category}`);
      console.log(`Total rows in Excel: ${data.length}`);
      
      // Skip header rows (first 2 rows)
      for (let i = 2; i < data.length; i++) {
        const row = data[i];
        console.log(`Processing row ${i}:`, row);
        
        if (row && row.length >= 3) {
          const partNumber = row[0]; // Column A - Part number
          const additionalName = row[2]; // Column C - Additional name
          
          console.log(`Row ${i} - Part Number: "${partNumber}", Additional Name: "${additionalName}"`);
          
          if (partNumber && additionalName) {
            // Extract information from the description
            const description = additionalName.toString();
            
            // Extract AWG rating from description - improved pattern matching
            let rating = 1; // Default rating
            let awg = null;
            
            // Multiple patterns to find AWG
            const awgPatterns = [
              /(\d+)AWG/i,
              /(\d+)\s*AWG/i,
              /AWG\s*(\d+)/i,
              /(\d+)\s*G/i
            ];
            
            console.log(`Processing description: "${description}"`);
            // Test the first pattern specifically
            const testMatch = description.match(/(\d+)AWG/i);
            console.log(`Test match for 10AWG pattern:`, testMatch);
            
            for (const pattern of awgPatterns) {
              const match = description.match(pattern);
              if (match) {
                awg = parseInt(match[1]);
                console.log(`AWG pattern "${pattern}" matched: ${awg}`);
                break;
              }
            }
            
            if (awg) {
              // Use comprehensive AWG to rating conversion
              rating = getRatingFromAWG(awg);
              console.log(`Processing cable: ${partNumber} - AWG: ${awg}, Rating: ${rating}A`);
            } else {
              console.log(`No AWG found in description: "${description}"`);
              console.log(`Tried patterns:`, awgPatterns.map(p => p.toString()));
              
              // If no AWG found, try to extract mm² size and convert to rating
              const mm2Patterns = [
                /(\d+)X(\d+\.\d+)/i,  // e.g., 2X0.14, 3X0.25
                /(\d+)x(\d+\.\d+)/i,  // e.g., 2x0.14, 3x0.25
                /(\d+)\s*X\s*(\d+\.\d+)/i,  // e.g., 2 X 0.14
                /(\d+)\s*x\s*(\d+\.\d+)/i,  // e.g., 2 x 0.14
              ];
              
              let mm2Size = null;
              for (const pattern of mm2Patterns) {
                const match = description.match(pattern);
                if (match) {
                  mm2Size = parseFloat(match[2]);
                  console.log(`MM² pattern "${pattern}" matched: ${mm2Size} mm²`);
                  break;
                }
              }
              
              if (mm2Size) {
                // Convert mm² to rating using the ampacity table
                const mm2Entry = ampacityTable.find(entry => entry.mm2 === mm2Size);
                if (mm2Entry) {
                  rating = mm2Entry.amps;
                  console.log(`MM² ${mm2Size} found in ampacity table: ${rating}A`);
                } else {
                  // Fallback rating based on mm² size
                  if (mm2Size <= 0.25) rating = 2;
                  else if (mm2Size <= 0.34) rating = 3;
                  else if (mm2Size <= 0.5) rating = 5;
                  else if (mm2Size <= 0.75) rating = 6;
                  else if (mm2Size <= 1.0) rating = 8;
                  else if (mm2Size <= 1.5) rating = 11;
                  else if (mm2Size <= 2.5) rating = 17;
                  else if (mm2Size <= 4.0) rating = 24;
                  else if (mm2Size <= 6.0) rating = 32;
                  else if (mm2Size <= 10.0) rating = 45;
                  else if (mm2Size <= 16.0) rating = 60;
                  else rating = 1; // Default fallback
                  
                  console.log(`MM² ${mm2Size} using fallback calculation: ${rating}A`);
                }
              } else {
                console.log(`No MM² size found in description: "${description}"`);
              }
            }
            
            // Extract number of cores from description - improved pattern matching
            let cores = 1; // Default
            const corePatterns = [
              /(\d+)X\d+/i,  // e.g., 2X0.5, 3X1.0
              /(\d+)\s*CORE/i,  // e.g., 2 CORE, 3 CORE
              /(\d+)\s*CONDUCTOR/i,  // e.g., 2 CONDUCTOR
              /(\d+)\s*WIRE/i,  // e.g., 2 WIRE
              /(\d+)\s*C/i,  // e.g., 2C, 3C
              /(\d+)CORE/i,  // e.g., 2CORE, 3CORE
              /(\d+)CONDUCTOR/i,  // e.g., 2CONDUCTOR
              /(\d+)WIRE/i,  // e.g., 2WIRE
              /(\d+)C/i,  // e.g., 2C, 3C
              /(\d+)X/i,  // e.g., 2X, 3X
              /(\d+)\s*X/i,  // e.g., 2 X, 3 X
            ];
            
            for (const pattern of corePatterns) {
              const match = description.match(pattern);
              if (match) {
                cores = parseInt(match[1]);
                console.log(`Core pattern "${pattern}" matched: ${cores} cores`);
                break;
              }
            }
            
            // Additional logic for specific cable types
            if (description.toLowerCase().includes('single') || description.toLowerCase().includes('1x')) {
              cores = 1;
              console.log(`Single core detected: ${cores} cores`);
            } else if (description.toLowerCase().includes('multi') || description.toLowerCase().includes('2x')) {
              cores = Math.max(cores, 2);
              console.log(`Multi core detected: ${cores} cores`);
            } else if (description.toLowerCase().includes('3x')) {
              cores = Math.max(cores, 3);
            } else if (description.toLowerCase().includes('4x')) {
              cores = Math.max(cores, 4);
            } else if (description.toLowerCase().includes('5x')) {
              cores = Math.max(cores, 5);
            } else if (description.toLowerCase().includes('6x')) {
              cores = Math.max(cores, 6);
            } else if (description.toLowerCase().includes('7x')) {
              cores = Math.max(cores, 7);
            } else if (description.toLowerCase().includes('8x')) {
              cores = Math.max(cores, 8);
            }
            
            console.log(`Final values - Part Number: "${partNumber}", Cores: ${cores}, Rating: ${rating}`);
            
            // Create cable object based on category
            let cableData;
            
            if (category === 'EtherNET' || category === 'EtherCAT') {
              // Extract length and colour from description for EtherNET/EtherCAT
              const lengthMatch = description.match(/(\d+M)/i);
              const colourMatch = description.match(/(GREY|BLACK|BLUE|WHITE|RED|GREEN|YELLOW|ORANGE|PURPLE|PINK|BROWN)/i);
              
              const length = lengthMatch ? lengthMatch[1] : '';
              const colour = colourMatch ? colourMatch[1] : '';
              
              console.log(`${category} extraction - Length: "${length}", Colour: "${colour}"`);
              
              cableData = {
                oemPart: partNumber.toString(),
                description: description,
                length: length,
                colour: colour
              };
            } else {
              cableData = {
                oemPart: partNumber.toString(),
                cableDesc: description,
                numCores: cores.toString(),
                cableRating: rating.toString()
              };
            }
            
            console.log(`Created cable object:`, cableData);
            
            // Check for duplicate part number
            let isDuplicate = false;
            let existingCable = null;
            let existingCategory = null;
            
            // Check in all categories for duplicates
            Object.keys(cableLibrary).forEach(cat => {
              const existing = cableLibrary[cat].find(cable => cable.oemPart === cableData.oemPart);
              if (existing) {
                isDuplicate = true;
                existingCable = existing;
                existingCategory = cat;
                console.log(`Duplicate found in category ${cat}:`, existing);
                return;
              }
            });
            
            if (isDuplicate) {
              // Cable already exists - increase rating
              const newRating = Math.max(parseInt(existingCable.cableRating), parseInt(cableData.cableRating));
              existingCable.cableRating = newRating.toString();
              console.log(`Updating existing cable with new rating: ${newRating}`);
              
              // Update in Firebase
              updateCableInFirebase(existingCable.id, existingCable);
              updatedCount++;
            } else {
              // Add new cable to local array
              if (cableLibrary[category]) {
                cableLibrary[category].push(cableData);
                console.log(`Adding new cable to category ${category}:`, cableData);
                
                // Save to Firebase
                saveCableToFirebase(category, cableData);
                importedCount++;
              }
            }
          } else {
            console.log(`Row ${i} skipped - missing part number or additional name`);
          }
        }
      }
      
      // Show summary toast
      if (importedCount > 0 || updatedCount > 0) {
        let message = '';
        if (importedCount > 0) message += `${importedCount} new cables imported. `;
        if (updatedCount > 0) message += `${updatedCount} existing cables updated.`;
        showToast(message, 'success');
      }
      
      // Refresh the display
      renderCableTables();
    }
    
    // Function to update cable in Firebase
    function updateCableInFirebase(docId, cableData) {
      let updateData = {
        oemPart: cableData.oemPart,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Check if this is EtherNET data by looking for description field
      if (cableData.description !== undefined) {
        updateData.description = cableData.description;
        updateData.length = cableData.length;
        updateData.colour = cableData.colour;
      } else {
        updateData.cableDesc = cableData.cableDesc;
        updateData.numCores = cableData.numCores;
        updateData.cableRating = cableData.cableRating;
      }
      
      // Add datasheet URL if it exists
      if (cableData.datasheetUrl !== undefined) {
        updateData.datasheetUrl = cableData.datasheetUrl;
      }
      
      return db.collection('cables').doc(docId).update(updateData).then(() => {
        console.log('Cable updated in Firebase');
        return true;
      }).catch((error) => {
        console.error('Error updating cable: ', error);
        return false;
      });
    }
    
    // Optimized toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // Use requestAnimationFrame for better performance
      requestAnimationFrame(() => toast.classList.add('show'));
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, CONSTANTS.TOAST_DURATION);
    }
    
    // Library Navigation Functionality
    document.addEventListener('DOMContentLoaded', function() {
      const libraryBtns = document.querySelectorAll('.library-btn');
      const backBtn = document.getElementById('backToSelection');
      const librarySelection = document.getElementById('librarySelection');
      const librarySections = document.querySelectorAll('.library-section');
      const loginBtn = document.getElementById('loginBtn');
      const loginSection = document.getElementById('loginSection');
      const libraryButtons = document.getElementById('libraryButtons');
      const logoutBtn = document.getElementById('logoutBtn');
      
      // Show login section initially
      loginSection.style.display = 'block';
      libraryButtons.style.display = 'none';
              logoutBtn.style.display = 'none'; // Hide logout button initially
        document.getElementById('exportDataBtn').style.display = 'none'; // Hide export button initially

      // Login button click handler
      loginBtn.addEventListener('click', function() {
        // Show login modal
        document.getElementById('loginModal').classList.add('show');
        // Hide library selection
        librarySelection.style.display = 'none';
        // Hide back button
        backBtn.style.display = 'none';
        // Hide all library sections
        librarySections.forEach(section => {
          section.classList.remove('active');
        });
        logoutBtn.style.display = 'none'; // Hide logout button when logging in
        document.getElementById('exportDataBtn').style.display = 'none'; // Hide export button when logging in
      });

      // Library button click handlers
      libraryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const selectedLibrary = this.getAttribute('data-library');
          
          // Check if user is logged in using local authentication
          if (isAuthenticated) {
                  // User is logged in, hide library selection
      librarySelection.style.display = 'none';
      backBtn.style.display = 'inline-block';
      // Hide login section
      loginSection.style.display = 'none';
      // Hide library buttons
      libraryButtons.style.display = 'flex';
      // Show export button
      document.getElementById('exportDataBtn').style.display = 'inline-block';

            // Hide all library sections
            librarySections.forEach(section => {
              section.classList.remove('active');
            });

            // Show selected library section
            const targetSection = document.querySelector(`.${selectedLibrary}-library`);
            if (targetSection) {
              targetSection.classList.add('active');
              // Scroll to the library section
              targetSection.scrollIntoView({ behavior: 'smooth' });
              // Setup category filters for the shown section
              if (selectedLibrary === 'cable') setupCableCategoryFilters();
              if (selectedLibrary === 'circuit-breaker') setupCBCategoryFilters();
              if (selectedLibrary === 'switch') setupSwitchCategoryFilters();
            }
          } else {
            // User is not logged in, show login modal
            document.getElementById('loginModal').classList.add('show');
            // Hide library selection
            librarySelection.style.display = 'none';
            // Hide back button
            backBtn.style.display = 'none';
            // Hide all library sections
            librarySections.forEach(section => {
              section.classList.remove('active');
            });
          }
        });
      });
      
      // Back button click handler
      backBtn.addEventListener('click', function() {
        // If user is authenticated, show library selection with buttons
        if (isAuthenticated) {
          // Show library selection
          librarySelection.style.display = 'block';
          
          // Hide back button
          backBtn.style.display = 'none';
          
          // Hide all library sections
          librarySections.forEach(section => {
            section.classList.remove('active');
          });
          
          // Hide login section
          loginSection.style.display = 'none';
          // Show library buttons
          libraryButtons.style.display = 'flex';
          // Show logout button
          logoutBtn.style.display = 'inline-block';
        } else {
          // If not authenticated, show login section
          librarySelection.style.display = 'block';
          backBtn.style.display = 'none';
          librarySections.forEach(section => {
            section.classList.remove('active');
          });
          loginSection.style.display = 'block';
          libraryButtons.style.display = 'none';
          logoutBtn.style.display = 'none';
        }

        // Scroll to library selection
        librarySelection.scrollIntoView({ behavior: 'smooth' });
      });
      
      // Back to Main Page button handlers
      const backToMainBtns = document.querySelectorAll('.back-to-main-btn');
      backToMainBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          // If user is authenticated, show library selection with buttons
          if (isAuthenticated) {
            // Show library selection
            librarySelection.style.display = 'block';
            
            // Hide back button
            backBtn.style.display = 'none';
            
            // Hide all library sections
            librarySections.forEach(section => {
              section.classList.remove('active');
            });
            
            // Hide login section
            loginSection.style.display = 'none';
            // Show library buttons
            libraryButtons.style.display = 'flex';
            // Show logout button
            logoutBtn.style.display = 'inline-block';
          } else {
            // If not authenticated, show login section
            librarySelection.style.display = 'block';
            backBtn.style.display = 'none';
            librarySections.forEach(section => {
              section.classList.remove('active');
            });
            loginSection.style.display = 'block';
            libraryButtons.style.display = 'none';
            logoutBtn.style.display = 'none';
          }

          // Scroll to top of page (main calculator)
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });
    });
  </script>

     <div class="circuit-breaker-library library-section" style="margin: 40px auto 0 auto; max-width: 1200px; width: 100%; background: var(--background-color); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); padding: 28px 18px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
      <h2 style="color: var(--primary-color); margin: 0;">Circuit Breaker Library</h2>
      <button class="back-to-main-btn btn-secondary">← Back to Main Page</button>
    </div>
    <form id="cbForm" style="display: flex; flex-wrap: nowrap; gap: 18px; align-items: flex-end; justify-content: center; margin-bottom: 0;">
      <div style="min-width: 120px;">
        <label for="cbCategory">Category:</label><br>
        <select id="cbCategory" required style="width: 120px;">
          <option value="Main CB">Main CB</option>
          <option value="RCCB">RCCB</option>
          <option value="CB">CB</option>
          <option value="DCB">DCB</option>
        </select>
      </div>
      <div style="min-width: 120px;">
        <label for="cbOEMPart">OEM Part Number:</label><br>
        <input type="text" id="cbOEMPart" required style="width: 120px;" />
      </div>
      <div style="min-width: 350px;">
        <label for="cbDesc">Description:</label><br>
        <input type="text" id="cbDesc" required style="width: 350px;" />
      </div>
      <div style="min-width: 40px;">
        <label for="cbPoles">Poles:</label><br>
        <input type="number" id="cbPoles" min="1" max="4" required style="width: 40px;" />
      </div>
      <div style="min-width: 40px;">
        <label for="cbRating">Rating (A):</label><br>
        <input type="number" id="cbRating" min="1" required style="width: 40px;" />
      </div>
      <div>
        <button type="submit" class="btn-primary">Add CB</button>
      </div>
    </form>
    <div id="cbTables" style="margin-top: 30px;"></div>
    <div style="margin-top: 18px; display: flex; justify-content: center;">
      <input type="text" id="searchCBOEM" placeholder="Search by OEM Part No or Rating" style="padding: 7px 12px; border-radius: 6px; border: 1px solid #bbb; width: 300px; font-size: 1rem; text-align: center;" />
    </div>
    <div style="margin-top: 12px; display: flex; justify-content: center; align-items: center; gap: 12px;">
      <label for="cbCategoryDropdown" style="color:var(--primary-color); font-weight:bold;">Category:</label>
      <select id="cbCategoryDropdown" style="padding: 6px 12px; border-radius: 4px; font-size: 1rem;">
        <option value="all">All Categories</option>
        <option value="Main CB">Main CB</option>
        <option value="RCCB">RCCB</option>
        <option value="CB">CB</option>
        <option value="DCB">DCB</option>
      </select>
    </div>
  </div>
  <script>
    // --- Circuit Breaker Library Section ---
    const cbForm = document.getElementById('cbForm');
    const cbTablesDiv = document.getElementById('cbTables');
    const searchCBOEM = document.getElementById('searchCBOEM');
    let cbLibrary = {
      'Main CB': [],
      'RCCB': [],
      'CB': [],
      'DCB': []
    };

    cbForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const cbCategory = document.getElementById('cbCategory').value;
      const cbOEMPart = document.getElementById('cbOEMPart').value.trim();
      const cbDesc = document.getElementById('cbDesc').value.trim();
      const cbPoles = document.getElementById('cbPoles').value.trim();
      const cbRating = document.getElementById('cbRating').value.trim();
      if (!cbCategory || !cbOEMPart || !cbDesc || !cbPoles || !cbRating) return;
      
      // Add to local array
      cbLibrary[cbCategory].push({ cbOEMPart, cbDesc, cbPoles, cbRating });
      
      // Save to Firebase
      saveCBToFirebase(cbCategory, { cbOEMPart, cbDesc, cbPoles, cbRating }).then(() => {
        showToast('Circuit Breaker added successfully!', 'success');
        cbForm.reset();
        renderCBTables();
      }).catch(() => {
        showToast('Error adding circuit breaker. Please try again.', 'error');
      });
    });

    // Firebase functions for Circuit Breaker Library
    function saveCBToFirebase(category, cbData) {
      const submitBtn = cbForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.innerHTML = '<span class="spinner"></span> Saving...';
      submitBtn.disabled = true;
      
      return db.collection('circuitBreakers').add({
        category: category,
        cbOEMPart: cbData.cbOEMPart,
        cbDesc: cbData.cbDesc,
        cbPoles: cbData.cbPoles,
        cbRating: cbData.cbRating,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        console.log('Circuit Breaker saved to Firebase');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return true;
      }).catch((error) => {
        console.error('Error saving circuit breaker: ', error);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return false;
      });
    }

    function loadCBsFromFirebase() {
      db.collection('circuitBreakers').get().then((querySnapshot) => {
        cbLibrary = {
          'Main CB': [],
          'RCCB': [],
          'CB': [],
          'DCB': []
        };
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (cbLibrary[data.category]) {
            cbLibrary[data.category].push({
              id: doc.id,
              cbOEMPart: data.cbOEMPart,
              cbDesc: data.cbDesc,
              cbPoles: data.cbPoles,
              cbRating: data.cbRating,
              datasheetUrl: data.datasheetUrl || null
            });
          }
        });
        renderCBTables();
      }).catch((error) => {
        console.error('Error loading circuit breakers: ', error);
      });
    }

    function deleteCBFromFirebase(docId) {
      return db.collection('circuitBreakers').doc(docId).delete().then(() => {
        console.log('Circuit Breaker deleted from Firebase');
        return true;
      }).catch((error) => {
        console.error('Error deleting circuit breaker: ', error);
        return false;
      });
    }

    // Function to update circuit breaker in Firebase
    function updateCBInFirebase(docId, cbData) {
      let updateData = {
        cbOEMPart: cbData.cbOEMPart,
        cbDesc: cbData.cbDesc,
        cbPoles: cbData.cbPoles,
        cbRating: cbData.cbRating,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Add datasheet URL if it exists
      if (cbData.datasheetUrl !== undefined) {
        updateData.datasheetUrl = cbData.datasheetUrl;
      }
      
      return db.collection('circuitBreakers').doc(docId).update(updateData).then(() => {
        console.log('Circuit Breaker updated in Firebase');
        return true;
      }).catch((error) => {
        console.error('Error updating circuit breaker: ', error);
        return false;
      });
    }

    // Load circuit breakers on page load
    loadCBsFromFirebase();

    searchCBOEM.addEventListener('input', renderCBTables);

    function renderCBTables() {
      let html = '';
      const searchVal = searchCBOEM.value.trim().toLowerCase();
      const activeCategoryFilter = document.getElementById('cbCategoryDropdown')?.value || 'all';
      let found = false;
      
      Object.keys(cbLibrary).forEach(cat => {
        if (activeCategoryFilter !== 'all' && cat !== activeCategoryFilter) return;
        
        const filteredCBs = searchVal
          ? cbLibrary[cat].filter(cb => 
              cb.cbOEMPart.toLowerCase().includes(searchVal) || 
              cb.cbRating.toString().includes(searchVal)
            )
          : cbLibrary[cat];
        
        // Sort circuit breakers by rating in ascending order
        filteredCBs.sort((a, b) => parseInt(a.cbRating) - parseInt(b.cbRating));
        
        if (filteredCBs.length === 0) return;
        found = true;
        html += `<h3 style='color:#ffb347; margin-bottom:6px;'>${cat}</h3>`;
        html += `<table style='margin-bottom:18px;'><thead><tr><th style='text-align:center;'>OEM Part Number</th><th>Description</th><th style='text-align:center;'>Poles</th><th style='text-align:center;'>Rating (A)</th><th style='text-align:center;'>Action</th></tr></thead><tbody>`;
        filteredCBs.forEach((cb, idx) => {
          const datasheetBgColor = cb.datasheetUrl ? '#007bff' : '#ff7675';
          html += `<tr><td style='text-align:center;'>${cb.cbOEMPart}</td><td>${cb.cbDesc}</td><td style='text-align:center;'>${cb.cbPoles}</td><td style='text-align:center;'>${cb.cbRating}</td><td style='text-align:center;'><button class='datasheet-cb-btn' data-cat='${cat}' data-idx='${cbLibrary[cat].indexOf(cb)}' style='padding:4px 8px;background:${datasheetBgColor};color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>📄 Datasheet</button><br><button class='edit-cb-btn' data-cat='${cat}' data-idx='${cbLibrary[cat].indexOf(cb)}' style='padding:4px 8px;background:#4CAF50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>✏️ Edit</button></td></tr>`;
        });
        html += '</tbody></table>';
      });
      cbTablesDiv.innerHTML = found ? html : '<div style="color:#bbb;">No circuit breakers found.</div>';
    }

    // Datasheet CB event (event delegation)
    cbTablesDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('datasheet-cb-btn')) {
        const cbCat = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const cb = cbLibrary[cbCat][idx];
        
        // Show datasheet modal
        showDatasheetModal(cb, 'cb', cbCat, idx);
      }
    });



    renderCBTables();
  </script>

     <div class="switch-library library-section" style="margin: 40px auto 0 auto; max-width: 1200px; width: 100%; background: var(--background-color); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); padding: 28px 18px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
      <h2 style="color: var(--primary-color); margin: 0;">Switch Library</h2>
      <button class="back-to-main-btn btn-secondary">← Back to Main Page</button>
    </div>
    <form id="switchForm" style="display: flex; flex-wrap: nowrap; gap: 18px; align-items: flex-end; justify-content: center; margin-bottom: 0;">
      <div style="min-width: 120px;">
        <label for="switchCategory">Category:</label><br>
        <select id="switchCategory" required style="width: 120px;">
          <option value="Relay">Relay</option>
          <option value="Contactor">Contactor</option>
        </select>
      </div>
      <div style="min-width: 120px;">
        <label for="switchOEMPart">OEM Part Number:</label><br>
        <input type="text" id="switchOEMPart" required style="width: 120px;" />
      </div>
      <div style="min-width: 350px;">
        <label for="switchDesc">Description:</label><br>
        <input type="text" id="switchDesc" required style="width: 350px;" />
      </div>
      <div style="min-width: 40px;">
        <label for="switchPoles">Poles:</label><br>
        <input type="number" id="switchPoles" min="1" max="4" required style="width: 40px;" />
      </div>
      <div style="min-width: 40px;">
        <label for="switchRating">Rating (A):</label><br>
        <input type="number" id="switchRating" min="1" required style="width: 40px;" />
      </div>
      <div>
        <button type="submit" class="btn-primary">Add Switch</button>
      </div>
    </form>
    <div id="switchTables" style="margin-top: 30px;"></div>
    <div style="margin-top: 18px; display: flex; justify-content: center;">
      <input type="text" id="searchSwitchOEM" placeholder="Search by OEM Part No or Rating" style="padding: 7px 12px; border-radius: 6px; border: 1px solid #bbb; width: 300px; font-size: 1rem; text-align: center;" />
    </div>
    <div style="margin-top: 12px; display: flex; justify-content: center; align-items: center; gap: 12px;">
      <label for="switchCategoryDropdown" style="color:var(--primary-color); font-weight:bold;">Category:</label>
      <select id="switchCategoryDropdown" style="padding: 6px 12px; border-radius: 4px; font-size: 1rem;">
        <option value="all">All Categories</option>
        <option value="Relay">Relay</option>
        <option value="Contactor">Contactor</option>
      </select>
    </div>
  </div>
  <script>
    // --- Switch Library Section ---
    const switchForm = document.getElementById('switchForm');
    const switchTablesDiv = document.getElementById('switchTables');
    const searchSwitchOEM = document.getElementById('searchSwitchOEM');
    let switchLibrary = {
      'Relay': [],
      'Contactor': []
    };

    switchForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const switchCategory = document.getElementById('switchCategory').value;
      const switchOEMPart = document.getElementById('switchOEMPart').value.trim();
      const switchDesc = document.getElementById('switchDesc').value.trim();
      const switchPoles = document.getElementById('switchPoles').value.trim();
      const switchRating = document.getElementById('switchRating').value.trim();
      if (!switchCategory || !switchOEMPart || !switchDesc || !switchPoles || !switchRating) return;
      
      // Add to local array
      switchLibrary[switchCategory].push({ switchOEMPart, switchDesc, switchPoles, switchRating });
      
      // Save to Firebase
      saveSwitchToFirebase(switchCategory, { switchOEMPart, switchDesc, switchPoles, switchRating }).then(() => {
        showToast('Switch added successfully!', 'success');
        switchForm.reset();
        renderSwitchTables();
      }).catch(() => {
        showToast('Error adding switch. Please try again.', 'error');
      });
    });

    // Firebase functions for Switch Library
    function saveSwitchToFirebase(category, switchData) {
      const submitBtn = switchForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.innerHTML = '<span class="spinner"></span> Saving...';
      submitBtn.disabled = true;
      
      return db.collection('switches').add({
        category: category,
        switchOEMPart: switchData.switchOEMPart,
        switchDesc: switchData.switchDesc,
        switchPoles: switchData.switchPoles,
        switchRating: switchData.switchRating,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        console.log('Switch saved to Firebase');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return true;
      }).catch((error) => {
        console.error('Error saving switch: ', error);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return false;
      });
    }

    function loadSwitchesFromFirebase() {
      db.collection('switches').get().then((querySnapshot) => {
        switchLibrary = {
          'Relay': [],
          'Contactor': []
        };
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (switchLibrary[data.category]) {
            switchLibrary[data.category].push({
              id: doc.id,
              switchOEMPart: data.switchOEMPart,
              switchDesc: data.switchDesc,
              switchPoles: data.switchPoles,
              switchRating: data.switchRating,
              datasheetUrl: data.datasheetUrl || null
            });
          }
        });
        renderSwitchTables();
      }).catch((error) => {
        console.error('Error loading switches: ', error);
      });
    }

    function deleteSwitchFromFirebase(docId) {
      return db.collection('switches').doc(docId).delete().then(() => {
        console.log('Switch deleted from Firebase');
        return true;
      }).catch((error) => {
        console.error('Error deleting switch: ', error);
        return false;
      });
    }

    // Function to update switch in Firebase
    function updateSwitchInFirebase(docId, switchData) {
      let updateData = {
        switchOEMPart: switchData.switchOEMPart,
        switchDesc: switchData.switchDesc,
        switchPoles: switchData.switchPoles,
        switchRating: switchData.switchRating,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Add datasheet URL if it exists
      if (switchData.datasheetUrl !== undefined) {
        updateData.datasheetUrl = switchData.datasheetUrl;
      }
      
      return db.collection('switches').doc(docId).update(updateData).then(() => {
        console.log('Switch updated in Firebase');
        return true;
      }).catch((error) => {
        console.error('Error updating switch: ', error);
        return false;
      });
    }

    // Comprehensive AWG to rating conversion function
    function getRatingFromAWG(awg) {
      console.log(`getRatingFromAWG called with awg: ${awg}, type: ${typeof awg}`);
      
      // Comprehensive AWG to current rating mapping
      const awgRatingMap = {
        26: 0.75,
        24: 2,
        22: 3,
        20: 5,
        18: 6,
        16: 8,
        14: 11,
        12: 17,
        10: 24,
        8: 32,
        6: 45,
        4: 60,
        2: 95,
        1: 110,
        0: 125,
        '1/0': 150,
        '2/0': 175,
        '3/0': 200,
        '4/0': 225
      };
      
      // Try to find exact match first
      if (awgRatingMap[awg] !== undefined) {
        console.log(`AWG ${awg} found in rating map: ${awgRatingMap[awg]}A`);
        return awgRatingMap[awg];
      }
      console.log(`AWG ${awg} not found in rating map, checking ampacity table...`);
      
      // If not found, use ampacity table
      const awgEntry = ampacityTable.find(entry => entry.awg === awg.toString());
      if (awgEntry) {
        console.log(`AWG ${awg} found in ampacity table: ${awgEntry.amps}A`);
        return awgEntry.amps;
      }
      console.log(`AWG ${awg} not found in ampacity table, using fallback calculation...`);
      
      // Fallback calculation based on AWG size
      let rating = 1;
      if (awg <= 22) rating = 3;
      else if (awg <= 20) rating = 5;
      else if (awg <= 18) rating = 6;
      else if (awg <= 16) rating = 8;
      else if (awg <= 14) rating = 11;
      else if (awg <= 12) rating = 17;
      else if (awg <= 10) rating = 24;
      else if (awg <= 8) rating = 32;
      else if (awg <= 6) rating = 45;
      else if (awg <= 4) rating = 60;
      
      console.log(`AWG ${awg} using fallback calculation: ${rating}A`);
      return rating;
    }
     
    // Load switches on page load
    loadSwitchesFromFirebase();

    searchSwitchOEM.addEventListener('input', renderSwitchTables);

    function renderSwitchTables() {
      let html = '';
      const searchVal = searchSwitchOEM.value.trim().toLowerCase();
      const activeCategoryFilter = document.getElementById('switchCategoryDropdown')?.value || 'all';
      let found = false;
      
      Object.keys(switchLibrary).forEach(cat => {
        if (activeCategoryFilter !== 'all' && cat !== activeCategoryFilter) return;
        
        const filteredSwitches = searchVal
          ? switchLibrary[cat].filter(sw => 
              sw.switchOEMPart.toLowerCase().includes(searchVal) || 
              sw.switchRating.toString().includes(searchVal)
            )
          : switchLibrary[cat];
        
        // Sort switches by rating in ascending order
        filteredSwitches.sort((a, b) => parseInt(a.switchRating) - parseInt(b.switchRating));
        
        if (filteredSwitches.length === 0) return;
        found = true;
        html += `<h3 style='color:#ffb347; margin-bottom:6px;'>${cat}</h3>`;
        html += `<table style='margin-bottom:18px;'><thead><tr><th style='text-align:center;'>OEM Part Number</th><th>Description</th><th style='text-align:center;'>Poles</th><th style='text-align:center;'>Rating (A)</th><th style='text-align:center;'>Action</th></tr></thead><tbody>`;
        filteredSwitches.forEach((sw, idx) => {
          const datasheetBgColor = sw.datasheetUrl ? '#007bff' : '#ff7675';
          html += `<tr><td style='text-align:center;'>${sw.switchOEMPart}</td><td>${sw.switchDesc}</td><td style='text-align:center;'>${sw.switchPoles}</td><td style='text-align:center;'>${sw.switchRating}</td><td style='text-align:center;'><button class='datasheet-switch-btn' data-cat='${cat}' data-idx='${switchLibrary[cat].indexOf(sw)}' style='padding:4px 8px;background:${datasheetBgColor};color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>📄 Datasheet</button><br><button class='edit-switch-btn' data-cat='${cat}' data-idx='${switchLibrary[cat].indexOf(sw)}' style='padding:4px 8px;background:#4CAF50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>✏️ Edit</button></td></tr>`;
        });
        html += '</tbody></table>';
      });
      switchTablesDiv.innerHTML = found ? html : '<div style="color:#bbb;">No switches found.</div>';
    }

    // Datasheet Switch event (event delegation)
    switchTablesDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('datasheet-switch-btn')) {
        const switchCat = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const sw = switchLibrary[switchCat][idx];
        
        // Show datasheet modal
        showDatasheetModal(sw, 'switch', switchCat, idx);
      }
    });



    renderSwitchTables();
  </script>

  <script>
    // Function to show minimum components from libraries
    function showMinimumComponents(currentRating) {
      let componentsHtml = '<div style="margin-top: 40px; max-width: 800px; margin-left: auto; margin-right: auto;">';
      componentsHtml += '<h2 style="color: #61dafb; text-align: center; margin-bottom: 20px;">Minimum Components for ' + currentRating + 'A</h2>';
      componentsHtml += `<div id="minCompCategoryFilters" style="display: flex; justify-content: center; gap: 12px; margin-bottom: 18px;">
        <button class="min-comp-filter-btn active" data-filter="all">All</button>
        <button class="min-comp-filter-btn" data-filter="cables">Cables</button>
        <button class="min-comp-filter-btn" data-filter="cbs">Circuit Breakers</button>
        <button class="min-comp-filter-btn" data-filter="switches">Switches</button>
      </div>`;
      
      // Cable Library components
      let suitableCables = [];
      const minCompCableCategoryDropdown = document.getElementById('minCompCableCategoryDropdown');
      const selectedCableCat = minCompCableCategoryDropdown ? minCompCableCategoryDropdown.value : 'all';
      Object.keys(cableLibrary).forEach(cat => {
        if (cat === 'EtherNET') return; // Skip EtherNET if you want
        if (selectedCableCat !== 'all' && cat !== selectedCableCat) return;
        cableLibrary[cat].forEach(cable => {
          if (parseInt(cable.cableRating) >= currentRating) {
            suitableCables.push({...cable, category: cat});
          }
        });
      });
      
      if (suitableCables.length > 0) {
        componentsHtml += `<div style='display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 8px;'>
          <label for='minCompCableCategoryDropdown' style='color:#61dafb; font-weight:bold;'>Cable Category:</label>
          <select id='minCompCableCategoryDropdown' style='padding: 6px 12px; border-radius: 4px; font-size: 1rem;'>
            <option value='all'>All Categories</option>
            <option value='Single Core'>Single Core</option>
            <option value='Multi Core'>Multi Core</option>
            <option value='Robotic Cable'>Robotic Cable</option>
            <option value='Flexible Cable'>Flexible Cable</option>
            <option value='EtherNET'>EtherNET</option>
            <option value='EtherCAT'>EtherCAT</option>
          </select>
        </div>`;
        componentsHtml += '<div class="min-comp-table" data-filter="cables" style="background: #23262c; border-radius: 12px; padding: 20px; margin-bottom: 20px;">';
        componentsHtml += '<h3 style="color: #ffb347; margin-bottom: 10px;">Suitable Cables</h3>';
        componentsHtml += '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Category</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">OEM Part Number</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Description</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">No. of Cores</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Rating (A)</th></tr></thead><tbody>';
        suitableCables.forEach(cable => {
          componentsHtml += `<tr style="background: #2e323a;"><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cable.category}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cable.oemPart}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cable.cableDesc}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cable.numCores}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cable.cableRating}</td></tr>`;
        });
        componentsHtml += '</tbody></table></div>';
      }
      
      // Circuit Breaker Library components
      let suitableCBs = [];
      Object.keys(cbLibrary).forEach(cat => {
        cbLibrary[cat].forEach(cb => {
          if (parseInt(cb.cbRating) >= currentRating) {
            suitableCBs.push({...cb, category: cat});
          }
        });
      });
      
      if (suitableCBs.length > 0) {
        componentsHtml += '<div class="min-comp-table" data-filter="cbs" style="background: #23262c; border-radius: 12px; padding: 20px; margin-bottom: 20px;">';
        componentsHtml += '<h3 style="color: #ffb347; margin-bottom: 10px;">Suitable Circuit Breakers</h3>';
        componentsHtml += '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Category</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">OEM Part Number</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Description</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Poles</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Rating (A)</th></tr></thead><tbody>';
        suitableCBs.forEach(cb => {
          componentsHtml += `<tr style="background: #2e323a;"><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cb.category}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cb.cbOEMPart}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cb.cbDesc}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cb.cbPoles}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cb.cbRating}</td></tr>`;
        });
        componentsHtml += '</tbody></table></div>';
      }
      
      // Switch Library components
      let suitableSwitches = [];
      Object.keys(switchLibrary).forEach(cat => {
        switchLibrary[cat].forEach(sw => {
          if (parseInt(sw.switchRating) >= currentRating) {
            suitableSwitches.push({...sw, category: cat});
          }
        });
      });
      
      if (suitableSwitches.length > 0) {
        componentsHtml += '<div class="min-comp-table" data-filter="switches" style="background: #23262c; border-radius: 12px; padding: 20px; margin-bottom: 20px;">';
        componentsHtml += '<h3 style="color: #ffb347; margin-bottom: 10px;">Suitable Switches</h3>';
        componentsHtml += '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Category</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">OEM Part Number</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Description</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Poles</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Rating (A)</th></tr></thead><tbody>';
        suitableSwitches.forEach(sw => {
          componentsHtml += `<tr style="background: #2e323a;"><td style="border: 1px solid #444; padding: 8px; color: #fff;">${sw.category}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${sw.switchOEMPart}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${sw.switchDesc}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${sw.switchPoles}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${sw.switchRating}</td></tr>`;
        });
        componentsHtml += '</tbody></table></div>';
      }
      
      if (suitableCables.length === 0 && suitableCBs.length === 0 && suitableSwitches.length === 0) {
        componentsHtml += '<div style="background: #23262c; border-radius: 12px; padding: 20px; text-align: center; color: #bbb;">No suitable components found in libraries for ' + currentRating + 'A. Add components with higher ratings to your libraries.</div>';
      }
      
      componentsHtml += '</div>';
      
      // Add the components section after the results
      const existingComponents = document.getElementById('minimumComponents');
      if (existingComponents) {
        existingComponents.remove();
      }
      
      const componentsDiv = document.createElement('div');
      componentsDiv.id = 'minimumComponents';
      componentsDiv.innerHTML = componentsHtml;
      resultsDiv.parentNode.insertBefore(componentsDiv, resultsDiv.nextSibling);
      // Attach filter button event listeners immediately after rendering
      Array.from(componentsDiv.querySelectorAll('.min-comp-filter-btn')).forEach(btn => {
        btn.addEventListener('click', function() {
          componentsDiv.querySelectorAll('.min-comp-filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          const filter = this.getAttribute('data-filter');
          componentsDiv.querySelectorAll('.min-comp-table').forEach(table => {
            if (filter === 'all' || table.getAttribute('data-filter') === filter) {
              table.style.display = '';
            } else {
              table.style.display = 'none';
            }
          });
        });
      });
      
      // After rendering Minimum Components, re-attach the event listener to the dropdown
      const minCompCableCategoryDropdownLocal = document.getElementById('minCompCableCategoryDropdown');
      if (minCompCableCategoryDropdownLocal) {
        minCompCableCategoryDropdownLocal.value = selectedCableCat;
        minCompCableCategoryDropdownLocal.addEventListener('change', function() {
          showMinimumComponents(currentRating);
        });
      }
    }
  </script>
  <script>
    // Optimized Authentication Logic
    let isAuthenticated = false;
    
    // Performance monitoring
    const performanceMetrics = {
      startTime: performance.now(),
      operations: {},
      
      start(operation) {
        this.operations[operation] = performance.now();
      },
      
      end(operation) {
        if (this.operations[operation]) {
          const duration = performance.now() - this.operations[operation];
          console.log(`${operation} took ${duration.toFixed(2)}ms`);
          delete this.operations[operation];
          return duration;
        }
        return 0;
      },
      
      getTotalTime() {
        return performance.now() - this.startTime;
      }
    };
    
    // Optimized login form handler
    elements.loginForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      performanceMetrics.start('login');
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const loginError = document.getElementById('loginError');
      
      // Check credentials
      if (username === CONSTANTS.ADMIN_CREDENTIALS.username && password === CONSTANTS.ADMIN_CREDENTIALS.password) {
        isAuthenticated = true;
        
        // Hide login modal
        elements.loginModal.classList.remove('show');
        
        // Show library selection
        elements.librarySelection.style.display = 'block';
        
        // Show library buttons
        elements.libraryButtons.style.display = 'flex';
        elements.logoutBtn.style.display = 'inline-block';
        elements.exportDataBtn.style.display = 'inline-block';
        
        // Hide login section
        elements.loginSection.style.display = 'none';
        
        // Clear form
        elements.loginForm.reset();
        
        // Hide error message
        loginError.style.display = 'none';
        
        // Show success toast
        showToast('Login successful! Welcome to Library Management.', 'success');
        
        // Scroll to library selection
        elements.librarySelection.scrollIntoView({ behavior: 'smooth' });
        
        performanceMetrics.end('login');
      } else {
        // Show error message
        loginError.textContent = 'Invalid username or password. Please try again.';
        loginError.style.display = 'block';
        
        // Clear password field
        document.getElementById('password').value = '';
        
        performanceMetrics.end('login');
      }
    });
    
    // Close login modal when clicking outside
    document.getElementById('loginModal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
        // Show library selection again
        document.getElementById('librarySelection').style.display = 'block';
      }
    });
    
    // Handle Enter key in password field
    document.getElementById('password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('loginForm').dispatchEvent(new Event('submit'));
      }
    });
    
    // Logout button handler
    document.getElementById('logoutBtn').addEventListener('click', function() {
      // Reset authentication state
      isAuthenticated = false;
      
      // Show login section
      document.getElementById('loginSection').style.display = 'block';
      
      // Hide library buttons
      document.getElementById('libraryButtons').style.display = 'none';
      
      // Hide logout button
      document.getElementById('logoutBtn').style.display = 'none';
      
      // Hide export button
      document.getElementById('exportDataBtn').style.display = 'none';
      
      // Hide all library sections
      document.querySelectorAll('.library-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Hide back button
      document.getElementById('backToSelection').style.display = 'none';
      
      // Show success toast
      showToast('Logged out successfully!', 'info');
      
      // Scroll to library selection
      document.getElementById('librarySelection').scrollIntoView({ behavior: 'smooth' });
    });

    // Export data to Excel functionality
    document.getElementById('exportDataBtn').addEventListener('click', function() {
      // Create workbook with multiple sheets
      const wb = XLSX.utils.book_new();
      
      // Export Cable Library
      const cableData = [];
      Object.keys(cableLibrary).forEach(cat => {
        cableLibrary[cat].forEach(cable => {
          if (cat === 'EtherNET' || cat === 'EtherCAT') {
            cableData.push({
              'Category': cat,
              'OEM Part Number': cable.oemPart,
              'Description': cable.description,
              'Length': cable.length || '',
              'Colour': cable.colour || '',
              'Rating (A)': '',
              'No. of Cores': '',
              'Datasheet Available': cable.datasheetUrl ? 'Yes' : 'No'
            });
          } else {
            cableData.push({
              'Category': cat,
              'OEM Part Number': cable.oemPart,
              'Description': cable.cableDesc,
              'Length': '',
              'Colour': '',
              'Rating (A)': cable.cableRating,
              'No. of Cores': cable.numCores,
              'Datasheet Available': cable.datasheetUrl ? 'Yes' : 'No'
            });
          }
        });
      });
      
      const cableWS = XLSX.utils.json_to_sheet(cableData);
      XLSX.utils.book_append_sheet(wb, cableWS, 'Cable Library');
      
      // Export Circuit Breaker Library
      const cbData = [];
      Object.keys(cbLibrary).forEach(cat => {
        cbLibrary[cat].forEach(cb => {
          cbData.push({
            'Category': cat,
            'OEM Part Number': cb.cbOEMPart,
            'Description': cb.cbDesc,
            'Poles': cb.cbPoles,
            'Rating (A)': cb.cbRating,
            'Datasheet Available': cb.datasheetUrl ? 'Yes' : 'No'
          });
        });
      });
      
      const cbWS = XLSX.utils.json_to_sheet(cbData);
      XLSX.utils.book_append_sheet(wb, cbWS, 'Circuit Breaker Library');
      
      // Export Switch Library
      const switchData = [];
      Object.keys(switchLibrary).forEach(cat => {
        switchLibrary[cat].forEach(sw => {
          switchData.push({
            'Category': cat,
            'OEM Part Number': sw.switchOEMPart,
            'Description': sw.switchDesc,
            'Poles': sw.switchPoles,
            'Rating (A)': sw.switchRating,
            'Datasheet Available': sw.datasheetUrl ? 'Yes' : 'No'
          });
        });
      });
      
      const switchWS = XLSX.utils.json_to_sheet(switchData);
      XLSX.utils.book_append_sheet(wb, switchWS, 'Switch Library');
      
      // Download the file
      XLSX.writeFile(wb, 'Component_Library_Export.xlsx');
      showToast('Data exported successfully!', 'success');
    });
  </script>
  
  <!-- Bottom Shortcuts -->
  <div style="text-align: center; margin: 40px 0 20px 0;">
    <button id="youtubeBtn" style="width: 50px; height: 50px; background: #ff0000; border: none; border-radius: 50%; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(255,0,0,0.3); transition: transform 0.2s; margin: 0 10px;">
      <div style="width: 0; height: 0; border-left: 12px solid white; border-top: 8px solid transparent; border-bottom: 8px solid transparent; margin-left: 2px;"></div>
    </button>
    <button id="googleBtn" style="width: 50px; height: 50px; background: #4285f4; border: none; border-radius: 50%; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(66,133,244,0.3); transition: transform 0.2s; margin: 0 10px;">
      <div style="font-size: 18px; font-weight: bold; color: white; font-family: 'Arial', sans-serif;">G</div>
    </button>
    <button id="renEcosystemBtn" style="width: 50px; height: 50px; background: #2c3e50; border: none; border-radius: 50%; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(44,62,80,0.3); transition: transform 0.2s; margin: 0 10px;">
      <div style="font-size: 12px; font-weight: bold; color: white; font-family: 'Arial', sans-serif; text-align: center; line-height: 1;">ECO</div>
    </button>
  </div>
  
  <!-- Creator Note -->
  <div style="text-align: left; padding: 10px; font-size: 0.9rem; color: #000;">
    Page Created by: Syamir
  </div>
  
  <script>
    // Shortcut button handlers
    document.addEventListener('DOMContentLoaded', function() {
      const youtubeBtn = document.getElementById('youtubeBtn');
      const googleBtn = document.getElementById('googleBtn');
      const renEcosystemBtn = document.getElementById('renEcosystemBtn');
      
      if (youtubeBtn) {
        youtubeBtn.addEventListener('click', function() {
          window.open('https://www.youtube.com', '_blank');
        });
      }
      
      if (googleBtn) {
        googleBtn.addEventListener('click', function() {
          window.open('https://www.google.com', '_blank');
        });
      }
      
      if (renEcosystemBtn) {
        renEcosystemBtn.addEventListener('click', function() {
          window.open('https://www.renecosystem.com/ESS/MY/sasb/', '_blank');
        });
      }
    });
  </script>

  <script>
    // Edit functionality
    let currentEditItem = null;
    let currentEditType = null;
    
    // Edit button event handlers (event delegation)
    cableTablesDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-cable-btn')) {
        const cableCategory = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const cableToEdit = cableLibrary[cableCategory][idx];
        
        // Populate edit modal
        document.getElementById('editModalTitle').textContent = 'Edit Cable';
        document.getElementById('editOEM').value = cableToEdit.oemPart;
        document.getElementById('editDesc').value = cableToEdit.cableDesc;
        document.getElementById('editCores').value = cableToEdit.numCores;
        document.getElementById('editRating').value = cableToEdit.cableRating;
        
        // Store current edit item
        currentEditItem = { category: cableCategory, idx: idx, type: 'cable' };
        
        // Show edit modal
        document.getElementById('editModal').classList.add('show');
      }
    });
    
    cbTablesDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-cb-btn')) {
        const cbCategory = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const cbToEdit = cbLibrary[cbCategory][idx];
        
        // Populate edit modal
        document.getElementById('editModalTitle').textContent = 'Edit Circuit Breaker';
        document.getElementById('editOEM').value = cbToEdit.cbOEMPart;
        document.getElementById('editDesc').value = cbToEdit.cbDesc;
        document.getElementById('editCores').value = cbToEdit.cbPoles;
        document.getElementById('editRating').value = cbToEdit.cbRating;
        
        // Store current edit item
        currentEditItem = { category: cbCategory, idx: idx, type: 'cb' };
        
        // Show edit modal
        document.getElementById('editModal').classList.add('show');
      }
    });
    
    switchTablesDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-switch-btn')) {
        const switchCategory = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const switchToEdit = switchLibrary[switchCategory][idx];
        
        // Populate edit modal
        document.getElementById('editModalTitle').textContent = 'Edit Switch';
        document.getElementById('editOEM').value = switchToEdit.switchOEMPart;
        document.getElementById('editDesc').value = switchToEdit.switchDesc;
        document.getElementById('editCores').value = switchToEdit.switchPoles;
        document.getElementById('editRating').value = switchToEdit.switchRating;
        
        // Store current edit item
        currentEditItem = { category: switchCategory, idx: idx, type: 'switch' };
        
        // Show edit modal
        document.getElementById('editModal').classList.add('show');
      }
    });
    
    // Edit form submission
    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!currentEditItem) return;
      
      const newOEM = document.getElementById('editOEM').value;
      const newDesc = document.getElementById('editDesc').value;
      const newCores = document.getElementById('editCores').value;
      const newRating = document.getElementById('editRating').value;
      
      // Update the item based on type
      if (currentEditItem.type === 'cable') {
        const cable = cableLibrary[currentEditItem.category][currentEditItem.idx];
        cable.oemPart = newOEM;
        cable.cableDesc = newDesc;
        cable.numCores = newCores;
        cable.cableRating = newRating;
        // Debug log
        console.log('Updating cable:', cable);
        if (!cable.id) {
          showToast('Error: Cable ID is missing. Cannot update.', 'error');
          return;
        }
        updateCableInFirebase(cable.id, cable).then((success) => {
          if (success) {
            renderCableTables();
            showToast('Cable updated successfully!', 'success');
          } else {
            showToast('Error updating cable. Please try again.', 'error');
          }
        });
      } else if (currentEditItem.type === 'cb') {
        const cb = cbLibrary[currentEditItem.category][currentEditItem.idx];
        cb.cbOEMPart = newOEM;
        cb.cbDesc = newDesc;
        cb.cbPoles = newCores;
        cb.cbRating = newRating;
        // Debug log
        console.log('Updating circuit breaker:', cb);
        if (!cb.id) {
          showToast('Error: Circuit Breaker ID is missing. Cannot update.', 'error');
          return;
        }
        updateCBInFirebase(cb.id, cb).then((success) => {
          if (success) {
            renderCBTables();
            showToast('Circuit Breaker updated successfully!', 'success');
          } else {
            showToast('Error updating circuit breaker. Please try again.', 'error');
          }
        });
      } else if (currentEditItem.type === 'switch') {
        const sw = switchLibrary[currentEditItem.category][currentEditItem.idx];
        sw.switchOEMPart = newOEM;
        sw.switchDesc = newDesc;
        sw.switchPoles = newCores;
        sw.switchRating = newRating;
        // Debug log
        console.log('Updating switch:', sw);
        if (!sw.id) {
          showToast('Error: Switch ID is missing. Cannot update.', 'error');
          return;
        }
        updateSwitchInFirebase(sw.id, sw).then((success) => {
          if (success) {
            renderSwitchTables();
            showToast('Switch updated successfully!', 'success');
          } else {
            showToast('Error updating switch. Please try again.', 'error');
          }
        });
      }
      
      // Hide edit modal
      document.getElementById('editModal').classList.remove('show');
      currentEditItem = null;
    });
    
    // Cancel edit button
    document.getElementById('cancelEdit').addEventListener('click', function() {
      document.getElementById('editModal').classList.remove('show');
      currentEditItem = null;
    });
    
    // Remove item button
    document.getElementById('removeItem').addEventListener('click', function() {
      if (!currentEditItem) return;
      
      if (confirm('Are you sure you want to remove this item?')) {
        if (currentEditItem.type === 'cable') {
          const cable = cableLibrary[currentEditItem.category][currentEditItem.idx];
          deleteCableFromFirebase(cable.id).then(() => {
            cableLibrary[currentEditItem.category].splice(currentEditItem.idx, 1);
            renderCableTables();
            showToast('Cable removed successfully!', 'success');
          }).catch(() => {
            showToast('Error removing cable. Please try again.', 'error');
          });
        } else if (currentEditItem.type === 'cb') {
          const cb = cbLibrary[currentEditItem.category][currentEditItem.idx];
          deleteCBFromFirebase(cb.id).then(() => {
            cbLibrary[currentEditItem.category].splice(currentEditItem.idx, 1);
            renderCBTables();
            showToast('Circuit Breaker removed successfully!', 'success');
          }).catch(() => {
            showToast('Error removing circuit breaker. Please try again.', 'error');
          });
        } else if (currentEditItem.type === 'switch') {
          const sw = switchLibrary[currentEditItem.category][currentEditItem.idx];
          deleteSwitchFromFirebase(sw.id).then(() => {
            switchLibrary[currentEditItem.category].splice(currentEditItem.idx, 1);
            renderSwitchTables();
            showToast('Switch removed successfully!', 'success');
          }).catch(() => {
            showToast('Error removing switch. Please try again.', 'error');
          });
        }
        
        // Hide edit modal
        document.getElementById('editModal').classList.remove('show');
        currentEditItem = null;
      }
    });
    
    // Close edit modal when clicking outside
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
        currentEditItem = null;
      }
    });
  </script>
  
  <script>
    document.querySelectorAll('.min-comp-filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.min-comp-filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const filter = this.getAttribute('data-filter');
        document.querySelectorAll('.min-comp-table').forEach(table => {
          if (filter === 'all' || table.getAttribute('data-filter') === filter) {
            table.style.display = '';
          } else {
            table.style.display = 'none';
          }
        });
      });
    });
  </script>

  <script>
    // Add event listeners for category filter buttons
    document.addEventListener('DOMContentLoaded', function() {
      // Cable Library category filters
      const cableCategoryBtns = document.querySelectorAll('.category-filter-btn[data-category]');
      cableCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          // Remove active class from all buttons
          cableCategoryBtns.forEach(b => b.classList.remove('active'));
          // Add active class to clicked button
          this.classList.add('active');
          // Re-render tables
          renderCableTables();
        });
      });
      
      // Circuit Breaker Library category filters
      const cbCategoryBtns = document.querySelectorAll('.category-filter-btn[data-category]');
      cbCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          cbCategoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          renderCBTables();
        });
      });
      
      // Switch Library category filters
      const switchCategoryBtns = document.querySelectorAll('.category-filter-btn[data-category]');
      switchCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          switchCategoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          renderSwitchTables();
        });
      });
    });
  </script>

  <script>
    // Replace the global event listener logic for category filter buttons with section-specific logic
    // Remove the previous global event listener script for .category-filter-btn
    // Add this after each library section is shown (e.g., in the code that activates .cable-library, .circuit-breaker-library, .switch-library):

    function setupCableCategoryFilters() {
      const cableCategoryBtns = document.querySelectorAll('.cable-library .category-filter-btn[data-category]');
      cableCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          cableCategoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          renderCableTables();
        });
      });
    }

    function setupCBCategoryFilters() {
      const cbCategoryBtns = document.querySelectorAll('.circuit-breaker-library .category-filter-btn[data-category]');
      cbCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          cbCategoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          renderCBTables();
        });
      });
    }

    function setupSwitchCategoryFilters() {
      const switchCategoryBtns = document.querySelectorAll('.switch-library .category-filter-btn[data-category]');
      switchCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          switchCategoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          renderSwitchTables();
        });
      });
    }

    // Call these functions after showing each library section, e.g.:
    // When showing Cable Library:
    // setupCableCategoryFilters();
    // When showing Circuit Breaker Library:
    // setupCBCategoryFilters();
    // When showing Switch Library:
    // setupSwitchCategoryFilters();

    // Also call the relevant setup function in DOMContentLoaded for the initially visible section (if any)
    document.addEventListener('DOMContentLoaded', function() {
      setupCableCategoryFilters();
      setupCBCategoryFilters();
      setupSwitchCategoryFilters();
    });
  </script>

  <script>
    // Add event listeners for the dropdowns to re-render tables on change
    document.addEventListener('DOMContentLoaded', function() {
      const cableCategoryDropdown = document.getElementById('cableCategoryDropdown');
      if (cableCategoryDropdown) cableCategoryDropdown.addEventListener('change', renderCableTables);
      const cbCategoryDropdown = document.getElementById('cbCategoryDropdown');
      if (cbCategoryDropdown) cbCategoryDropdown.addEventListener('change', renderCBTables);
      const switchCategoryDropdown = document.getElementById('switchCategoryDropdown');
      if (switchCategoryDropdown) switchCategoryDropdown.addEventListener('change', renderSwitchTables);
    });
  </script>

  <script>
    // Add event listener to the dropdown to re-run showMinimumComponents when changed
    document.addEventListener('DOMContentLoaded', function() {
      const minCompCableCategoryDropdown = document.getElementById('minCompCableCategoryDropdown');
      if (minCompCableCategoryDropdown) {
        minCompCableCategoryDropdown.addEventListener('change', function() {
          const value = parseFloat(document.getElementById('currentInput').value);
          if (!isNaN(value) && value > 0) {
            showMinimumComponents(value);
          }
        });
      }
    });
  </script>
  
  <!-- Performance Summary -->
  <script>
    // Log performance metrics on page load
    window.addEventListener('load', function() {
      console.log('=== Performance Summary ===');
      console.log(`Total page load time: ${performanceMetrics.getTotalTime().toFixed(2)}ms`);
      console.log('Optimizations applied:');
      console.log('- CSS Variables for consistent theming');
      console.log('- Debounced search (300ms delay)');
      console.log('- Cached DOM elements');
      console.log('- Event delegation for dynamic content');
      console.log('- Optimized table rendering with DocumentFragment');
      console.log('- Batch Firebase operations');
      console.log('- Performance monitoring');
      console.log('- RequestAnimationFrame for animations');
      console.log('- Utility classes for consistent styling');
      console.log('===========================');
    });
  </script>
</body>
</html> 
