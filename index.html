<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cable Ampacity Calculator</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <!-- SheetJS for Excel file reading -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      background: #f0f8ff;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 40px 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    .container {
      margin: 60px auto 0 auto;
      background: #282c34;
      border-radius: 14px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.18);
      padding: 50px 40px 40px 40px;
      max-width: 900px;
      width: 100%;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-bottom: 10px;
      font-size: 2.2rem;
      letter-spacing: 1px;
      color: #61dafb;
    }
    .input-group {
      margin: 18px 0 24px 0;
    }
    label {
      font-size: 1.1rem;
      margin-right: 8px;
    }
    input[type="number"] {
      padding: 10px;
      font-size: 1.1rem;
      border-radius: 6px;
      border: 1px solid #bbb;
      width: 120px;
      text-align: center;
      margin-right: 8px;
    }
    .results {
      margin-top: 18px;
      background: #22252b;
      border-radius: 10px;
      padding: 18px 10px 10px 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #444;
      padding: 8px 12px;
      font-size: 1.05rem;
    }
    th {
      background: #353a45;
      color: #61dafb;
    }
    tr:nth-child(even) {
      background: #2e323a;
    }
    tr:nth-child(odd) {
      background: #23262c;
    }
    td {
      color: #fff;
    }
    @media (max-width: 600px) {
      .container {
        padding: 18px 4px 18px 4px;
        max-width: 98vw;
      }
      th, td {
        padding: 6px 4px;
        font-size: 0.98rem;
      }
    }
    
    /* Enhanced input focus and hover effects */
    input:focus, select:focus {
      outline: none;
      border-color: #61dafb !important;
      box-shadow: 0 0 0 3px rgba(97, 218, 251, 0.2) !important;
    }
    
    input:hover, select:hover {
      border-color: #61dafb !important;
    }
    
    /* Button hover effects */
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(97, 218, 251, 0.4) !important;
    }
    
    button:active {
      transform: translateY(0);
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #61dafb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      background: #4CAF50;
    }
    
    .toast.error {
      background: #f44336;
    }
    
    .toast.info {
      background: #2196F3;
    }
    
    /* Print Styles */
    @media print {
      body {
        background: white !important;
        color: black !important;
      }
      
      .container, .cable-library, .circuit-breaker-library, .switch-library {
        background: white !important;
        color: black !important;
        box-shadow: none !important;
        border: 1px solid #ccc !important;
      }
      
      h1, h2, h3 {
        color: black !important;
      }
      
      table {
        border: 1px solid #000 !important;
      }
      
      th, td {
        border: 1px solid #000 !important;
        color: black !important;
        background: white !important;
      }
      
      button, input, select {
        display: none !important;
      }
      
      #minimumComponents {
        page-break-inside: avoid;
      }
    }
    
    /* Library Selection Styles */
    .library-btn:hover {
      transform: scale(1.05);
    }
    
    .library-section {
      display: none;
    }
    
    .library-section.active {
      display: block;
    }
    
    /* Login Modal Styles */
    .login-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    
    .login-modal.show {
      display: flex;
    }
    
    .login-container {
      background: #23262c;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      text-align: center;
      min-width: 350px;
    }
    
    .login-container h2 {
      color: #61dafb;
      margin-bottom: 30px;
    }
    
    .login-input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #444;
      border-radius: 6px;
      background: #333;
      color: white;
      font-size: 1rem;
    }
    
    .login-input::placeholder {
      color: #888;
    }
    
    .login-btn {
      width: 100%;
      padding: 12px;
      background: #61dafb;
      color: #23262c;
      border: none;
      border-radius: 6px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:hover {
      background: #4fa8c7;
    }
    
    .error-message {
      color: #ff7675;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    
    /* Edit Modal Styles */
    .edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    
    .edit-modal.show {
      display: flex;
    }
    
    /* Tab Styles */
    .tab-btn {
      transition: all 0.3s ease;
    }
    
    .tab-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(97, 218, 251, 0.3);
    }
    
    .tab-btn.active {
      background: #61dafb !important;
      color: #23262c !important;
      box-shadow: 0 4px 12px rgba(97, 218, 251, 0.3);
    }
    
    .tab-content {
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }
    
    .tab-content.active {
      display: flex;
    }
    
    .edit-container {
      background: #23262c;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      min-width: 400px;
    }
    
    .edit-container h3 {
      color: #61dafb;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .edit-input-group {
      margin-bottom: 15px;
    }
    
    .edit-input-group label {
      display: block;
      color: #fff;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
    
    .edit-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #333;
      color: white;
      font-size: 0.9rem;
    }
    
    .edit-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .edit-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .save-btn {
      background: #4CAF50;
      color: white;
    }
    
    .cancel-btn {
      background: #666;
      color: white;
    }
    
    /* Shortcut Button Hover Effects */
    #youtubeBtn:hover, #googleBtn:hover, #renEcosystemBtn:hover {
      transform: scale(1.1);
    }
    
    /* Filter Buttons */
    .min-comp-filter-btn {
      padding: 8px 18px;
      background: #353a45;
      color: #61dafb;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s, color 0.2s;
      margin-bottom: 8px;
    }
    .min-comp-filter-btn.active, .min-comp-filter-btn:hover {
      background: #61dafb;
      color: #23262c;
    }
    
    /* Category Filter Buttons */
    .category-filter-btn {
      padding: 6px 12px;
      background: #353a45;
      color: #61dafb;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s, color 0.2s;
      margin: 2px;
    }
    .category-filter-btn.active, .category-filter-btn:hover {
      background: #61dafb;
      color: #23262c;
    }
    
    /* Add a CSS rule to ensure all form input, select, and button elements in the Cable Library add form have the same height */
    #cableForm input[type="text"],
    #cableForm input[type="number"],
    #cableForm select,
    #cableForm button[type="submit"] {
      height: 38px;
      box-sizing: border-box;
      font-size: 1rem;
      vertical-align: middle;
      min-width: 140px;
      padding-left: 10px;
      padding-right: 10px;
    }
  </style>
</head>
<body>
  
  <!-- Creator Note -->
  <div style="margin-top: 24px; font-size: 0.95rem; color: #000; text-align: center; width: 100%; display: flex; justify-content: center;">
    Page Created by: Syamir
  </div>
  
  <!-- Top Action Buttons -->
  <div style="position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 1000;">
    <button id="exportLibraryBtn" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: none;">📊 Export Library</button>
    <button id="logoutBtn" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: none;">🚪 Logout</button>
  </div>
  
  <!-- Login Modal -->
  <div id="loginModal" class="login-modal">
    <div class="login-container">
      <h2>🔐 Library Management Login</h2>
      <form id="loginForm">
        <input type="text" id="username" name="username" class="login-input" placeholder="Username" required>
        <input type="password" id="password" name="password" class="login-input" placeholder="Password" required>
        <button type="submit" class="login-btn">Login</button>
        <div id="loginError" class="error-message" style="display: none;"></div>
      </form>
    </div>
  </div>
  
  <!-- Edit Modal -->
  <div id="editModal" class="edit-modal">
    <div class="edit-container">
      <h3 id="editModalTitle">Edit Item</h3>
      <form id="editForm">
        <div class="edit-input-group">
          <label for="editOEM">OEM Part Number:</label>
          <input type="text" id="editOEM" class="edit-input" required>
        </div>
        <div class="edit-input-group">
          <label for="editDesc">Description:</label>
          <input type="text" id="editDesc" class="edit-input" required>
        </div>
        <div class="edit-input-group">
          <label for="editCores">No. of Cores:</label>
          <input type="number" id="editCores" class="edit-input" min="1" required>
        </div>
        <div class="edit-input-group">
          <label for="editRating">Rating (A):</label>
          <input type="number" id="editRating" class="edit-input" min="1" required>
        </div>
        <div class="edit-buttons">
          <button type="submit" class="edit-btn save-btn">Save</button>
          <button type="button" class="edit-btn cancel-btn" id="cancelEdit">Cancel</button>
          <button type="button" class="edit-btn cancel-btn" id="removeItem" style="background: #ff7675;">🗑️ Remove</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Datasheet Modal -->
  <div id="datasheetModal" class="edit-modal">
    <div class="edit-container">
      <h3 id="datasheetModalTitle">Datasheet Management</h3>
      <div id="datasheetContent">
        <div style="margin-bottom: 20px; text-align: center;">
          <p id="datasheetStatus" style="color: #61dafb; font-weight: bold;"></p>
        </div>
        <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
          <button id="uploadDatasheetBtn" class="edit-btn save-btn" style="background: #007bff;">📤 Upload PDF</button>
          <button id="downloadDatasheetBtn" class="edit-btn save-btn" style="background: #28a745; display: none;">📥 Download PDF</button>
          <button id="deleteDatasheetBtn" class="edit-btn cancel-btn" style="background: #dc3545; display: none;">🗑️ Delete PDF</button>
          <button id="cancelDatasheetBtn" class="edit-btn cancel-btn">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Export Progress Modal -->
  <div id="exportModal" class="edit-modal">
    <div class="edit-container">
      <h3 id="exportModalTitle">📊 Exporting Library Data</h3>
      <div id="exportContent">
        <div style="margin-bottom: 20px; text-align: center;">
          <div id="exportProgress" style="margin: 20px 0;">
            <div style="width: 100%; background-color: #f0f0f0; border-radius: 10px; overflow: hidden; height: 20px;">
              <div id="exportProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4CAF50, #45a049); transition: width 0.3s ease;"></div>
            </div>
            <p id="exportProgressText" style="margin-top: 10px; color: #61dafb; font-weight: bold;">Preparing export...</p>
          </div>
          <div id="exportDetails" style="text-align: left; background: #2e323a; padding: 15px; border-radius: 6px; margin: 15px 0; color: #fff;">
            <p><strong>Cable Library:</strong> <span id="cableCount">0</span> items</p>
            <p><strong>Circuit Breaker Library:</strong> <span id="cbCount">0</span> items</p>
            <p><strong>Switch Library:</strong> <span id="switchCount">0</span> items</p>
          </div>
        </div>
        <div id="exportButtons" style="display: none; text-align: center;">
          <button id="exportCloseBtn" class="edit-btn save-btn" style="background: #007bff; margin: 0 10px;">Close</button>
          <button id="exportRetryBtn" class="edit-btn cancel-btn" style="background: #dc3545; margin: 0 10px;">Retry</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab Navigation -->
  <div id="tabNavigation" style="margin: 40px auto 0 auto; max-width: 1400px; background: #23262c; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); padding: 30px;">
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
      <button id="calculatorTab" class="tab-btn active" style="padding: 12px 24px; background: #61dafb; color: #23262c; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;">
        ⚡ Cable Ampacity Calculator
      </button>
      <button id="libraryTab" class="tab-btn" style="padding: 12px 24px; background: #444; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: all 0.3s ease;">
        📚 Library Management
      </button>
    </div>
  </div>

  <!-- Calculator Tab Content -->
    <div id="calculatorContent" class="tab-content active" style="margin: 40px auto 0 auto; max-width: 900px; width: 100%; background: #23262c; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); padding: 40px 30px; text-align: center;">
    <h2 style="color: #61dafb; margin-bottom: 20px; text-align: center;">⚡ Cable Ampacity Calculator</h2>
    <div class="input-group" style="margin-bottom: 20px;">
      <label for="currentInput" style="display: block; margin-bottom: 8px; color: #61dafb; font-weight: 600;">Rated Current (Amps):</label>
      <input type="number" id="currentInput" min="0" placeholder="e.g. 12" style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 1rem; transition: border-color 0.3s ease;" />
    </div>
    <div class="input-group" style="margin-bottom: 20px;">
      <label for="temperatureRating" style="display: block; margin-bottom: 8px; color: #61dafb; font-weight: 600;">Insulation Temperature Rating:</label>
      <select id="temperatureRating" style="width: 100%; padding: 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 1rem; transition: border-color 0.3s ease;">
        <option value="60">60°C</option>
        <option value="75">75°C</option>
        <option value="90">90°C</option>
        <option value="105">105°C</option>
      </select>
    </div>
    <div id="results" class="results" style="display:none; background: #2e323a; padding: 20px; border-radius: 8px; margin-top: 20px;"></div>
    <div style="margin-top: 24px; font-size: 0.95rem; color: #61dafb; text-align: center;">
      Ampacity data referenced from SEMI S22-1110b Standard with comprehensive temperature ratings (60°C, 75°C, 90°C, 105°C).
    </div>
  </div>

  <!-- Library Management Tab Content -->
      <div id="libraryContent" class="tab-content" style="display: none; width: 100%; text-align: center;">
    <!-- Library Selection Interface -->
          <div id="librarySelection" style="margin: 40px auto 0 auto; max-width: 900px; width: 100%; background: #23262c; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); padding: 40px 30px; text-align: center;">
    <h2 style="color: #61dafb; margin: 0 0 30px 0; text-align: center;">Library Management</h2>
    <div id="loginSection" style="text-align: center;">
      <button id="loginBtn" style="padding: 15px 30px; background: #61dafb; color: #23262c; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer;">🔐 Login to Access Libraries</button>
    </div>
    <div id="libraryButtons" style="display: none;">
    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
      <button class="library-btn" data-library="cable" style="padding: 20px 30px; background: white; color: #333; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; min-width: 150px; transition: transform 0.2s;">
        🔌 Cable Library
      </button>
      <button class="library-btn" data-library="circuit-breaker" style="padding: 20px 30px; background: white; color: #333; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; min-width: 150px; transition: transform 0.2s;">
        ⚡ Circuit Breaker Library
      </button>
      <button class="library-btn" data-library="switch" style="padding: 20px 30px; background: white; color: #333; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; min-width: 150px; transition: transform 0.2s;">
        🔄 Switch Library
      </button>
    </div>
    </div>
    <div style="text-align: center; margin-top: 20px;">
      <button id="backToSelection" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; display: none;">← Back to Library Selection</button>
    </div>
  </div>



     <div class="cable-library library-section" style="margin: 40px auto 0 auto; max-width: 1200px; width: 100%; background: #23262c; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); padding: 28px 18px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
      <h2 style="color: #61dafb; margin: 0;">Cable Library</h2>
      <button class="back-to-main-btn" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">← Back to Main Page</button>
    </div>
    <form id="cableForm" style="display: flex; flex-wrap: nowrap; gap: 20px; align-items: flex-end; justify-content: center; margin-bottom: 0;">
      <div style="min-width: 140px;">
        <label for="cableCategory" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">Category:</label>
        <select id="cableCategory" required style="width: 140px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;">
          <option value="Single Core">Single Core</option>
          <option value="Multi Core">Multi Core</option>
          <option value="Robotic Cable">Robotic Cable</option>
          <option value="Flexible Cable">Flexible Cable</option>
          <option value="EtherNET">EtherNET</option>
          <option value="EtherCAT">EtherCAT</option>
        </select>
      </div>
      <div style="min-width: 140px;">
        <label for="oemPart" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">OEM Part Number:</label>
        <input type="text" id="oemPart" required style="width: 140px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;" placeholder="Enter part number" />
      </div>
      <div style="min-width: 300px;">
        <label for="cableDesc" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">Description:</label>
        <input type="text" id="cableDesc" required style="width: 300px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;" placeholder="Enter description" />
      </div>
      <div style="min-width: 80px;">
        <label for="numCores" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">No. of Cores:</label>
        <input type="number" id="numCores" min="1" required style="width: 80px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease; text-align: center;" placeholder="1" />
      </div>
      <div style="min-width: 80px;">
        <label for="cableRating" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">Rating (A):</label>
        <input type="number" id="cableRating" min="1" required style="width: 80px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease; text-align: center;" placeholder="16" />
      </div>
      <div>
        <button type="submit" style="padding: 12px 24px; background: linear-gradient(45deg, #61dafb, #4fa8c7); color: #23262c; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(97, 218, 251, 0.3);">Add Cable</button>
      </div>
    </form>
    <div style="margin-top: 20px; text-align: center;">
      <h3 style="color: #ffb347; margin-bottom: 15px;">Import Excel Files by Category</h3>
      <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
        <div>
          <input type="file" id="singleCoreFile" accept=".xlsx,.xls" style="display: none;" data-category="Single Core" />
          <button type="button" class="import-category-btn" data-category="Single Core" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 Single Core</button>
        </div>
        <div>
          <input type="file" id="multiCoreFile" accept=".xlsx,.xls" style="display: none;" data-category="Multi Core" />
          <button type="button" class="import-category-btn" data-category="Multi Core" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 Multi Core</button>
        </div>
        <div>
          <input type="file" id="roboticFile" accept=".xlsx,.xls" style="display: none;" data-category="Robotic Cable" />
          <button type="button" class="import-category-btn" data-category="Robotic Cable" style="padding: 8px 16px; background: #FF9800; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 Robotic Cable</button>
        </div>
        <div>
          <input type="file" id="flexibleFile" accept=".xlsx,.xls" style="display: none;" data-category="Flexible Cable" />
          <button type="button" class="import-category-btn" data-category="Flexible Cable" style="padding: 8px 16px; background: #9C27B0; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 Flexible Cable</button>
        </div>
        <div>
          <input type="file" id="ethernetFile" accept=".xlsx,.xls" style="display: none;" data-category="EtherNET" />
          <button type="button" class="import-category-btn" data-category="EtherNET" style="padding: 8px 16px; background: #009688; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 EtherNET</button>
        </div>
        <div>
          <input type="file" id="ethercatFile" accept=".xlsx,.xls" style="display: none;" data-category="EtherCAT" />
          <button type="button" class="import-category-btn" data-category="EtherCAT" style="padding: 8px 16px; background: #607D8B; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 EtherCAT</button>
        </div>
      </div>
      <div style="margin-top: 18px; display: flex; justify-content: center;">
        <input type="text" id="searchOEM" placeholder="Search by OEM Part No or Rating" style="padding: 12px 16px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; width: 350px; text-align: center; transition: border-color 0.3s ease;" />
      </div>
      <div style="margin-top: 12px; display: flex; justify-content: center; align-items: center; gap: 12px;">
        <label for="cableCategoryDropdown" style="color:#61dafb; font-weight:bold;">Category:</label>
        <select id="cableCategoryDropdown" style="padding: 8px 12px; border: 2px solid #444; border-radius: 6px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;">
          <option value="all">All Categories</option>
          <option value="Single Core">Single Core</option>
          <option value="Multi Core">Multi Core</option>
          <option value="Robotic Cable">Robotic Cable</option>
          <option value="Flexible Cable">Flexible Cable</option>
          <option value="EtherNET">EtherNET</option>
          <option value="EtherCAT">EtherCAT</option>
        </select>
      </div>
    </div>
    <div id="cableTables" style="margin-top: 30px;"></div>
  </div>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB_8ntUz0TnWzTtygzZ-r7d-9yVg-zj254",
      authDomain: "attendance-ac65f.firebaseapp.com",
      projectId: "attendance-ac65f",
      storageBucket: "attendance-ac65f.firebasestorage.app",
      messagingSenderId: "156838355463",
      appId: "1:156838355463:web:c0533dfeae05014a0d40a2",
      measurementId: "G-614JWRFCLQ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Comprehensive ampacity table with multiple temperature ratings (AWG, mm², Amps at different temperatures, Bending Space mm)
    const ampacityTable = [
      // AWG 30-4 range (from first table)
      { awg: '30', mm2: 0.050, amps_60c: null, amps_75c: 0.5, amps_90c: 0.8, amps_105c: 1, bend_mm: 6.4, bend_inch: 0.25, protective_awg: '30', protective_mm2: 0.050 },
      { awg: '28', mm2: 0.080, amps_60c: null, amps_75c: 1, amps_90c: 1.5, amps_105c: 2, bend_mm: 6.4, bend_inch: 0.25, protective_awg: '28', protective_mm2: 0.080 },
      { awg: '26', mm2: 0.126, amps_60c: 0.75, amps_75c: 1.5, amps_90c: 2, amps_105c: 2.5, bend_mm: 6.4, bend_inch: 0.25, protective_awg: '26', protective_mm2: 0.126 },
      { awg: '24', mm2: 0.201, amps_60c: 2, amps_75c: 3, amps_90c: 4, amps_105c: 5, bend_mm: 6.4, bend_inch: 0.25, protective_awg: '24', protective_mm2: 0.201 },
      { awg: '22', mm2: 0.318, amps_60c: 3, amps_75c: 5, amps_90c: 6, amps_105c: 7, bend_mm: 13, bend_inch: 0.5, protective_awg: '22', protective_mm2: 0.318 },
      { awg: '20', mm2: 0.509, amps_60c: 5, amps_75c: 7, amps_90c: 9, amps_105c: 10, bend_mm: 13, bend_inch: 0.5, protective_awg: '20', protective_mm2: 0.509 },
      { awg: '18', mm2: 0.823, amps_60c: 7, amps_75c: 10, amps_90c: 12, amps_105c: 14, bend_mm: 13, bend_inch: 0.5, protective_awg: '18', protective_mm2: 0.823 },
      { awg: '16', mm2: 1.31, amps_60c: 10, amps_75c: 15, amps_90c: 18, amps_105c: 20, bend_mm: 20, bend_inch: 0.75, protective_awg: '16', protective_mm2: 1.31 },
      { awg: '14', mm2: 2.08, amps_60c: 15, amps_75c: 20, amps_90c: 25, amps_105c: 28, bend_mm: 20, bend_inch: 0.75, protective_awg: '14', protective_mm2: 2.08 },
      { awg: '12', mm2: 3.31, amps_60c: 20, amps_75c: 25, amps_90c: 30, amps_105c: 35, bend_mm: 26, bend_inch: 1, protective_awg: '12', protective_mm2: 3.31 },
      { awg: '10', mm2: 5.26, amps_60c: 30, amps_75c: 35, amps_90c: 40, amps_105c: 45, bend_mm: 26, bend_inch: 1, protective_awg: '10', protective_mm2: 5.26 },
      { awg: '8', mm2: 8.37, amps_60c: 40, amps_75c: 50, amps_90c: 55, amps_105c: 60, bend_mm: 39, bend_inch: 1.5, protective_awg: '10', protective_mm2: 5.26 },
      { awg: '6', mm2: 13.3, amps_60c: 55, amps_75c: 65, amps_90c: 75, amps_105c: 80, bend_mm: 51, bend_inch: 2, protective_awg: '8', protective_mm2: 8.37 },
      { awg: '4', mm2: 21.15, amps_60c: 70, amps_75c: 85, amps_90c: 95, amps_105c: 105, bend_mm: 76, bend_inch: 3, protective_awg: '8', protective_mm2: 8.37 },
      
      // Metric sizes (from first table)
      { awg: '-', mm2: 0.5, amps_60c: 5, amps_75c: 6, amps_90c: 7, amps_105c: 8, bend_mm: 13, bend_inch: 0.5, protective_awg: '-', protective_mm2: 0.5 },
      { awg: '-', mm2: 0.75, amps_60c: 6, amps_75c: 8, amps_90c: 9, amps_105c: 10, bend_mm: 13, bend_inch: 0.5, protective_awg: '-', protective_mm2: 0.75 },
      { awg: '-', mm2: 1.0, amps_60c: 8, amps_75c: 10, amps_90c: 12, amps_105c: 14, bend_mm: 19, bend_inch: 0.75, protective_awg: '-', protective_mm2: 1.0 },
      { awg: '-', mm2: 1.5, amps_60c: 11, amps_75c: 14, amps_90c: 16, amps_105c: 18, bend_mm: 19, bend_inch: 0.75, protective_awg: '-', protective_mm2: 1.5 },
      { awg: '-', mm2: 2.5, amps_60c: 17, amps_75c: 20, amps_90c: 24, amps_105c: 27, bend_mm: 25, bend_inch: 1, protective_awg: '-', protective_mm2: 2.5 },
      { awg: '-', mm2: 4.0, amps_60c: 24, amps_75c: 30, amps_90c: 35, amps_105c: 40, bend_mm: 25, bend_inch: 1, protective_awg: '-', protective_mm2: 4.0 },
      { awg: '-', mm2: 6.0, amps_60c: 32, amps_75c: 40, amps_90c: 45, amps_105c: 50, bend_mm: 38, bend_inch: 1.5, protective_awg: '-', protective_mm2: 6.0 },
      { awg: '-', mm2: 10.0, amps_60c: 45, amps_75c: 55, amps_90c: 65, amps_105c: 70, bend_mm: 51, bend_inch: 2, protective_awg: '-', protective_mm2: 6.0 },
      { awg: '-', mm2: 16.0, amps_60c: 60, amps_75c: 75, amps_90c: 85, amps_105c: 95, bend_mm: 76, bend_inch: 3, protective_awg: '-', protective_mm2: 10.0 },
      
      // Larger sizes (from second table)
      { awg: '3', mm2: 26.67, amps_60c: 80, amps_75c: 95, amps_90c: 105, amps_105c: 115, bend_mm: 89, bend_inch: 3.5, protective_awg: '8', protective_mm2: 8.37 },
      { awg: '2', mm2: 33.62, amps_60c: 95, amps_75c: 115, amps_90c: 130, amps_105c: 145, bend_mm: 115, bend_inch: 4.5, protective_awg: '6', protective_mm2: 13.30 },
      { awg: '1', mm2: 42.41, amps_60c: 110, amps_75c: 130, amps_90c: 150, amps_105c: 165, bend_mm: 140, bend_inch: 5.5, protective_awg: '6', protective_mm2: 13.30 },
      { awg: '1/0', mm2: 53.49, amps_60c: 125, amps_75c: 150, amps_90c: 170, amps_105c: 185, bend_mm: 165, bend_inch: 6.5, protective_awg: '4', protective_mm2: 21.15 },
      { awg: '2/0', mm2: 67.43, amps_60c: 145, amps_75c: 175, amps_90c: 195, amps_105c: 215, bend_mm: 190, bend_inch: 7.5, protective_awg: '4', protective_mm2: 21.15 },
      { awg: '3/0', mm2: 85.01, amps_60c: 165, amps_75c: 200, amps_90c: 225, amps_105c: 245, bend_mm: 215, bend_inch: 8.5, protective_awg: '3', protective_mm2: 26.67 },
      { awg: '4/0', mm2: 107.22, amps_60c: 195, amps_75c: 230, amps_90c: 260, amps_105c: 285, bend_mm: 240, bend_inch: 9.5, protective_awg: '2', protective_mm2: 33.62 },
      
      // Kcmil sizes (from second table)
      { awg: '(250)', mm2: 126.68, amps_60c: 215, amps_75c: 255, amps_90c: 290, amps_105c: 315, bend_mm: 265, bend_inch: 10.5, protective_awg: '1', protective_mm2: 42.41 },
      { awg: '(300)', mm2: 152.01, amps_60c: 240, amps_75c: 285, amps_90c: 320, amps_105c: 350, bend_mm: 290, bend_inch: 11.5, protective_awg: '1/0', protective_mm2: 53.49 },
      { awg: '(350)', mm2: 177.35, amps_60c: 260, amps_75c: 310, amps_90c: 350, amps_105c: 380, bend_mm: 315, bend_inch: 12.5, protective_awg: '2/0', protective_mm2: 67.43 },
      { awg: '(400)', mm2: 202.68, amps_60c: 280, amps_75c: 335, amps_90c: 375, amps_105c: 410, bend_mm: 340, bend_inch: 13.5, protective_awg: '3/0', protective_mm2: 85.01 },
      { awg: '(500)', mm2: 253.35, amps_60c: 320, amps_75c: 380, amps_90c: 425, amps_105c: 465, bend_mm: 365, bend_inch: 14.5, protective_awg: '4/0', protective_mm2: 107.22 },
      { awg: '(600)', mm2: 304.02, amps_60c: 355, amps_75c: 420, amps_90c: 475, amps_105c: 520, bend_mm: 381, bend_inch: 15, protective_awg: '4/0', protective_mm2: 107.22 }
    ];

    const input = document.getElementById('currentInput');
    const temperatureSelect = document.getElementById('temperatureRating');
    const resultsDiv = document.getElementById('results');

    function updateResults() {
      const value = parseFloat(input.value);
      const temperature = temperatureSelect.value;
      
      if (isNaN(value) || value <= 0) {
        resultsDiv.style.display = 'none';
        resultsDiv.innerHTML = '';
        // Hide minimum components section when input is empty or invalid
        const existingComponents = document.getElementById('minimumComponents');
        if (existingComponents) {
          existingComponents.remove();
        }
        return;
      }
      
      // Get the appropriate ampacity field based on temperature
      const ampacityField = `amps_${temperature}c`;
      const filtered = ampacityTable.filter(row => row[ampacityField] && value <= row[ampacityField]);
      
      // Sort by Metric (mm²) in ascending order
      filtered.sort((a, b) => a.mm2 - b.mm2);
      
      let html = '';
      if (filtered.length > 0) {
        const min = filtered[0];
        // Minimum size card shown between temperature selector and table
        html += `
          <div id="minimumSize" style="background:#1f232a;border:1px solid #3a3f4a;border-radius:10px;padding:14px 16px;margin-bottom:14px;text-align:left;">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
              <div style="color:#61dafb;font-weight:700;">Minimum Cable Size for ${value}A @ ${temperature}°C</div>
              <div style="color:#fff;">
                <span style="margin-right:14px;">AWG: <strong>${min.awg}</strong></span>
                <span style="margin-right:14px;">Metric: <strong>${min.mm2} mm²</strong></span>
                <span style="margin-right:14px;">Max Amps: <strong>${min[ampacityField]}</strong></span>
                <span>Bend: <strong>${min.bend_mm} mm</strong> (${min.bend_inch}")</span>
              </div>
            </div>
          </div>
        `;
        html += `<h2>Suitable Cable Sizes (${temperature}°C)</h2>`;
        html += '<table><thead><tr><th>AWG</th><th>Metric (mm²)</th><th>Max Amps</th><th>Bending Space (mm)</th><th>Bending Space (in)</th></tr></thead><tbody>';
        filtered.forEach(row => {
          html += `<tr><td>${row.awg}</td><td>${row.mm2}</td><td>${row[ampacityField]}</td><td>${row.bend_mm}</td><td>${row.bend_inch}</td></tr>`;
        });
        html += '</tbody></table>';
      } else {
        html += '<div style="margin-top:10px; color:#ff7675;">No suitable size found</div>';
      }
      resultsDiv.innerHTML = html;
      resultsDiv.style.display = 'block';
      
      // Show minimum components from libraries
      showMinimumComponents(value);
    }

    input.addEventListener('input', updateResults);
    temperatureSelect.addEventListener('change', updateResults);

    // --- Cable Library Section ---
    const cableForm = document.getElementById('cableForm');
    const cableTablesDiv = document.getElementById('cableTables');
    let cableLibrary = {
      'Single Core': [],
      'Multi Core': [],
      'Robotic Cable': [],
      'Flexible Cable': [],
      'EtherNET': [],
      'EtherCAT': []
    };

    cableForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const cableCategory = document.getElementById('cableCategory').value;
      const oemPart = document.getElementById('oemPart').value.trim();
      const cableDesc = document.getElementById('cableDesc').value.trim();
      const numCores = document.getElementById('numCores').value.trim();
      const cableRating = document.getElementById('cableRating').value.trim();
      if (!cableCategory || !oemPart || !cableDesc || !numCores || !cableRating) return;
      
      // Save to Firebase first, then add to local array with the ID
      saveCableToFirebase(cableCategory, { oemPart, cableDesc, numCores, cableRating }).then((docRef) => {
        if (docRef) {
          // Add to local array with the ID
          const newCable = { 
            id: docRef.id, 
            oemPart, 
            cableDesc, 
            numCores, 
            cableRating 
          };
          cableLibrary[cableCategory].push(newCable);
          
          showToast('Cable added successfully!', 'success');
          cableForm.reset();
          renderCableTables();
        } else {
          showToast('Error adding cable. Please try again.', 'error');
        }
      }).catch(() => {
        showToast('Error adding cable. Please try again.', 'error');
      });
    });

    const searchOEM = document.getElementById('searchOEM');
    searchOEM.addEventListener('input', renderCableTables);

    function renderCableTables() {
      let html = '';
      const searchVal = searchOEM.value.trim().toLowerCase();
      const activeCategoryFilter = document.getElementById('cableCategoryDropdown')?.value || 'all';
      let found = false;
      
      Object.keys(cableLibrary).forEach(cat => {
        if (activeCategoryFilter !== 'all' && cat !== activeCategoryFilter) return;
        
        // Filter cables by search value
        const filteredCables = searchVal
          ? cableLibrary[cat].filter(cable => {
              if (cat === 'EtherNET' || cat === 'EtherCAT') {
                return (
                  (cable.oemPart && cable.oemPart.toLowerCase().includes(searchVal)) ||
                  (cable.description && cable.description.toLowerCase().includes(searchVal)) ||
                  (cable.length && cable.length.toString().toLowerCase().includes(searchVal)) ||
                  (cable.colour && cable.colour.toLowerCase().includes(searchVal))
                );
              } else {
                return (
                  (cable.oemPart && cable.oemPart.toLowerCase().includes(searchVal)) ||
                  (cable.cableDesc && cable.cableDesc.toLowerCase().includes(searchVal)) ||
                  (cable.numCores && cable.numCores.toString().includes(searchVal)) ||
                  (cable.cableRating && cable.cableRating.toString().includes(searchVal))
                );
              }
            })
          : cableLibrary[cat];
        
        // Sort cables by rating in ascending order
        filteredCables.sort((a, b) => {
          if (a.cableRating && b.cableRating) return parseInt(a.cableRating) - parseInt(b.cableRating);
          return 0;
        });
        
        if (filteredCables.length === 0) return;
        found = true;
        html += `<h3 style='color:#ffb347; margin-bottom:6px;'>${cat} <button class='clear-all-cable-btn' data-cat='${cat}' style='padding:4px 8px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:500;margin-left:10px;'>🗑️ Clear All</button></h3>`;
        if (cat === 'EtherNET') {
          html += `<table style='margin-bottom:18px;'><thead><tr><th style='text-align:center;'>OEM Part Number</th><th>Description</th><th style='text-align:center;'>Length</th><th style='text-align:center;'>Colour</th><th style='text-align:center;'>Action</th></tr></thead><tbody>`;
          filteredCables.forEach((cable, idx) => {
            const datasheetColor = cable.datasheetUrl ? '#007bff' : '#dc3545';
            html += `<tr><td style='text-align:center;'>${cable.oemPart}</td><td>${cable.description}</td><td style='text-align:center;'>${cable.length || ''}</td><td style='text-align:center;'>${cable.colour || ''}</td><td style='text-align:center;'><button class='datasheet-cable-btn' data-cat='${cat}' data-idx='${cableLibrary[cat].indexOf(cable)}' style='padding:4px 8px;background:${datasheetColor};color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>📄 Datasheet</button><br><button class='edit-cable-btn' data-cat='${cat}' data-idx='${cableLibrary[cat].indexOf(cable)}' style='padding:4px 8px;background:#4CAF50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>✏️ Edit</button></td></tr>`;
          });
          html += '</tbody></table>';
          return;
        }
        if (cat === 'EtherCAT') {
          html += `<table style='margin-bottom:18px;'><thead><tr><th style='text-align:center;'>OEM Part Number</th><th>Description</th><th style='text-align:center;'>Length</th><th style='text-align:center;'>Colour</th><th style='text-align:center;'>Action</th></tr></thead><tbody>`;
          filteredCables.forEach((cable, idx) => {
            const datasheetColor = cable.datasheetUrl ? '#007bff' : '#dc3545';
            html += `<tr><td style='text-align:center;'>${cable.oemPart}</td><td>${cable.description}</td><td style='text-align:center;'>${cable.length || ''}</td><td style='text-align:center;'>${cable.colour || ''}</td><td style='text-align:center;'><button class='datasheet-cable-btn' data-cat='${cat}' data-idx='${cableLibrary[cat].indexOf(cable)}' style='padding:4px 8px;background:${datasheetColor};color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>📄 Datasheet</button><br><button class='edit-cable-btn' data-cat='${cat}' data-idx='${cableLibrary[cat].indexOf(cable)}' style='padding:4px 8px;background:#4CAF50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>✏️ Edit</button></td></tr>`;
          });
          html += '</tbody></table>';
          return;
        }
        html += `<table style='margin-bottom:18px;'><thead><tr><th style='text-align:center;'>OEM Part Number</th><th>Description</th><th style='text-align:center;'>No. of Cores</th><th style='text-align:center;'>Rating (A)</th><th style='text-align:center;'>Action</th></tr></thead><tbody>`;
        filteredCables.forEach((cable, idx) => {
          const datasheetColor = cable.datasheetUrl ? '#007bff' : '#dc3545';
          html += `<tr><td style='text-align:center;'>${cable.oemPart}</td><td>${cable.cableDesc}</td><td style='text-align:center;'>${cable.numCores}</td><td style='text-align:center;'>${cable.cableRating}</td><td style='text-align:center;'><button class='datasheet-cable-btn' data-cat='${cat}' data-idx='${cableLibrary[cat].indexOf(cable)}' style='padding:4px 8px;background:${datasheetColor};color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>📄 Datasheet</button><br><button class='edit-cable-btn' data-cat='${cat}' data-idx='${cableLibrary[cat].indexOf(cable)}' style='padding:4px 8px;background:#4CAF50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>✏️ Edit</button></td></tr>`;
        });
        html += '</tbody></table>';
      });
      cableTablesDiv.innerHTML = found ? html : '<div style="color:#bbb;">No cables found.</div>';
    }
    renderCableTables();

    // Datasheet cable event (event delegation)
    cableTablesDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('datasheet-cable-btn')) {
        const cableCategory = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const cable = cableLibrary[cableCategory][idx];
        
        // Show datasheet modal
        showDatasheetModal(cable, 'cable', cableCategory, idx);
      }
      
      // Clear All cable event
      if (e.target.classList.contains('clear-all-cable-btn')) {
        const cableCategory = e.target.getAttribute('data-cat');
        if (confirm(`Are you sure you want to clear all ${cableCategory} cables and their datasheets? This action cannot be undone.`)) {
          clearAllCablesByCategory(cableCategory);
        }
      }
    });



    // Firebase functions for Cable Library
    function saveCableToFirebase(category, cableData) {
      const submitBtn = cableForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.innerHTML = '<span class="spinner"></span> Save';
      submitBtn.disabled = true;
      
      let firebaseData = {
        category: category,
        oemPart: cableData.oemPart,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (category === 'EtherNET' || category === 'EtherCAT') {
        firebaseData.description = cableData.description;
        firebaseData.length = cableData.length;
        firebaseData.colour = cableData.colour;
      } else {
        firebaseData.cableDesc = cableData.cableDesc;
        firebaseData.numCores = cableData.numCores;
        firebaseData.cableRating = cableData.cableRating;
      }
      
      return db.collection('cables').add(firebaseData).then((docRef) => {
        console.log('Cable saved to Firebase with ID:', docRef.id);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return docRef;
      }).catch((error) => {
        console.error('Error saving cable: ', error);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return null;
      });
    }

    function loadCablesFromFirebase() {
      db.collection('cables').get().then((querySnapshot) => {
        cableLibrary = {
          'Single Core': [],
          'Multi Core': [],
          'Robotic Cable': [],
          'Flexible Cable': [],
          'EtherNET': [],
          'EtherCAT': []
        };
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (cableLibrary[data.category]) {
            if (data.category === 'EtherNET' || data.category === 'EtherCAT') {
              cableLibrary[data.category].push({
                id: doc.id,
                oemPart: data.oemPart,
                description: data.description,
                length: data.length,
                colour: data.colour,
                datasheetUrl: data.datasheetUrl || null
              });
            } else {
              cableLibrary[data.category].push({
                id: doc.id,
                oemPart: data.oemPart,
                cableDesc: data.cableDesc,
                numCores: data.numCores,
                cableRating: data.cableRating,
                datasheetUrl: data.datasheetUrl || null
              });
            }
          }
        });
        renderCableTables();
      }).catch((error) => {
        console.error('Error loading cables: ', error);
      });
    }

    // Global variables for datasheet modal
    let currentDatasheetItem = null;
    let currentDatasheetType = null;
    let currentDatasheetCategory = null;
    let currentDatasheetIndex = null;

    // Function to show datasheet modal
    function showDatasheetModal(item, type, category, index) {
      currentDatasheetItem = item;
      currentDatasheetType = type;
      currentDatasheetCategory = category;
      currentDatasheetIndex = index;
      
      const modal = document.getElementById('datasheetModal');
      const status = document.getElementById('datasheetStatus');
      const uploadBtn = document.getElementById('uploadDatasheetBtn');
      const downloadBtn = document.getElementById('downloadDatasheetBtn');
      const deleteBtn = document.getElementById('deleteDatasheetBtn');
      
      // Update modal title
      const title = document.getElementById('datasheetModalTitle');
      const itemName = type === 'cable' ? item.oemPart : (type === 'cb' ? item.cbOEMPart : item.switchOEMPart);
      title.textContent = `Datasheet Management - ${itemName}`;
      
      if (item.datasheetUrl) {
        // Datasheet exists
        status.textContent = '📄 Datasheet available';
        uploadBtn.style.display = 'none';
        downloadBtn.style.display = 'inline-block';
        deleteBtn.style.display = 'inline-block';
      } else {
        // No datasheet
        status.textContent = '📄 No datasheet uploaded';
        uploadBtn.style.display = 'inline-block';
        downloadBtn.style.display = 'none';
        deleteBtn.style.display = 'none';
      }
      
      modal.classList.add('show');
    }

    // Datasheet modal event handlers
    document.getElementById('uploadDatasheetBtn').addEventListener('click', function() {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.pdf';
      fileInput.style.display = 'none';
      document.body.appendChild(fileInput);
      
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const pdfData = e.target.result;
            currentDatasheetItem.datasheetUrl = pdfData;
            
            // Save to Firebase based on type
            let updatePromise;
            if (currentDatasheetType === 'cable') {
              updatePromise = updateCableInFirebase(currentDatasheetItem.id, currentDatasheetItem);
            } else if (currentDatasheetType === 'cb') {
              updatePromise = updateCBInFirebase(currentDatasheetItem.id, currentDatasheetItem);
            } else if (currentDatasheetType === 'switch') {
              updatePromise = updateSwitchInFirebase(currentDatasheetItem.id, currentDatasheetItem);
            }
            
            updatePromise.then(() => {
              showToast('Datasheet PDF uploaded successfully!', 'success');
              document.getElementById('datasheetModal').classList.remove('show');
              // Refresh the tables
              if (currentDatasheetType === 'cable') renderCableTables();
              else if (currentDatasheetType === 'cb') renderCBTables();
              else if (currentDatasheetType === 'switch') renderSwitchTables();
            }).catch(() => {
              showToast('Error uploading datasheet PDF. Please try again.', 'error');
            });
          };
          reader.readAsDataURL(file);
        }
        document.body.removeChild(fileInput);
      });
      
      fileInput.click();
    });

    document.getElementById('downloadDatasheetBtn').addEventListener('click', function() {
      const link = document.createElement('a');
      link.href = currentDatasheetItem.datasheetUrl;
      link.target = '_blank';
      
      let filename;
      if (currentDatasheetType === 'cable') {
        filename = currentDatasheetItem.oemPart + '_datasheet.pdf';
      } else if (currentDatasheetType === 'cb') {
        filename = currentDatasheetItem.cbOEMPart + '_datasheet.pdf';
      } else if (currentDatasheetType === 'switch') {
        filename = currentDatasheetItem.switchOEMPart + '_datasheet.pdf';
      }
      
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      document.getElementById('datasheetModal').classList.remove('show');
    });

    document.getElementById('deleteDatasheetBtn').addEventListener('click', function() {
      if (confirm('Are you sure you want to delete this datasheet?')) {
        currentDatasheetItem.datasheetUrl = null;
        
        // Save to Firebase based on type
        let updatePromise;
        if (currentDatasheetType === 'cable') {
          updatePromise = updateCableInFirebase(currentDatasheetItem.id, currentDatasheetItem);
        } else if (currentDatasheetType === 'cb') {
          updatePromise = updateCBInFirebase(currentDatasheetItem.id, currentDatasheetItem);
        } else if (currentDatasheetType === 'switch') {
          updatePromise = updateSwitchInFirebase(currentDatasheetItem.id, currentDatasheetItem);
        }
        
        updatePromise.then(() => {
          showToast('Datasheet deleted successfully!', 'success');
          document.getElementById('datasheetModal').classList.remove('show');
          // Refresh the tables
          if (currentDatasheetType === 'cable') renderCableTables();
          else if (currentDatasheetType === 'cb') renderCBTables();
          else if (currentDatasheetType === 'switch') renderSwitchTables();
        }).catch(() => {
          showToast('Error deleting datasheet. Please try again.', 'error');
        });
      }
    });

    document.getElementById('cancelDatasheetBtn').addEventListener('click', function() {
      document.getElementById('datasheetModal').classList.remove('show');
    });

    function deleteCableFromFirebase(docId) {
      return db.collection('cables').doc(docId).delete();
    }

    // Load cables on page load
    loadCablesFromFirebase();
    
    // Function to reload cables to ensure all have IDs
    function reloadCablesToFixIds() {
      console.log('Reloading cables to ensure all have IDs...');
      loadCablesFromFirebase();
    }
    
    // Debug function to check cable data
    function debugCableData() {
      console.log('=== CABLE DATA DEBUG ===');
      Object.keys(cableLibrary).forEach(category => {
        console.log(`Category: ${category}`);
        cableLibrary[category].forEach((cable, index) => {
          console.log(`  Index ${index}:`, {
            id: cable.id,
            oemPart: cable.oemPart,
            hasId: !!cable.id,
            type: typeof cable.id
          });
        });
      });
      console.log('=== END DEBUG ===');
    }
    
    // Test Firebase connection
    function testFirebaseConnection() {
      console.log('=== TESTING FIREBASE CONNECTION ===');
      console.log('Firebase db object:', db);
      
      // Try to read from the cables collection
      db.collection('cables').limit(1).get().then((querySnapshot) => {
        console.log('Firebase connection successful!');
        console.log('Number of documents:', querySnapshot.size);
        if (querySnapshot.size > 0) {
          const doc = querySnapshot.docs[0];
          console.log('Sample document ID:', doc.id);
          console.log('Sample document data:', doc.data());
        }
      }).catch((error) => {
        console.error('Firebase connection failed:', error);
      });
    }
    
    // Make functions available globally for debugging
    window.debugCableData = debugCableData;
    window.testFirebaseConnection = testFirebaseConnection;
    window.reloadCablesToFixIds = reloadCablesToFixIds;
    window.exportLibraryToExcel = exportLibraryToExcel;
    
    // Test export function
    function testExport() {
      console.log('Testing export functionality...');
      console.log('XLSX available:', typeof XLSX !== 'undefined');
      console.log('XLSX version:', XLSX.version);
      
      // Create a simple test workbook
      const testData = [
        { 'Test': 'Data', 'Value': 123 },
        { 'Test': 'Export', 'Value': 456 }
      ];
      
      try {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(testData);
        XLSX.utils.book_append_sheet(wb, ws, 'Test');
        XLSX.writeFile(wb, 'test_export.xlsx');
        console.log('Test export successful');
        showToast('Test export successful!', 'success');
      } catch (error) {
        console.error('Test export failed:', error);
        showToast('Test export failed: ' + error.message, 'error');
      }
    }
    
    window.testExport = testExport;
    
    // Export Library to Excel function
    function exportLibraryToExcel() {
      // Show export modal
      const exportModal = document.getElementById('exportModal');
      const exportProgressBar = document.getElementById('exportProgressBar');
      const exportProgressText = document.getElementById('exportProgressText');
      const exportButtons = document.getElementById('exportButtons');
      const exportCloseBtn = document.getElementById('exportCloseBtn');
      const exportRetryBtn = document.getElementById('exportRetryBtn');
      
      // Reset modal state
      exportProgressBar.style.width = '0%';
      exportProgressText.textContent = 'Preparing export...';
      exportButtons.style.display = 'none';
      
      // Show modal
      exportModal.classList.add('show');
      
      // Update progress
      setTimeout(() => {
        exportProgressBar.style.width = '20%';
        exportProgressText.textContent = 'Checking libraries...';
      }, 100);
      
      try {
        console.log('Starting export process...');
        console.log('XLSX object available:', typeof XLSX !== 'undefined');
        
        // Check if XLSX is available
        if (typeof XLSX === 'undefined') {
          exportProgressText.textContent = 'Error: Excel library not loaded';
          exportButtons.style.display = 'block';
          showToast('Excel export library not loaded. Please refresh the page.', 'error');
          return;
        }
        
        // Update progress
        setTimeout(() => {
          exportProgressBar.style.width = '40%';
          exportProgressText.textContent = 'Creating workbook...';
        }, 200);
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        console.log('Workbook created');
        
        let totalItems = 0;
        let cableCount = 0;
        let cbCount = 0;
        let switchCount = 0;
        
        // Update progress
        setTimeout(() => {
          exportProgressBar.style.width = '60%';
          exportProgressText.textContent = 'Processing cable library...';
        }, 300);
        
        // Export Cable Library
        console.log('Exporting cable library...');
        console.log('Cable library data:', cableLibrary);
        
        if (cableLibrary && Object.keys(cableLibrary).length > 0) {
          const cableData = [];
          Object.keys(cableLibrary).forEach(category => {
            console.log(`Processing cable category: ${category}`);
            if (cableLibrary[category] && Array.isArray(cableLibrary[category])) {
              cableLibrary[category].forEach((cable, index) => {
                console.log(`Processing cable ${index} in ${category}:`, cable);
                try {
                  if (category === 'EtherNET' || category === 'EtherCAT') {
                    cableData.push({
                      'Library': 'Cable',
                      'Category': category,
                      'OEM Part Number': cable.oemPart || '',
                      'Description': cable.description || '',
                      'Length': cable.length || '',
                      'Colour': cable.colour || '',
                      'Datasheet': cable.datasheetUrl ? 'Yes' : 'No'
                    });
                  } else {
                    cableData.push({
                      'Library': 'Cable',
                      'Category': category,
                      'OEM Part Number': cable.oemPart || '',
                      'Description': cable.cableDesc || '',
                      'No. of Cores': cable.numCores || '',
                      'Rating (A)': cable.cableRating || '',
                      'Datasheet': cable.datasheetUrl ? 'Yes' : 'No'
                    });
                  }
                } catch (cableError) {
                  console.error('Error processing cable:', cableError, cable);
                }
              });
            }
          });
          
          console.log('Cable data prepared:', cableData);
          cableCount = cableData.length;
          
          if (cableData.length > 0) {
            const cableWS = XLSX.utils.json_to_sheet(cableData);
            XLSX.utils.book_append_sheet(wb, cableWS, 'Cable Library');
            totalItems += cableData.length;
            console.log('Cable sheet added');
          }
        }
        
        // Update progress
        setTimeout(() => {
          exportProgressBar.style.width = '75%';
          exportProgressText.textContent = 'Processing circuit breaker library...';
        }, 400);
        
        // Export Circuit Breaker Library
        console.log('Exporting circuit breaker library...');
        console.log('CB library data:', cbLibrary);
        
        if (cbLibrary && Object.keys(cbLibrary).length > 0) {
          const cbData = [];
          Object.keys(cbLibrary).forEach(category => {
            console.log(`Processing CB category: ${category}`);
            if (cbLibrary[category] && Array.isArray(cbLibrary[category])) {
              cbLibrary[category].forEach((cb, index) => {
                console.log(`Processing CB ${index} in ${category}:`, cb);
                try {
                  cbData.push({
                    'Library': 'Circuit Breaker',
                    'Category': category,
                    'OEM Part Number': cb.cbOEMPart || '',
                    'Description': cb.cbDesc || '',
                    'Poles': cb.cbPoles || '',
                    'Rating (A)': cb.cbRating || '',
                    'Datasheet': cb.datasheetUrl ? 'Yes' : 'No'
                  });
                } catch (cbError) {
                  console.error('Error processing CB:', cbError, cb);
                }
              });
            }
          });
          
          console.log('CB data prepared:', cbData);
          cbCount = cbData.length;
          
          if (cbData.length > 0) {
            const cbWS = XLSX.utils.json_to_sheet(cbData);
            XLSX.utils.book_append_sheet(wb, cbWS, 'Circuit Breaker Library');
            totalItems += cbData.length;
            console.log('CB sheet added');
          }
        }
        
        // Update progress
        setTimeout(() => {
          exportProgressBar.style.width = '85%';
          exportProgressText.textContent = 'Processing switch library...';
        }, 500);
        
        // Export Switch Library
        console.log('Exporting switch library...');
        console.log('Switch library data:', switchLibrary);
        
        if (switchLibrary && Object.keys(switchLibrary).length > 0) {
          const switchData = [];
          Object.keys(switchLibrary).forEach(category => {
            console.log(`Processing switch category: ${category}`);
            if (switchLibrary[category] && Array.isArray(switchLibrary[category])) {
              switchLibrary[category].forEach((sw, index) => {
                console.log(`Processing switch ${index} in ${category}:`, sw);
                try {
                  switchData.push({
                    'Library': 'Switch',
                    'Category': category,
                    'OEM Part Number': sw.switchOEMPart || '',
                    'Description': sw.switchDesc || '',
                    'Poles': sw.switchPoles || '',
                    'Rating (A)': sw.switchRating || '',
                    'Datasheet': sw.datasheetUrl ? 'Yes' : 'No'
                  });
                } catch (switchError) {
                  console.error('Error processing switch:', switchError, sw);
                }
              });
            }
          });
          
          console.log('Switch data prepared:', switchData);
          switchCount = switchData.length;
          
          if (switchData.length > 0) {
            const switchWS = XLSX.utils.json_to_sheet(switchData);
            XLSX.utils.book_append_sheet(wb, switchWS, 'Switch Library');
            totalItems += switchData.length;
            console.log('Switch sheet added');
          }
        }
        
        // Update counts in modal
        document.getElementById('cableCount').textContent = cableCount;
        document.getElementById('cbCount').textContent = cbCount;
        document.getElementById('switchCount').textContent = switchCount;
        
        console.log(`Total items to export: ${totalItems}`);
        
        if (totalItems === 0) {
          // Update modal to show "no items" message
          document.getElementById('exportModalTitle').textContent = '📊 No Items Found';
          exportProgressText.textContent = 'No items found in any library';
          exportProgressBar.style.width = '100%';
          exportProgressBar.style.background = '#ffc107'; // Warning color
          exportButtons.style.display = 'block';
          
          // Update button text for this case
          document.getElementById('exportCloseBtn').textContent = 'Close';
          document.getElementById('exportRetryBtn').textContent = 'Check Again';
          
          showToast('No items found in any library. Please add some items first.', 'warning');
          return;
        }
        
        // Update progress
        setTimeout(() => {
          exportProgressBar.style.width = '95%';
          exportProgressText.textContent = 'Generating file...';
        }, 600);
        
        // Generate filename with current date
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
        const filename = `Library_Export_${dateStr}_${timeStr}.xlsx`;
        
        console.log('Attempting to save file:', filename);
        
        // Save the file
        XLSX.writeFile(wb, filename);
        console.log('File saved successfully');
        
        // Complete progress
        setTimeout(() => {
          exportProgressBar.style.width = '100%';
          exportProgressText.textContent = `Export completed! ${totalItems} items exported.`;
          exportButtons.style.display = 'block';
        }, 700);
        
        showToast(`Library exported successfully! ${totalItems} items exported.`, 'success');
        
      } catch (error) {
        console.error('Export error:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });
        
        exportProgressText.textContent = `Error: ${error.message}`;
        exportButtons.style.display = 'block';
        showToast(`Error exporting library: ${error.message}`, 'error');
      }
    }
    
    // Excel Import Functionality
    const importCategoryBtns = document.querySelectorAll('.import-category-btn');
    
    importCategoryBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const category = this.getAttribute('data-category');
        let fileInput;
        
        // Get the correct file input based on category
        switch(category) {
          case 'Single Core':
            fileInput = document.getElementById('singleCoreFile');
            break;
          case 'Multi Core':
            fileInput = document.getElementById('multiCoreFile');
            break;
          case 'Robotic Cable':
            fileInput = document.getElementById('roboticFile');
            break;
          case 'Flexible Cable':
            fileInput = document.getElementById('flexibleFile');
            break;
          case 'EtherNET':
            fileInput = document.getElementById('ethernetFile');
            break;
          case 'EtherCAT':
            fileInput = document.getElementById('ethercatFile');
            break;
        }
        
        if (fileInput) {
          fileInput.click();
        }
      });
    });
    
    document.getElementById('singleCoreFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'Single Core');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('multiCoreFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'Multi Core');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('roboticFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'Robotic Cable');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('flexibleFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'Flexible Cable');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('ethernetFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'EtherNET');
      }
      e.target.value = '';
    });
    document.getElementById('ethercatFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processExcelData(e.target.files[0], 'EtherCAT');
      }
      e.target.value = '';
    });
    
    function processExcelData(file, category) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          // Process the Excel data
          processExcelDataForCategory(jsonData, category);
          
          showToast('Excel file imported successfully!', 'success');
        } catch (error) {
          console.error('Error reading Excel file:', error);
          showToast('Error reading Excel file. Please check the format.', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processExcelDataForCategory(data, category) {
      let importedCount = 0;
      let updatedCount = 0;
      
      console.log(`Processing Excel data for category: ${category}`);
      console.log(`Total rows in Excel: ${data.length}`);
      
      // Skip header rows (first 2 rows)
      for (let i = 2; i < data.length; i++) {
        const row = data[i];
        console.log(`Processing row ${i}:`, row);
        
        if (row && row.length >= 3) {
          const partNumber = row[0]; // Column A - Part number
          const additionalName = row[2]; // Column C - Additional name
          
          console.log(`Row ${i} - Part Number: "${partNumber}", Additional Name: "${additionalName}"`);
          
          if (partNumber && additionalName) {
            // Extract information from the description
            const description = additionalName.toString();
            
            // Extract AWG rating from description - improved pattern matching
            let rating = 1; // Default rating
            let awg = null;
            
            // Multiple patterns to find AWG
            const awgPatterns = [
              /(\d+)AWG/i,
              /(\d+)\s*AWG/i,
              /AWG\s*(\d+)/i,
              /(\d+)\s*G/i
            ];
            
            console.log(`Processing description: "${description}"`);
            // Test the first pattern specifically
            const testMatch = description.match(/(\d+)AWG/i);
            console.log(`Test match for 10AWG pattern:`, testMatch);
            
            for (const pattern of awgPatterns) {
              const match = description.match(pattern);
              if (match) {
                awg = parseInt(match[1]);
                console.log(`AWG pattern "${pattern}" matched: ${awg}`);
                break;
              }
            }
            
            if (awg) {
              // Use comprehensive AWG to rating conversion with 60°C as default for Excel import
              rating = getRatingFromAWG(awg, 60);
              console.log(`Processing cable: ${partNumber} - AWG: ${awg}, Rating: ${rating}A`);
            } else {
              console.log(`No AWG found in description: "${description}"`);
              console.log(`Tried patterns:`, awgPatterns.map(p => p.toString()));
              
              // If no AWG found, try to extract mm² size and convert to rating
              const mm2Patterns = [
                /(\d+)X(\d+\.\d+)/i,  // e.g., 2X0.14, 3X0.25
                /(\d+)x(\d+\.\d+)/i,  // e.g., 2x0.14, 3x0.25
                /(\d+)\s*X\s*(\d+\.\d+)/i,  // e.g., 2 X 0.14
                /(\d+)\s*x\s*(\d+\.\d+)/i,  // e.g., 2 x 0.14
              ];
              
              let mm2Size = null;
              for (const pattern of mm2Patterns) {
                const match = description.match(pattern);
                if (match) {
                  mm2Size = parseFloat(match[2]);
                  console.log(`MM² pattern "${pattern}" matched: ${mm2Size} mm²`);
                  break;
                }
              }
              
              if (mm2Size) {
                // Convert mm² to rating using the ampacity table with 60°C as default
                const mm2Entry = ampacityTable.find(entry => entry.mm2 === mm2Size);
                if (mm2Entry) {
                  rating = mm2Entry.amps_60c || 1;
                  console.log(`MM² ${mm2Size} found in ampacity table: ${rating}A`);
                } else {
                  // Fallback rating based on mm² size
                  if (mm2Size <= 0.25) rating = 2;
                  else if (mm2Size <= 0.34) rating = 3;
                  else if (mm2Size <= 0.5) rating = 5;
                  else if (mm2Size <= 0.75) rating = 6;
                  else if (mm2Size <= 1.0) rating = 8;
                  else if (mm2Size <= 1.5) rating = 11;
                  else if (mm2Size <= 2.5) rating = 17;
                  else if (mm2Size <= 4.0) rating = 24;
                  else if (mm2Size <= 6.0) rating = 32;
                  else if (mm2Size <= 10.0) rating = 45;
                  else if (mm2Size <= 16.0) rating = 60;
                  else rating = 1; // Default fallback
                  
                  console.log(`MM² ${mm2Size} using fallback calculation: ${rating}A`);
                }
              } else {
                console.log(`No MM² size found in description: "${description}"`);
              }
            }
            
            // Extract number of cores from description - improved pattern matching
            let cores = 1; // Default
            const corePatterns = [
              /(\d+)X\d+/i,  // e.g., 2X0.5, 3X1.0
              /(\d+)\s*CORE/i,  // e.g., 2 CORE, 3 CORE
              /(\d+)\s*CONDUCTOR/i,  // e.g., 2 CONDUCTOR
              /(\d+)\s*WIRE/i,  // e.g., 2 WIRE
              /(\d+)\s*C/i,  // e.g., 2C, 3C
              /(\d+)CORE/i,  // e.g., 2CORE, 3CORE
              /(\d+)CONDUCTOR/i,  // e.g., 2CONDUCTOR
              /(\d+)WIRE/i,  // e.g., 2WIRE
              /(\d+)C/i,  // e.g., 2C, 3C
              /(\d+)X/i,  // e.g., 2X, 3X
              /(\d+)\s*X/i,  // e.g., 2 X, 3 X
            ];
            
            for (const pattern of corePatterns) {
              const match = description.match(pattern);
              if (match) {
                cores = parseInt(match[1]);
                console.log(`Core pattern "${pattern}" matched: ${cores} cores`);
                break;
              }
            }
            
            // Additional logic for specific cable types
            if (description.toLowerCase().includes('single') || description.toLowerCase().includes('1x')) {
              cores = 1;
              console.log(`Single core detected: ${cores} cores`);
            } else if (description.toLowerCase().includes('multi') || description.toLowerCase().includes('2x')) {
              cores = Math.max(cores, 2);
              console.log(`Multi core detected: ${cores} cores`);
            } else if (description.toLowerCase().includes('3x')) {
              cores = Math.max(cores, 3);
            } else if (description.toLowerCase().includes('4x')) {
              cores = Math.max(cores, 4);
            } else if (description.toLowerCase().includes('5x')) {
              cores = Math.max(cores, 5);
            } else if (description.toLowerCase().includes('6x')) {
              cores = Math.max(cores, 6);
            } else if (description.toLowerCase().includes('7x')) {
              cores = Math.max(cores, 7);
            } else if (description.toLowerCase().includes('8x')) {
              cores = Math.max(cores, 8);
            }
            
            console.log(`Final values - Part Number: "${partNumber}", Cores: ${cores}, Rating: ${rating}`);
            
            // Create cable object based on category
            let cableData;
            
            if (category === 'EtherNET' || category === 'EtherCAT') {
              // Extract length and colour from description for EtherNET/EtherCAT
              const lengthMatch = description.match(/(\d+M)/i);
              const colourMatch = description.match(/(GREY|BLACK|BLUE|WHITE|RED|GREEN|YELLOW|ORANGE|PURPLE|PINK|BROWN)/i);
              
              const length = lengthMatch ? lengthMatch[1] : '';
              const colour = colourMatch ? colourMatch[1] : '';
              
              console.log(`${category} extraction - Length: "${length}", Colour: "${colour}"`);
              
              cableData = {
                oemPart: partNumber.toString(),
                description: description,
                length: length,
                colour: colour
              };
            } else {
              cableData = {
                oemPart: partNumber.toString(),
                cableDesc: description,
                numCores: cores.toString(),
                cableRating: rating.toString()
              };
            }
            
            console.log(`Created cable object:`, cableData);
            
            // Check for duplicate part number
            let isDuplicate = false;
            let existingCable = null;
            let existingCategory = null;
            
            // Check in all categories for duplicates
            Object.keys(cableLibrary).forEach(cat => {
              const existing = cableLibrary[cat].find(cable => cable.oemPart === cableData.oemPart);
              if (existing) {
                isDuplicate = true;
                existingCable = existing;
                existingCategory = cat;
                console.log(`Duplicate found in category ${cat}:`, existing);
                return;
              }
            });
            
            if (isDuplicate) {
              // Cable already exists - increase rating
              const newRating = Math.max(parseInt(existingCable.cableRating), parseInt(cableData.cableRating));
              existingCable.cableRating = newRating.toString();
              console.log(`Updating existing cable with new rating: ${newRating}`);
              
              // Update in Firebase
              updateCableInFirebase(existingCable.id, existingCable);
              updatedCount++;
            } else {
              // Add new cable to local array
              if (cableLibrary[category]) {
                cableLibrary[category].push(cableData);
                console.log(`Adding new cable to category ${category}:`, cableData);
                
                // Save to Firebase
                saveCableToFirebase(category, cableData);
                importedCount++;
              }
            }
          } else {
            console.log(`Row ${i} skipped - missing part number or additional name`);
          }
        }
      }
      
      // Show summary toast
      if (importedCount > 0 || updatedCount > 0) {
        let message = '';
        if (importedCount > 0) message += `${importedCount} new cables imported. `;
        if (updatedCount > 0) message += `${updatedCount} existing cables updated.`;
        showToast(message, 'success');
      }
      
      // Refresh the display
      renderCableTables();
    }
    
    // Function to update cable in Firebase
    function updateCableInFirebase(docId, cableData) {
      let updateData = {
        oemPart: cableData.oemPart,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Check if this is EtherNET data by looking for description field
      if (cableData.description !== undefined) {
        updateData.description = cableData.description;
        updateData.length = cableData.length;
        updateData.colour = cableData.colour;
      } else {
        updateData.cableDesc = cableData.cableDesc;
        updateData.numCores = cableData.numCores;
        updateData.cableRating = cableData.cableRating;
      }
      
      // Add datasheet URL if it exists
      if (cableData.datasheetUrl !== undefined) {
        updateData.datasheetUrl = cableData.datasheetUrl;
      }
      
      return db.collection('cables').doc(docId).update(updateData).then(() => {
        console.log('Cable updated in Firebase');
        return true;
      }).catch((error) => {
        console.error('Error updating cable: ', error);
        return false;
      });
    }
    
    // Function to clear all cables by category
    function clearAllCablesByCategory(category) {
      const cablesToDelete = cableLibrary[category] || [];
      if (cablesToDelete.length === 0) {
        showToast('No cables found in this category', 'warning');
        return;
      }
      
      const batch = db.batch();
      cablesToDelete.forEach(cable => {
        if (cable.id) {
          const docRef = db.collection('cables').doc(cable.id);
          batch.delete(docRef);
        }
      });
      
      batch.commit().then(() => {
        console.log(`All ${category} cables cleared from Firebase`);
        showToast(`All ${category} cables and datasheets cleared successfully`, 'success');
        // Clear local array
        cableLibrary[category] = [];
        // Refresh the display
        renderCableTables();
      }).catch((error) => {
        console.error('Error clearing cables: ', error);
        showToast('Error clearing cables. Please try again.', 'error');
      });
    }
    
    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }
    
    // Library Navigation Functionality
    document.addEventListener('DOMContentLoaded', function() {
      const libraryBtns = document.querySelectorAll('.library-btn');
      const backBtn = document.getElementById('backToSelection');
      const librarySelection = document.getElementById('librarySelection');
      const librarySections = document.querySelectorAll('.library-section');
      const loginBtn = document.getElementById('loginBtn');
      const loginSection = document.getElementById('loginSection');
      const libraryButtons = document.getElementById('libraryButtons');
      const logoutBtn = document.getElementById('logoutBtn');
      
      // Show login section initially
      loginSection.style.display = 'block';
      libraryButtons.style.display = 'none';
      logoutBtn.style.display = 'none'; // Hide logout button initially

      // Login button click handler
      loginBtn.addEventListener('click', function() {
        // Show login modal
        document.getElementById('loginModal').classList.add('show');
        // Hide library selection
        librarySelection.style.display = 'none';
        // Hide back button
        backBtn.style.display = 'none';
        // Hide all library sections
        librarySections.forEach(section => {
          section.classList.remove('active');
        });
        logoutBtn.style.display = 'none'; // Hide logout button when logging in
      });

      // Library button click handlers
      libraryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const selectedLibrary = this.getAttribute('data-library');
          
          // Check if user is logged in using local authentication
          if (isAuthenticated) {
            // User is logged in, hide library selection
            librarySelection.style.display = 'none';
            backBtn.style.display = 'inline-block';
            // Hide login section
            loginSection.style.display = 'none';
            // Hide library buttons
            libraryButtons.style.display = 'flex';

            // Hide all library sections
            librarySections.forEach(section => {
              section.classList.remove('active');
            });

            // Show selected library section
            const targetSection = document.querySelector(`.${selectedLibrary}-library`);
            if (targetSection) {
              targetSection.classList.add('active');
              // Scroll to the library section
              targetSection.scrollIntoView({ behavior: 'smooth' });
              // Setup category filters for the shown section
              if (selectedLibrary === 'cable') setupCableCategoryFilters();
              if (selectedLibrary === 'circuit-breaker') setupCBCategoryFilters();
              if (selectedLibrary === 'switch') setupSwitchCategoryFilters();
            }
          } else {
            // User is not logged in, show login modal
            document.getElementById('loginModal').classList.add('show');
            // Hide library selection
            librarySelection.style.display = 'none';
            // Hide back button
            backBtn.style.display = 'none';
            // Hide all library sections
            librarySections.forEach(section => {
              section.classList.remove('active');
            });
          }
        });
      });
      
      // Back button click handler
      backBtn.addEventListener('click', function() {
        // If user is authenticated, show library selection with buttons
        if (isAuthenticated) {
          // Show library selection
          librarySelection.style.display = 'block';
          
          // Hide back button
          backBtn.style.display = 'none';
          
          // Hide all library sections
          librarySections.forEach(section => {
            section.classList.remove('active');
          });
          
          // Hide login section
          loginSection.style.display = 'none';
          // Show library buttons
          libraryButtons.style.display = 'flex';
          // Show logout and export buttons
          document.getElementById('logoutBtn').style.display = 'inline-block';
          document.getElementById('exportLibraryBtn').style.display = 'inline-block';
        } else {
          // If not authenticated, show login section
          librarySelection.style.display = 'block';
          backBtn.style.display = 'none';
          librarySections.forEach(section => {
            section.classList.remove('active');
          });
          loginSection.style.display = 'block';
          libraryButtons.style.display = 'none';
          logoutBtn.style.display = 'none';
        }

        // Scroll to library selection
        librarySelection.scrollIntoView({ behavior: 'smooth' });
      });
      
      // Back to Main Page button handlers
      const backToMainBtns = document.querySelectorAll('.back-to-main-btn');
      backToMainBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          // If user is authenticated, show library selection with buttons
          if (isAuthenticated) {
            // Show library selection
            librarySelection.style.display = 'block';
            
            // Hide back button
            backBtn.style.display = 'none';
            
            // Hide all library sections
            librarySections.forEach(section => {
              section.classList.remove('active');
            });
            
            // Hide login section
            loginSection.style.display = 'none';
            // Show library buttons
            libraryButtons.style.display = 'flex';
            // Show logout and export buttons
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('exportLibraryBtn').style.display = 'inline-block';
          } else {
            // If not authenticated, show login section
            librarySelection.style.display = 'block';
            backBtn.style.display = 'none';
            librarySections.forEach(section => {
              section.classList.remove('active');
            });
            loginSection.style.display = 'block';
            libraryButtons.style.display = 'none';
            logoutBtn.style.display = 'none';
          }

          // Scroll to top of page (main calculator)
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });
    });
  </script>

     <div class="circuit-breaker-library library-section" style="margin: 40px auto 0 auto; max-width: 1200px; width: 100%; background: #23262c; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); padding: 28px 18px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
      <h2 style="color: #61dafb; margin: 0;">Circuit Breaker Library</h2>
      <button class="back-to-main-btn" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">← Back to Main Page</button>
    </div>
    <form id="cbForm" style="display: flex; flex-wrap: nowrap; gap: 20px; align-items: flex-end; justify-content: center; margin-bottom: 0;">
      <div style="min-width: 140px;">
        <label for="cbCategory" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">Category:</label>
        <select id="cbCategory" required style="width: 140px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;">
          <option value="Main CB">Main CB</option>
          <option value="RCCB">RCCB</option>
          <option value="CB">CB</option>
          <option value="DCB">DCB</option>
        </select>
      </div>
      <div style="min-width: 140px;">
        <label for="cbOEMPart" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">OEM Part Number:</label>
        <input type="text" id="cbOEMPart" required style="width: 140px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;" placeholder="Enter part number" />
      </div>
      <div style="min-width: 300px;">
        <label for="cbDesc" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">Description:</label>
        <input type="text" id="cbDesc" required style="width: 300px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;" placeholder="Enter description" />
      </div>
      <div style="min-width: 80px;">
        <label for="cbPoles" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">Poles:</label>
        <input type="number" id="cbPoles" min="1" max="4" required style="width: 80px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease; text-align: center;" placeholder="1" />
      </div>
      <div style="min-width: 80px;">
        <label for="cbRating" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">Rating (A):</label>
        <input type="number" id="cbRating" min="1" required style="width: 80px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease; text-align: center;" placeholder="16" />
      </div>
      <div>
        <button type="submit" style="padding: 12px 24px; background: linear-gradient(45deg, #61dafb, #4fa8c7); color: #23262c; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(97, 218, 251, 0.3);">Add CB</button>
      </div>
    </form>
    <div style="margin-top: 20px; text-align: center;">
      <h3 style="color: #ffb347; margin-bottom: 15px;">Import Excel Files by Category</h3>
      <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
        <div>
          <input type="file" id="mainCBFile" accept=".xlsx,.xls" style="display: none;" data-category="Main CB" />
          <button type="button" class="import-cb-category-btn" data-category="Main CB" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 Main CB</button>
        </div>
        <div>
          <input type="file" id="rccbFile" accept=".xlsx,.xls" style="display: none;" data-category="RCCB" />
          <button type="button" class="import-cb-category-btn" data-category="RCCB" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 RCCB</button>
        </div>
        <div>
          <input type="file" id="cbFile" accept=".xlsx,.xls" style="display: none;" data-category="CB" />
          <button type="button" class="import-cb-category-btn" data-category="CB" style="padding: 8px 16px; background: #FF9800; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 CB</button>
        </div>
        <div>
          <input type="file" id="dcbFile" accept=".xlsx,.xls" style="display: none;" data-category="DCB" />
          <button type="button" class="import-cb-category-btn" data-category="DCB" style="padding: 8px 16px; background: #9C27B0; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 DCB</button>
        </div>
      </div>
      <div style="margin-top: 18px; display: flex; justify-content: center;">
        <input type="text" id="searchCBOEM" placeholder="Search by OEM Part No or Rating" style="padding: 12px 16px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; width: 350px; text-align: center; transition: border-color 0.3s ease;" />
      </div>
      <div style="margin-top: 12px; display: flex; justify-content: center; align-items: center; gap: 12px;">
        <label for="cbCategoryDropdown" style="color:#61dafb; font-weight:bold;">Category:</label>
        <select id="cbCategoryDropdown" style="padding: 8px 12px; border: 2px solid #444; border-radius: 6px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;">
          <option value="all">All Categories</option>
          <option value="Main CB">Main CB</option>
          <option value="RCCB">RCCB</option>
          <option value="CB">CB</option>
          <option value="DCB">DCB</option>
        </select>
      </div>
    </div>
    <div id="cbTables" style="margin-top: 30px;"></div>
  </div>
  <script>
    // --- Circuit Breaker Library Section ---
    const cbForm = document.getElementById('cbForm');
    const cbTablesDiv = document.getElementById('cbTables');
    const searchCBOEM = document.getElementById('searchCBOEM');
    let cbLibrary = {
      'Main CB': [],
      'RCCB': [],
      'CB': [],
      'DCB': []
    };

    cbForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const cbCategory = document.getElementById('cbCategory').value;
      const cbOEMPart = document.getElementById('cbOEMPart').value.trim();
      const cbDesc = document.getElementById('cbDesc').value.trim();
      const cbPoles = document.getElementById('cbPoles').value.trim();
      const cbRating = document.getElementById('cbRating').value.trim();
      if (!cbCategory || !cbOEMPart || !cbDesc || !cbPoles || !cbRating) return;
      
      // Save to Firebase first, then add to local array with the ID
      saveCBToFirebase(cbCategory, { cbOEMPart, cbDesc, cbPoles, cbRating }).then((docRef) => {
        if (docRef) {
          // Add to local array with the ID
          const newCB = { 
            id: docRef.id, 
            cbOEMPart, 
            cbDesc, 
            cbPoles, 
            cbRating 
          };
          cbLibrary[cbCategory].push(newCB);
          
          showToast('Circuit Breaker added successfully!', 'success');
          cbForm.reset();
          renderCBTables();
        } else {
          showToast('Error adding circuit breaker. Please try again.', 'error');
        }
      }).catch(() => {
        showToast('Error adding circuit breaker. Please try again.', 'error');
      });
    });

    // Firebase functions for Circuit Breaker Library
    function saveCBToFirebase(category, cbData) {
      const submitBtn = cbForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.innerHTML = '<span class="spinner"></span> Saving...';
      submitBtn.disabled = true;
      
      return db.collection('circuitBreakers').add({
        category: category,
        cbOEMPart: cbData.cbOEMPart,
        cbDesc: cbData.cbDesc,
        cbPoles: cbData.cbPoles,
        cbRating: cbData.cbRating,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then((docRef) => {
        console.log('Circuit Breaker saved to Firebase with ID:', docRef.id);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return docRef;
      }).catch((error) => {
        console.error('Error saving circuit breaker: ', error);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return null;
      });
    }

    function loadCBsFromFirebase() {
      db.collection('circuitBreakers').get().then((querySnapshot) => {
        cbLibrary = {
          'Main CB': [],
          'RCCB': [],
          'CB': [],
          'DCB': []
        };
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (cbLibrary[data.category]) {
            cbLibrary[data.category].push({
              id: doc.id,
              cbOEMPart: data.cbOEMPart,
              cbDesc: data.cbDesc,
              cbPoles: data.cbPoles,
              cbRating: data.cbRating,
              datasheetUrl: data.datasheetUrl || null
            });
          }
        });
        renderCBTables();
      }).catch((error) => {
        console.error('Error loading circuit breakers: ', error);
      });
    }

    function deleteCBFromFirebase(docId) {
      return db.collection('circuitBreakers').doc(docId).delete();
    }

    // Function to update circuit breaker in Firebase
    function updateCBInFirebase(docId, cbData) {
      let updateData = {
        cbOEMPart: cbData.cbOEMPart,
        cbDesc: cbData.cbDesc,
        cbPoles: cbData.cbPoles,
        cbRating: cbData.cbRating,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Add datasheet URL if it exists
      if (cbData.datasheetUrl !== undefined) {
        updateData.datasheetUrl = cbData.datasheetUrl;
      }
      
      return db.collection('circuitBreakers').doc(docId).update(updateData).then(() => {
        console.log('Circuit Breaker updated in Firebase');
        return true;
      }).catch((error) => {
        console.error('Error updating circuit breaker: ', error);
        return false;
      });
    }
    
    // Function to clear all circuit breakers by category
    function clearAllCBsByCategory(category) {
      const cbsToDelete = cbLibrary[category] || [];
      if (cbsToDelete.length === 0) {
        showToast('No circuit breakers found in this category', 'warning');
        return;
      }
      
      const batch = db.batch();
      cbsToDelete.forEach(cb => {
        if (cb.id) {
          const docRef = db.collection('circuitBreakers').doc(cb.id);
          batch.delete(docRef);
        }
      });
      
      batch.commit().then(() => {
        console.log(`All ${category} circuit breakers cleared from Firebase`);
        showToast(`All ${category} circuit breakers and datasheets cleared successfully`, 'success');
        // Clear local array
        cbLibrary[category] = [];
        // Refresh the display
        renderCBTables();
      }).catch((error) => {
        console.error('Error clearing circuit breakers: ', error);
        showToast('Error clearing circuit breakers. Please try again.', 'error');
      });
    }

    // Load circuit breakers on page load
    loadCBsFromFirebase();

    searchCBOEM.addEventListener('input', renderCBTables);

    function renderCBTables() {
      let html = '';
      const searchVal = searchCBOEM.value.trim().toLowerCase();
      const activeCategoryFilter = document.getElementById('cbCategoryDropdown')?.value || 'all';
      let found = false;
      
      Object.keys(cbLibrary).forEach(cat => {
        if (activeCategoryFilter !== 'all' && cat !== activeCategoryFilter) return;
        
        const filteredCBs = searchVal
          ? cbLibrary[cat].filter(cb => 
              cb.cbOEMPart.toLowerCase().includes(searchVal) || 
              cb.cbRating.toString().includes(searchVal)
            )
          : cbLibrary[cat];
        
        // Sort circuit breakers by rating in ascending order
        filteredCBs.sort((a, b) => parseInt(a.cbRating) - parseInt(b.cbRating));
        
        if (filteredCBs.length === 0) return;
        found = true;
        html += `<h3 style='color:#ffb347; margin-bottom:6px;'>${cat} <button class='clear-all-cb-btn' data-cat='${cat}' style='padding:4px 8px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:500;margin-left:10px;'>🗑️ Clear All</button></h3>`;
        html += `<table style='margin-bottom:18px;'><thead><tr><th style='text-align:center;'>OEM Part Number</th><th>Description</th><th style='text-align:center;'>Poles</th><th style='text-align:center;'>Rating (A)</th><th style='text-align:center;'>Action</th></tr></thead><tbody>`;
        filteredCBs.forEach((cb, idx) => {
          const datasheetColor = cb.datasheetUrl ? '#007bff' : '#dc3545';
          html += `<tr><td style='text-align:center;'>${cb.cbOEMPart}</td><td>${cb.cbDesc}</td><td style='text-align:center;'>${cb.cbPoles}</td><td style='text-align:center;'>${cb.cbRating}</td><td style='text-align:center;'><button class='datasheet-cb-btn' data-cat='${cat}' data-idx='${cbLibrary[cat].indexOf(cb)}' style='padding:4px 8px;background:${datasheetColor};color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>📄 Datasheet</button><br><button class='edit-cb-btn' data-cat='${cat}' data-idx='${cbLibrary[cat].indexOf(cb)}' style='padding:4px 8px;background:#4CAF50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>✏️ Edit</button></td></tr>`;
        });
        html += '</tbody></table>';
      });
      cbTablesDiv.innerHTML = found ? html : '<div style="color:#bbb;">No circuit breakers found.</div>';
    }

    // Datasheet CB event (event delegation)
    cbTablesDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('datasheet-cb-btn')) {
        const cbCat = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const cb = cbLibrary[cbCat][idx];
        
        // Show datasheet modal
        showDatasheetModal(cb, 'cb', cbCat, idx);
      }
      
      // Clear All CB event
      if (e.target.classList.contains('clear-all-cb-btn')) {
        const cbCategory = e.target.getAttribute('data-cat');
        if (confirm(`Are you sure you want to clear all ${cbCategory} circuit breakers and their datasheets? This action cannot be undone.`)) {
          clearAllCBsByCategory(cbCategory);
        }
      }
    });



    renderCBTables();
    
    // Excel Import Functionality for Circuit Breakers
    const importCBCategoryBtns = document.querySelectorAll('.import-cb-category-btn');
    
    importCBCategoryBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const category = this.getAttribute('data-category');
        let fileInput;
        
        // Get the correct file input based on category
        switch(category) {
          case 'Main CB':
            fileInput = document.getElementById('mainCBFile');
            break;
          case 'RCCB':
            fileInput = document.getElementById('rccbFile');
            break;
          case 'CB':
            fileInput = document.getElementById('cbFile');
            break;
          case 'DCB':
            fileInput = document.getElementById('dcbFile');
            break;
        }
        
        if (fileInput) {
          fileInput.click();
        }
      });
    });
    
    document.getElementById('mainCBFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processCBExcelData(e.target.files[0], 'Main CB');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('rccbFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processCBExcelData(e.target.files[0], 'RCCB');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('cbFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processCBExcelData(e.target.files[0], 'CB');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('dcbFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processCBExcelData(e.target.files[0], 'DCB');
      }
      e.target.value = ''; // Clear the file input
    });
    
    function processCBExcelData(file, category) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          // Process the Excel data
          processCBExcelDataForCategory(jsonData, category);
          
          showToast('Excel file imported successfully!', 'success');
        } catch (error) {
          console.error('Error reading Excel file:', error);
          showToast('Error reading Excel file. Please check the format.', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processCBExcelDataForCategory(data, category) {
      if (!data || data.length < 2) {
        showToast('Invalid Excel file format. Please check the file.', 'error');
        return;
      }
      
      const batch = db.batch();
      let importedCount = 0;
      let updatedCount = 0;
      
      // Skip header row, process data rows
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (row.length >= 4) {
          const cbOEMPart = row[0]?.toString().trim();
          const cbDesc = row[1]?.toString().trim();
          const cbPoles = row[2]?.toString().trim();
          const cbRating = row[3]?.toString().trim();
          
          if (cbOEMPart && cbDesc && cbPoles && cbRating) {
            // Check if circuit breaker already exists
            const existingCB = cbLibrary[category].find(cb => cb.cbOEMPart === cbOEMPart);
            
            if (existingCB) {
              // Update existing circuit breaker
              existingCB.cbDesc = cbDesc;
              existingCB.cbPoles = cbPoles;
              existingCB.cbRating = cbRating;
              updateCBInFirebase(existingCB.id, existingCB);
              updatedCount++;
            } else {
              // Add new circuit breaker
              const cbData = {
                category: category,
                cbOEMPart: cbOEMPart,
                cbDesc: cbDesc,
                cbPoles: cbPoles,
                cbRating: cbRating,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const docRef = db.collection('circuitBreakers').doc();
              batch.set(docRef, cbData);
              importedCount++;
            }
          }
        }
      }
      
      batch.commit().then(() => {
        // Reload data from Firebase
        loadCBsFromFirebase();
        
        let message = '';
        if (importedCount > 0) message += `${importedCount} new circuit breakers imported. `;
        if (updatedCount > 0) message += `${updatedCount} existing circuit breakers updated.`;
        showToast(message, 'success');
      }).catch((error) => {
        console.error('Error importing circuit breakers:', error);
        showToast('Error importing circuit breakers. Please try again.', 'error');
      });
    }
  </script>

     <div class="switch-library library-section" style="margin: 40px auto 0 auto; max-width: 1200px; width: 100%; background: #23262c; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); padding: 28px 18px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
      <h2 style="color: #61dafb; margin: 0;">Switch Library</h2>
      <button class="back-to-main-btn" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">← Back to Main Page</button>
    </div>
    <form id="switchForm" style="display: flex; flex-wrap: nowrap; gap: 20px; align-items: flex-end; justify-content: center; margin-bottom: 0;">
      <div style="min-width: 140px;">
        <label for="switchCategory" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">Category:</label>
        <select id="switchCategory" required style="width: 140px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;">
          <option value="Relay">Relay</option>
          <option value="Contactor">Contactor</option>
        </select>
      </div>
      <div style="min-width: 140px;">
        <label for="switchOEMPart" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">OEM Part Number:</label>
        <input type="text" id="switchOEMPart" required style="width: 140px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;" placeholder="Enter part number" />
      </div>
      <div style="min-width: 300px;">
        <label for="switchDesc" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">Description:</label>
        <input type="text" id="switchDesc" required style="width: 300px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;" placeholder="Enter description" />
      </div>
      <div style="min-width: 80px;">
        <label for="switchPoles" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">Poles:</label>
        <input type="number" id="switchPoles" min="1" max="4" required style="width: 80px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease; text-align: center;" placeholder="1" />
      </div>
      <div style="min-width: 80px;">
        <label for="switchRating" style="display: block; margin-bottom: 6px; color: #61dafb; font-weight: 600; font-size: 14px;">Rating (A):</label>
        <input type="number" id="switchRating" min="1" required style="width: 80px; padding: 10px 12px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease; text-align: center;" placeholder="16" />
      </div>
      <div>
        <button type="submit" style="padding: 12px 24px; background: linear-gradient(45deg, #61dafb, #4fa8c7); color: #23262c; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(97, 218, 251, 0.3);">Add Switch</button>
      </div>
    </form>
    <div style="margin-top: 20px; text-align: center;">
      <h3 style="color: #ffb347; margin-bottom: 15px;">Import Excel Files by Category</h3>
      <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
        <div>
          <input type="file" id="relayFile" accept=".xlsx,.xls" style="display: none;" data-category="Relay" />
          <button type="button" class="import-switch-category-btn" data-category="Relay" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 Relay</button>
        </div>
        <div>
          <input type="file" id="contactorFile" accept=".xlsx,.xls" style="display: none;" data-category="Contactor" />
          <button type="button" class="import-switch-category-btn" data-category="Contactor" style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📊 Contactor</button>
        </div>
      </div>
      <div style="margin-top: 18px; display: flex; justify-content: center;">
        <input type="text" id="searchSwitchOEM" placeholder="Search by OEM Part No or Rating" style="padding: 12px 16px; border: 2px solid #444; border-radius: 8px; background: #2e323a; color: #fff; font-size: 14px; width: 350px; text-align: center; transition: border-color 0.3s ease;" />
      </div>
      <div style="margin-top: 12px; display: flex; justify-content: center; align-items: center; gap: 12px;">
        <label for="switchCategoryDropdown" style="color:#61dafb; font-weight:bold;">Category:</label>
        <select id="switchCategoryDropdown" style="padding: 8px 12px; border: 2px solid #444; border-radius: 6px; background: #2e323a; color: #fff; font-size: 14px; transition: border-color 0.3s ease;">
          <option value="all">All Categories</option>
          <option value="Relay">Relay</option>
          <option value="Contactor">Contactor</option>
        </select>
      </div>
    </div>
    <div id="switchTables" style="margin-top: 30px;"></div>
  </div>
  <script>
    // --- Switch Library Section ---
    const switchForm = document.getElementById('switchForm');
    const switchTablesDiv = document.getElementById('switchTables');
    const searchSwitchOEM = document.getElementById('searchSwitchOEM');
    let switchLibrary = {
      'Relay': [],
      'Contactor': []
    };

    switchForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const switchCategory = document.getElementById('switchCategory').value;
      const switchOEMPart = document.getElementById('switchOEMPart').value.trim();
      const switchDesc = document.getElementById('switchDesc').value.trim();
      const switchPoles = document.getElementById('switchPoles').value.trim();
      const switchRating = document.getElementById('switchRating').value.trim();
      if (!switchCategory || !switchOEMPart || !switchDesc || !switchPoles || !switchRating) return;
      
      // Save to Firebase first, then add to local array with the ID
      saveSwitchToFirebase(switchCategory, { switchOEMPart, switchDesc, switchPoles, switchRating }).then((docRef) => {
        if (docRef) {
          // Add to local array with the ID
          const newSwitch = { 
            id: docRef.id, 
            switchOEMPart, 
            switchDesc, 
            switchPoles, 
            switchRating 
          };
          switchLibrary[switchCategory].push(newSwitch);
          
          showToast('Switch added successfully!', 'success');
          switchForm.reset();
          renderSwitchTables();
        } else {
          showToast('Error adding switch. Please try again.', 'error');
        }
      }).catch(() => {
        showToast('Error adding switch. Please try again.', 'error');
      });
    });

    // Firebase functions for Switch Library
    function saveSwitchToFirebase(category, switchData) {
      const submitBtn = switchForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.innerHTML = '<span class="spinner"></span> Saving...';
      submitBtn.disabled = true;
      
      return db.collection('switches').add({
        category: category,
        switchOEMPart: switchData.switchOEMPart,
        switchDesc: switchData.switchDesc,
        switchPoles: switchData.switchPoles,
        switchRating: switchData.switchRating,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then((docRef) => {
        console.log('Switch saved to Firebase with ID:', docRef.id);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return docRef;
      }).catch((error) => {
        console.error('Error saving switch: ', error);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return null;
      });
    }

    function loadSwitchesFromFirebase() {
      db.collection('switches').get().then((querySnapshot) => {
        switchLibrary = {
          'Relay': [],
          'Contactor': []
        };
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          if (switchLibrary[data.category]) {
            switchLibrary[data.category].push({
              id: doc.id,
              switchOEMPart: data.switchOEMPart,
              switchDesc: data.switchDesc,
              switchPoles: data.switchPoles,
              switchRating: data.switchRating,
              datasheetUrl: data.datasheetUrl || null
            });
          }
        });
        renderSwitchTables();
      }).catch((error) => {
        console.error('Error loading switches: ', error);
      });
    }

    function deleteSwitchFromFirebase(docId) {
      return db.collection('switches').doc(docId).delete();
    }

    // Function to update switch in Firebase
    function updateSwitchInFirebase(docId, switchData) {
      let updateData = {
        switchOEMPart: switchData.switchOEMPart,
        switchDesc: switchData.switchDesc,
        switchPoles: switchData.switchPoles,
        switchRating: switchData.switchRating,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Add datasheet URL if it exists
      if (switchData.datasheetUrl !== undefined) {
        updateData.datasheetUrl = switchData.datasheetUrl;
      }
      
      return db.collection('switches').doc(docId).update(updateData).then(() => {
        console.log('Switch updated in Firebase');
        return true;
      }).catch((error) => {
        console.error('Error updating switch: ', error);
        return false;
      });
    }
    
    // Function to clear all switches by category
    function clearAllSwitchesByCategory(category) {
      const switchesToDelete = switchLibrary[category] || [];
      if (switchesToDelete.length === 0) {
        showToast('No switches found in this category', 'warning');
        return;
      }
      
      const batch = db.batch();
      switchesToDelete.forEach(sw => {
        if (sw.id) {
          const docRef = db.collection('switches').doc(sw.id);
          batch.delete(docRef);
        }
      });
      
      batch.commit().then(() => {
        console.log(`All ${category} switches cleared from Firebase`);
        showToast(`All ${category} switches and datasheets cleared successfully`, 'success');
        // Clear local array
        switchLibrary[category] = [];
        // Refresh the display
        renderSwitchTables();
      }).catch((error) => {
        console.error('Error clearing switches: ', error);
        showToast('Error clearing switches. Please try again.', 'error');
      });
    }

    // Comprehensive AWG to rating conversion function
    function getRatingFromAWG(awg, temperature = 60) {
      console.log(`getRatingFromAWG called with awg: ${awg}, temperature: ${temperature}°C, type: ${typeof awg}`);
      
      // If not found, use ampacity table with temperature rating
      const awgEntry = ampacityTable.find(entry => entry.awg === awg.toString());
      if (awgEntry) {
        const ampacityField = `amps_${temperature}c`;
        if (awgEntry[ampacityField]) {
          console.log(`AWG ${awg} found in ampacity table at ${temperature}°C: ${awgEntry[ampacityField]}A`);
          return awgEntry[ampacityField];
        } else {
          // Fallback to 60°C if temperature rating not available
          console.log(`AWG ${awg} temperature ${temperature}°C not available, using 60°C: ${awgEntry.amps_60c}A`);
          return awgEntry.amps_60c || 1;
        }
      }
      
      console.log(`AWG ${awg} not found in ampacity table, using fallback calculation...`);
      
      // Fallback calculation based on AWG size (using 60°C ratings)
      let rating = 1;
      if (awg <= 22) rating = 3;
      else if (awg <= 20) rating = 5;
      else if (awg <= 18) rating = 6;
      else if (awg <= 16) rating = 8;
      else if (awg <= 14) rating = 11;
      else if (awg <= 12) rating = 17;
      else if (awg <= 10) rating = 24;
      else if (awg <= 8) rating = 32;
      else if (awg <= 6) rating = 45;
      else if (awg <= 4) rating = 60;
      
      console.log(`AWG ${awg} using fallback calculation: ${rating}A`);
      return rating;
    }
     
    // Load switches on page load
    loadSwitchesFromFirebase();

    searchSwitchOEM.addEventListener('input', renderSwitchTables);

    function renderSwitchTables() {
      let html = '';
      const searchVal = searchSwitchOEM.value.trim().toLowerCase();
      const activeCategoryFilter = document.getElementById('switchCategoryDropdown')?.value || 'all';
      let found = false;
      
      Object.keys(switchLibrary).forEach(cat => {
        if (activeCategoryFilter !== 'all' && cat !== activeCategoryFilter) return;
        
        const filteredSwitches = searchVal
          ? switchLibrary[cat].filter(sw => 
              sw.switchOEMPart.toLowerCase().includes(searchVal) || 
              sw.switchRating.toString().includes(searchVal)
            )
          : switchLibrary[cat];
        
        // Sort switches by rating in ascending order
        filteredSwitches.sort((a, b) => parseInt(a.switchRating) - parseInt(b.switchRating));
        
        if (filteredSwitches.length === 0) return;
        found = true;
        html += `<h3 style='color:#ffb347; margin-bottom:6px;'>${cat} <button class='clear-all-switch-btn' data-cat='${cat}' style='padding:4px 8px;background:#dc3545;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:500;margin-left:10px;'>🗑️ Clear All</button></h3>`;
        html += `<table style='margin-bottom:18px;'><thead><tr><th style='text-align:center;'>OEM Part Number</th><th>Description</th><th style='text-align:center;'>Poles</th><th style='text-align:center;'>Rating (A)</th><th style='text-align:center;'>Action</th></tr></thead><tbody>`;
        filteredSwitches.forEach((sw, idx) => {
          const datasheetColor = sw.datasheetUrl ? '#007bff' : '#dc3545';
          html += `<tr><td style='text-align:center;'>${sw.switchOEMPart}</td><td>${sw.switchDesc}</td><td style='text-align:center;'>${sw.switchPoles}</td><td style='text-align:center;'>${sw.switchRating}</td><td style='text-align:center;'><button class='datasheet-switch-btn' data-cat='${cat}' data-idx='${switchLibrary[cat].indexOf(sw)}' style='padding:4px 8px;background:${datasheetColor};color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>📄 Datasheet</button><br><button class='edit-switch-btn' data-cat='${cat}' data-idx='${switchLibrary[cat].indexOf(sw)}' style='padding:4px 8px;background:#4CAF50;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:3px;width:70px;text-align:center;font-size:11px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);'>✏️ Edit</button></td></tr>`;
        });
        html += '</tbody></table>';
      });
      switchTablesDiv.innerHTML = found ? html : '<div style="color:#bbb;">No switches found.</div>';
    }

    // Datasheet Switch event (event delegation)
    switchTablesDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('datasheet-switch-btn')) {
        const switchCat = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const sw = switchLibrary[switchCat][idx];
        
        // Show datasheet modal
        showDatasheetModal(sw, 'switch', switchCat, idx);
      }
      
      // Clear All Switch event
      if (e.target.classList.contains('clear-all-switch-btn')) {
        const switchCategory = e.target.getAttribute('data-cat');
        if (confirm(`Are you sure you want to clear all ${switchCategory} switches and their datasheets? This action cannot be undone.`)) {
          clearAllSwitchesByCategory(switchCategory);
        }
      }
    });



    renderSwitchTables();
    
    // Excel Import Functionality for Switches
    const importSwitchCategoryBtns = document.querySelectorAll('.import-switch-category-btn');
    
    importSwitchCategoryBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const category = this.getAttribute('data-category');
        let fileInput;
        
        // Get the correct file input based on category
        switch(category) {
          case 'Relay':
            fileInput = document.getElementById('relayFile');
            break;
          case 'Contactor':
            fileInput = document.getElementById('contactorFile');
            break;
        }
        
        if (fileInput) {
          fileInput.click();
        }
      });
    });
    
    document.getElementById('relayFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processSwitchExcelData(e.target.files[0], 'Relay');
      }
      e.target.value = ''; // Clear the file input
    });
    document.getElementById('contactorFile').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        processSwitchExcelData(e.target.files[0], 'Contactor');
      }
      e.target.value = ''; // Clear the file input
    });
    
    function processSwitchExcelData(file, category) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          // Process the Excel data
          processSwitchExcelDataForCategory(jsonData, category);
          
          showToast('Excel file imported successfully!', 'success');
        } catch (error) {
          console.error('Error reading Excel file:', error);
          showToast('Error reading Excel file. Please check the format.', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processSwitchExcelDataForCategory(data, category) {
      if (!data || data.length < 2) {
        showToast('Invalid Excel file format. Please check the file.', 'error');
        return;
      }
      
      const batch = db.batch();
      let importedCount = 0;
      let updatedCount = 0;
      
      // Skip header row, process data rows
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (row.length >= 4) {
          const switchOEMPart = row[0]?.toString().trim();
          const switchDesc = row[1]?.toString().trim();
          const switchPoles = row[2]?.toString().trim();
          const switchRating = row[3]?.toString().trim();
          
          if (switchOEMPart && switchDesc && switchPoles && switchRating) {
            // Check if switch already exists
            const existingSwitch = switchLibrary[category].find(sw => sw.switchOEMPart === switchOEMPart);
            
            if (existingSwitch) {
              // Update existing switch
              existingSwitch.switchDesc = switchDesc;
              existingSwitch.switchPoles = switchPoles;
              existingSwitch.switchRating = switchRating;
              updateSwitchInFirebase(existingSwitch.id, existingSwitch);
              updatedCount++;
            } else {
              // Add new switch
              const switchData = {
                category: category,
                switchOEMPart: switchOEMPart,
                switchDesc: switchDesc,
                switchPoles: switchPoles,
                switchRating: switchRating,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const docRef = db.collection('switches').doc();
              batch.set(docRef, switchData);
              importedCount++;
            }
          }
        }
      }
      
      batch.commit().then(() => {
        // Reload data from Firebase
        loadSwitchesFromFirebase();
        
        let message = '';
        if (importedCount > 0) message += `${importedCount} new switches imported. `;
        if (updatedCount > 0) message += `${updatedCount} existing switches updated.`;
        showToast(message, 'success');
      }).catch((error) => {
        console.error('Error importing switches:', error);
        showToast('Error importing switches. Please try again.', 'error');
      });
    }
  </script>

  <script>
    // Function to show minimum components from libraries
    function showMinimumComponents(currentRating) {
      console.log('=== showMinimumComponents called with currentRating:', currentRating);
      console.log('Current cableLibrary:', cableLibrary);
      
      let componentsHtml = '<div style="margin-top: 40px; max-width: 800px; margin-left: auto; margin-right: auto; text-align: center;">';
      componentsHtml += '<h2 style="color: #61dafb; text-align: center; margin-bottom: 20px;">Minimum Components for ' + currentRating + 'A</h2>';
      componentsHtml += `<div id="minCompCategoryFilters" style="display: flex; justify-content: center; gap: 12px; margin-bottom: 18px;">
        <button class="min-comp-filter-btn active" data-filter="all">All</button>
        <button class="min-comp-filter-btn" data-filter="cables">Cables</button>
        <button class="min-comp-filter-btn" data-filter="cbs">Circuit Breakers</button>
        <button class="min-comp-filter-btn" data-filter="switches">Switches</button>
      </div>`;
      
      // Cable Library components - Show only cables that can handle the input current
      let suitableCables = [];
      const minCompCableCategoryDropdown = document.getElementById('minCompCableCategoryDropdown');
      const selectedCableCat = minCompCableCategoryDropdown ? minCompCableCategoryDropdown.value : 'all';
      
      Object.keys(cableLibrary).forEach(cat => {
        if (cat === 'EtherNET') return; // Skip EtherNET if you want
        if (selectedCableCat !== 'all' && cat !== selectedCableCat) return;
        
        cableLibrary[cat].forEach(cable => {
          const cableRating = parseFloat(cable.cableRating);
          console.log(`Checking cable ${cable.oemPart}: rating=${cableRating}, currentRating=${currentRating}`);
          
          // Only show cables that can handle the input current
          if (cableRating >= currentRating) {
            suitableCables.push({...cable, category: cat});
            console.log(`✓ Added cable ${cable.oemPart} (${cableRating}A) for ${currentRating}A current`);
          } else {
            console.log(`✗ Skipped cable ${cable.oemPart} (${cableRating}A) for ${currentRating}A current`);
          }
        });
      });
      
      if (suitableCables.length > 0) {
        componentsHtml += `<div style='display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 8px;'>
          <label for='minCompCableCategoryDropdown' style='color:#61dafb; font-weight:bold;'>Cable Category:</label>
          <select id='minCompCableCategoryDropdown' style='padding: 6px 12px; border-radius: 4px; font-size: 1rem;'>
            <option value='all'>All Categories</option>
            <option value='Single Core'>Single Core</option>
            <option value='Multi Core'>Multi Core</option>
            <option value='Robotic Cable'>Robotic Cable</option>
            <option value='Flexible Cable'>Flexible Cable</option>
            <option value='EtherNET'>EtherNET</option>
            <option value='EtherCAT'>EtherCAT</option>
          </select>
        </div>`;
        componentsHtml += '<div class="min-comp-table" data-filter="cables" style="background: #23262c; border-radius: 12px; padding: 20px; margin-bottom: 20px;">';
        componentsHtml += '<h3 style="color: #ffb347; margin-bottom: 10px;">Suitable Cables</h3>';
        componentsHtml += '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Category</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">OEM Part Number</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Description</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">No. of Cores</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Rating (A)</th></tr></thead><tbody>';
        suitableCables.forEach(cable => {
          componentsHtml += `<tr style="background: #2e323a;"><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cable.category}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cable.oemPart}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cable.cableDesc}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cable.numCores}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cable.cableRating}</td></tr>`;
        });
        componentsHtml += '</tbody></table></div>';
      }
      
      // Circuit Breaker Library components
      let suitableCBs = [];
      Object.keys(cbLibrary).forEach(cat => {
        cbLibrary[cat].forEach(cb => {
          if (parseInt(cb.cbRating) >= currentRating) {
            suitableCBs.push({...cb, category: cat});
          }
        });
      });
      
      if (suitableCBs.length > 0) {
        componentsHtml += '<div class="min-comp-table" data-filter="cbs" style="background: #23262c; border-radius: 12px; padding: 20px; margin-bottom: 20px;">';
        componentsHtml += '<h3 style="color: #ffb347; margin-bottom: 10px;">Suitable Circuit Breakers</h3>';
        componentsHtml += '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Category</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">OEM Part Number</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Description</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Poles</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Rating (A)</th></tr></thead><tbody>';
        suitableCBs.forEach(cb => {
          componentsHtml += `<tr style="background: #2e323a;"><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cb.category}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cb.cbOEMPart}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cb.cbDesc}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cb.cbPoles}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${cb.cbRating}</td></tr>`;
        });
        componentsHtml += '</tbody></table></div>';
      }
      
      // Switch Library components
      let suitableSwitches = [];
      Object.keys(switchLibrary).forEach(cat => {
        switchLibrary[cat].forEach(sw => {
          if (parseInt(sw.switchRating) >= currentRating) {
            suitableSwitches.push({...sw, category: cat});
          }
        });
      });
      
      if (suitableSwitches.length > 0) {
        componentsHtml += '<div class="min-comp-table" data-filter="switches" style="background: #23262c; border-radius: 12px; padding: 20px; margin-bottom: 20px;">';
        componentsHtml += '<h3 style="color: #ffb347; margin-bottom: 10px;">Suitable Switches</h3>';
        componentsHtml += '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Category</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">OEM Part Number</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Description</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Poles</th><th style="border: 1px solid #444; padding: 8px; background: #353a45; color: #61dafb;">Rating (A)</th></tr></thead><tbody>';
        suitableSwitches.forEach(sw => {
          componentsHtml += `<tr style="background: #2e323a;"><td style="border: 1px solid #444; padding: 8px; color: #fff;">${sw.category}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${sw.switchOEMPart}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${sw.switchDesc}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${sw.switchPoles}</td><td style="border: 1px solid #444; padding: 8px; color: #fff;">${sw.switchRating}</td></tr>`;
        });
        componentsHtml += '</tbody></table></div>';
      }
      
      if (suitableCables.length === 0 && suitableCBs.length === 0 && suitableSwitches.length === 0) {
        componentsHtml += '<div style="background: #23262c; border-radius: 12px; padding: 20px; text-align: center; color: #bbb;">No suitable components found in libraries for ' + currentRating + 'A. Add components with higher ratings to your libraries.</div>';
      }
      
      componentsHtml += '</div>';
      
      // Add the components section after the results
      const existingComponents = document.getElementById('minimumComponents');
      if (existingComponents) {
        existingComponents.remove();
      }
      
      const componentsDiv = document.createElement('div');
      componentsDiv.id = 'minimumComponents';
      componentsDiv.innerHTML = componentsHtml;
      document.getElementById('calculatorContent').appendChild(componentsDiv);
      // Attach filter button event listeners immediately after rendering
      Array.from(componentsDiv.querySelectorAll('.min-comp-filter-btn')).forEach(btn => {
        btn.addEventListener('click', function() {
          componentsDiv.querySelectorAll('.min-comp-filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          const filter = this.getAttribute('data-filter');
          componentsDiv.querySelectorAll('.min-comp-table').forEach(table => {
            if (filter === 'all' || table.getAttribute('data-filter') === filter) {
              table.style.display = '';
            } else {
              table.style.display = 'none';
            }
          });
        });
      });
      
      // After rendering Minimum Components, re-attach the event listener to the dropdown
      const minCompCableCategoryDropdownLocal = document.getElementById('minCompCableCategoryDropdown');
      if (minCompCableCategoryDropdownLocal) {
        minCompCableCategoryDropdownLocal.value = selectedCableCat;
        minCompCableCategoryDropdownLocal.addEventListener('change', function() {
          showMinimumComponents(currentRating);
        });
      }
    }
  </script>
  <script>
    // Authentication Logic
    const ADMIN_CREDENTIALS = {
      username: 'Stratus',
      password: '12345678'
    };
    
    let isAuthenticated = false;
    
    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const loginError = document.getElementById('loginError');
      
      // Check credentials
      if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        isAuthenticated = true;
        
        // Hide login modal
        document.getElementById('loginModal').classList.remove('show');
        
        // Show library selection
        document.getElementById('librarySelection').style.display = 'block';
        
        // Show library buttons
        document.getElementById('libraryButtons').style.display = 'flex';
                  document.getElementById('logoutBtn').style.display = 'inline-block'; // Show logout button
          document.getElementById('exportLibraryBtn').style.display = 'inline-block'; // Show export button
        
        // Hide login section
        document.getElementById('loginSection').style.display = 'none';
        
        // Clear form
        document.getElementById('loginForm').reset();
        
        // Hide error message
        loginError.style.display = 'none';
        
        // Show success toast
        showToast('Login successful! Welcome to Library Management.', 'success');
        
        // Scroll to library selection
        document.getElementById('librarySelection').scrollIntoView({ behavior: 'smooth' });
      } else {
        // Show error message
        loginError.textContent = 'Invalid username or password. Please try again.';
        loginError.style.display = 'block';
        
        // Clear password field
        document.getElementById('password').value = '';
      }
    });
    
    // Close login modal when clicking outside
    document.getElementById('loginModal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
        // Show library selection again
        document.getElementById('librarySelection').style.display = 'block';
      }
    });
    
    // Handle Enter key in password field
    document.getElementById('password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('loginForm').dispatchEvent(new Event('submit'));
      }
    });
    
    // Export Library button handler
    document.getElementById('exportLibraryBtn').addEventListener('click', function() {
      exportLibraryToExcel();
    });
    
    // Tab navigation functionality
    document.getElementById('calculatorTab').addEventListener('click', function() {
      // Update tab buttons
      document.getElementById('calculatorTab').classList.add('active');
      document.getElementById('calculatorTab').style.background = '#61dafb';
      document.getElementById('calculatorTab').style.color = '#23262c';
      
      document.getElementById('libraryTab').classList.remove('active');
      document.getElementById('libraryTab').style.background = '#444';
      document.getElementById('libraryTab').style.color = '#fff';
      
      // Show calculator content
      document.getElementById('calculatorContent').classList.add('active');
      document.getElementById('calculatorContent').style.display = 'block';
      
      // Hide library content
      document.getElementById('libraryContent').classList.remove('active');
      document.getElementById('libraryContent').style.display = 'none';
    });
    
    document.getElementById('libraryTab').addEventListener('click', function() {
      // Update tab buttons
      document.getElementById('libraryTab').classList.add('active');
      document.getElementById('libraryTab').style.background = '#61dafb';
      document.getElementById('libraryTab').style.color = '#23262c';
      
      document.getElementById('calculatorTab').classList.remove('active');
      document.getElementById('calculatorTab').style.background = '#444';
      document.getElementById('calculatorTab').style.color = '#fff';
      
      // Show library content
      document.getElementById('libraryContent').classList.add('active');
      document.getElementById('libraryContent').style.display = 'block';
      
      // Hide calculator content
      document.getElementById('calculatorContent').classList.remove('active');
      document.getElementById('calculatorContent').style.display = 'none';
    });
    
    // Export modal button handlers
    document.getElementById('exportCloseBtn').addEventListener('click', function() {
      // Reset modal state when closing
      const exportProgressBar = document.getElementById('exportProgressBar');
      const exportProgressText = document.getElementById('exportProgressText');
      const exportButtons = document.getElementById('exportButtons');
      
      // Reset to default state
      document.getElementById('exportModalTitle').textContent = '📊 Exporting Library Data';
      exportProgressBar.style.width = '0%';
      exportProgressBar.style.background = 'linear-gradient(90deg, #4CAF50, #45a049)';
      exportProgressText.textContent = 'Preparing export...';
      exportButtons.style.display = 'none';
      
      document.getElementById('exportModal').classList.remove('show');
    });
    
    document.getElementById('exportRetryBtn').addEventListener('click', function() {
      document.getElementById('exportModal').classList.remove('show');
      setTimeout(() => {
        // Reset modal state before retrying
        const exportModal = document.getElementById('exportModal');
        const exportProgressBar = document.getElementById('exportProgressBar');
        const exportProgressText = document.getElementById('exportProgressText');
        const exportButtons = document.getElementById('exportButtons');
        
        // Reset to default state
        document.getElementById('exportModalTitle').textContent = '📊 Exporting Library Data';
        exportProgressBar.style.width = '0%';
        exportProgressBar.style.background = 'linear-gradient(90deg, #4CAF50, #45a049)';
        exportProgressText.textContent = 'Preparing export...';
        exportButtons.style.display = 'none';
        
        exportLibraryToExcel();
      }, 300);
    });
    
    // Logout button handler
    document.getElementById('logoutBtn').addEventListener('click', function() {
      // Reset authentication state
      isAuthenticated = false;
      
      // Show login section
      document.getElementById('loginSection').style.display = 'block';
      
      // Hide library buttons
      document.getElementById('libraryButtons').style.display = 'none';
      
      // Hide logout and export buttons
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('exportLibraryBtn').style.display = 'none';
      
      // Hide all library sections
      document.querySelectorAll('.library-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Hide back button
      document.getElementById('backToSelection').style.display = 'none';
      
      // Show success toast
      showToast('Logged out successfully!', 'info');
      
      // Scroll to library selection
      document.getElementById('librarySelection').scrollIntoView({ behavior: 'smooth' });
    });
  </script>
  
  <!-- Bottom Shortcuts -->
  <div style="text-align: center; margin: 40px 0 20px 0;">
    <button id="youtubeBtn" style="width: 50px; height: 50px; background: #ff0000; border: none; border-radius: 50%; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(255,0,0,0.3); transition: transform 0.2s; margin: 0 10px;">
      <div style="width: 0; height: 0; border-left: 12px solid white; border-top: 8px solid transparent; border-bottom: 8px solid transparent; margin-left: 2px;"></div>
    </button>
    <button id="googleBtn" style="width: 50px; height: 50px; background: #4285f4; border: none; border-radius: 50%; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(66,133,244,0.3); transition: transform 0.2s; margin: 0 10px;">
      <div style="font-size: 18px; font-weight: bold; color: white; font-family: 'Arial', sans-serif;">G</div>
    </button>
    <button id="renEcosystemBtn" style="width: 50px; height: 50px; background: #2c3e50; border: none; border-radius: 50%; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(44,62,80,0.3); transition: transform 0.2s; margin: 0 10px;">
      <div style="font-size: 12px; font-weight: bold; color: white; font-family: 'Arial', sans-serif; text-align: center; line-height: 1;">ECO</div>
    </button>
  </div>
  
  <!-- Creator Note -->
  <div style="text-align: center; padding: 10px; font-size: 0.9rem; color: #000; width: 100%; display: flex; justify-content: center;">
    Page Created by: Syamir
  </div>
  
  <script>
    // Shortcut button handlers
    document.addEventListener('DOMContentLoaded', function() {
      const youtubeBtn = document.getElementById('youtubeBtn');
      const googleBtn = document.getElementById('googleBtn');
      const renEcosystemBtn = document.getElementById('renEcosystemBtn');
      
      if (youtubeBtn) {
        youtubeBtn.addEventListener('click', function() {
          window.open('https://www.youtube.com', '_blank');
        });
      }
      
      if (googleBtn) {
        googleBtn.addEventListener('click', function() {
          window.open('https://www.google.com', '_blank');
        });
      }
      
      if (renEcosystemBtn) {
        renEcosystemBtn.addEventListener('click', function() {
          window.open('https://www.renecosystem.com/ESS/MY/sasb/', '_blank');
        });
      }
    });
  </script>

  <script>
    // Edit functionality
    let currentEditItem = null;
    let currentEditType = null;
    
    // Edit button event handlers (event delegation)
    cableTablesDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-cable-btn')) {
        const cableCategory = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const cableToEdit = cableLibrary[cableCategory][idx];
        
        console.log('Editing cable:', cableToEdit);
        
        // Populate edit modal
        document.getElementById('editModalTitle').textContent = 'Edit Cable';
        document.getElementById('editOEM').value = cableToEdit.oemPart;
        
        // Handle different cable types
        if (cableCategory === 'EtherNET' || cableCategory === 'EtherCAT') {
          document.getElementById('editDesc').value = cableToEdit.description || '';
          document.getElementById('editCores').value = cableToEdit.length || '';
          document.getElementById('editRating').value = cableToEdit.colour || '';
        } else {
          document.getElementById('editDesc').value = cableToEdit.cableDesc || '';
          document.getElementById('editCores').value = cableToEdit.numCores || '';
          document.getElementById('editRating').value = cableToEdit.cableRating || '';
        }
        
        // Store current edit item
        currentEditItem = { category: cableCategory, idx: idx, type: 'cable' };
        
        // Show edit modal
        document.getElementById('editModal').classList.add('show');
      }
    });
    
    cbTablesDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-cb-btn')) {
        const cbCategory = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const cbToEdit = cbLibrary[cbCategory][idx];
        
        // Populate edit modal
        document.getElementById('editModalTitle').textContent = 'Edit Circuit Breaker';
        document.getElementById('editOEM').value = cbToEdit.cbOEMPart;
        document.getElementById('editDesc').value = cbToEdit.cbDesc;
        document.getElementById('editCores').value = cbToEdit.cbPoles;
        document.getElementById('editRating').value = cbToEdit.cbRating;
        
        // Store current edit item
        currentEditItem = { category: cbCategory, idx: idx, type: 'cb' };
        
        // Show edit modal
        document.getElementById('editModal').classList.add('show');
      }
    });
    
    switchTablesDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-switch-btn')) {
        const switchCategory = e.target.getAttribute('data-cat');
        const idx = parseInt(e.target.getAttribute('data-idx'));
        const switchToEdit = switchLibrary[switchCategory][idx];
        
        // Populate edit modal
        document.getElementById('editModalTitle').textContent = 'Edit Switch';
        document.getElementById('editOEM').value = switchToEdit.switchOEMPart;
        document.getElementById('editDesc').value = switchToEdit.switchDesc;
        document.getElementById('editCores').value = switchToEdit.switchPoles;
        document.getElementById('editRating').value = switchToEdit.switchRating;
        
        // Store current edit item
        currentEditItem = { category: switchCategory, idx: idx, type: 'switch' };
        
        // Show edit modal
        document.getElementById('editModal').classList.add('show');
      }
    });
    

    
    // Edit form submission
    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!currentEditItem) return;
      
      const newOEM = document.getElementById('editOEM').value;
      const newDesc = document.getElementById('editDesc').value;
      const newCores = document.getElementById('editCores').value;
      const newRating = document.getElementById('editRating').value;
      
      // Update the item based on type
      if (currentEditItem.type === 'cable') {
        const cable = cableLibrary[currentEditItem.category][currentEditItem.idx];
        cable.oemPart = newOEM;
        
        // Handle different cable types
        if (currentEditItem.category === 'EtherNET' || currentEditItem.category === 'EtherCAT') {
          cable.description = newDesc;
          cable.length = newCores;
          cable.colour = newRating;
        } else {
          cable.cableDesc = newDesc;
          cable.numCores = newCores;
          cable.cableRating = newRating;
        }
        
        // Debug log
        console.log('Updating cable:', cable);
        if (!cable.id) {
          showToast('Error: Cable ID is missing. Cannot update.', 'error');
          return;
        }
        updateCableInFirebase(cable.id, cable).then((success) => {
          if (success) {
            renderCableTables();
            showToast('Cable updated successfully!', 'success');
          } else {
            showToast('Error updating cable. Please try again.', 'error');
          }
        });
      } else if (currentEditItem.type === 'cb') {
        const cb = cbLibrary[currentEditItem.category][currentEditItem.idx];
        cb.cbOEMPart = newOEM;
        cb.cbDesc = newDesc;
        cb.cbPoles = newCores;
        cb.cbRating = newRating;
        // Debug log
        console.log('Updating circuit breaker:', cb);
        if (!cb.id) {
          showToast('Error: Circuit Breaker ID is missing. Cannot update.', 'error');
          return;
        }
        updateCBInFirebase(cb.id, cb).then((success) => {
          if (success) {
            renderCBTables();
            showToast('Circuit Breaker updated successfully!', 'success');
          } else {
            showToast('Error updating circuit breaker. Please try again.', 'error');
          }
        });
      } else if (currentEditItem.type === 'switch') {
        const sw = switchLibrary[currentEditItem.category][currentEditItem.idx];
        sw.switchOEMPart = newOEM;
        sw.switchDesc = newDesc;
        sw.switchPoles = newCores;
        sw.switchRating = newRating;
        // Debug log
        console.log('Updating switch:', sw);
        if (!sw.id) {
          showToast('Error: Switch ID is missing. Cannot update.', 'error');
          return;
        }
        updateSwitchInFirebase(sw.id, sw).then((success) => {
          if (success) {
            renderSwitchTables();
            showToast('Switch updated successfully!', 'success');
          } else {
            showToast('Error updating switch. Please try again.', 'error');
          }
        });
      }
      
      // Hide edit modal
      document.getElementById('editModal').classList.remove('show');
      currentEditItem = null;
    });
    
    // Cancel edit button
    document.getElementById('cancelEdit').addEventListener('click', function() {
      document.getElementById('editModal').classList.remove('show');
      currentEditItem = null;
    });
    
    // Remove item button
    document.getElementById('removeItem').addEventListener('click', function() {
      if (!currentEditItem) {
        showToast('No item selected for removal.', 'error');
        return;
      }
      
      if (confirm('Are you sure you want to remove this item?')) {
        try {
          if (currentEditItem.type === 'cable') {
            const cable = cableLibrary[currentEditItem.category][currentEditItem.idx];
            console.log('Removing cable:', cable);
            
            if (!cable) {
              showToast('Cable not found.', 'error');
              return;
            }
            
            if (!cable.id) {
              showToast('Cable ID missing. Please refresh the page and try again.', 'error');
              return;
            }
            
            // Simple delete operation
            db.collection('cables').doc(cable.id).delete()
              .then(() => {
                console.log('Cable deleted from Firebase');
                // Remove from local array
                cableLibrary[currentEditItem.category].splice(currentEditItem.idx, 1);
                // Update display
                renderCableTables();
                showToast('Cable removed successfully!', 'success');
                // Close modal
                document.getElementById('editModal').classList.remove('show');
                currentEditItem = null;
              })
              .catch((error) => {
                console.error('Delete error:', error);
                showToast('Failed to remove cable. Please try again.', 'error');
              });
              
          } else if (currentEditItem.type === 'cb') {
            const cb = cbLibrary[currentEditItem.category][currentEditItem.idx];
            console.log('Removing circuit breaker:', cb);
            
            if (!cb || !cb.id) {
              showToast('Circuit breaker ID missing.', 'error');
              return;
            }
            
            db.collection('circuitBreakers').doc(cb.id).delete()
              .then(() => {
                console.log('Circuit breaker deleted from Firebase');
                cbLibrary[currentEditItem.category].splice(currentEditItem.idx, 1);
                renderCBTables();
                showToast('Circuit Breaker removed successfully!', 'success');
                document.getElementById('editModal').classList.remove('show');
                currentEditItem = null;
              })
              .catch((error) => {
                console.error('Delete error:', error);
                showToast('Failed to remove circuit breaker. Please try again.', 'error');
              });
              
          } else if (currentEditItem.type === 'switch') {
            const sw = switchLibrary[currentEditItem.category][currentEditItem.idx];
            console.log('Removing switch:', sw);
            
            if (!sw || !sw.id) {
              showToast('Switch ID missing.', 'error');
              return;
            }
            
            db.collection('switches').doc(sw.id).delete()
              .then(() => {
                console.log('Switch deleted from Firebase');
                switchLibrary[currentEditItem.category].splice(currentEditItem.idx, 1);
                renderSwitchTables();
                showToast('Switch removed successfully!', 'success');
                document.getElementById('editModal').classList.remove('show');
                currentEditItem = null;
              })
              .catch((error) => {
                console.error('Delete error:', error);
                showToast('Failed to remove switch. Please try again.', 'error');
              });
          }
        } catch (error) {
          console.error('Remove operation error:', error);
          showToast('An error occurred during removal. Please try again.', 'error');
        }
      }
    });
    
    // Close edit modal when clicking outside
    document.getElementById('editModal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
        currentEditItem = null;
      }
    });
  </script>
  
  <script>
    document.querySelectorAll('.min-comp-filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.min-comp-filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const filter = this.getAttribute('data-filter');
        document.querySelectorAll('.min-comp-table').forEach(table => {
          if (filter === 'all' || table.getAttribute('data-filter') === filter) {
            table.style.display = '';
          } else {
            table.style.display = 'none';
          }
        });
      });
    });
  </script>

  <script>
    // Add event listeners for category filter buttons
    document.addEventListener('DOMContentLoaded', function() {
      // Cable Library category filters
      const cableCategoryBtns = document.querySelectorAll('.category-filter-btn[data-category]');
      cableCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          // Remove active class from all buttons
          cableCategoryBtns.forEach(b => b.classList.remove('active'));
          // Add active class to clicked button
          this.classList.add('active');
          // Re-render tables
          renderCableTables();
        });
      });
      
      // Circuit Breaker Library category filters
      const cbCategoryBtns = document.querySelectorAll('.category-filter-btn[data-category]');
      cbCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          cbCategoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          renderCBTables();
        });
      });
      
      // Switch Library category filters
      const switchCategoryBtns = document.querySelectorAll('.category-filter-btn[data-category]');
      switchCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          switchCategoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          renderSwitchTables();
        });
      });
    });
  </script>

  <script>
    // Replace the global event listener logic for category filter buttons with section-specific logic
    // Remove the previous global event listener script for .category-filter-btn
    // Add this after each library section is shown (e.g., in the code that activates .cable-library, .circuit-breaker-library, .switch-library):

    function setupCableCategoryFilters() {
      const cableCategoryBtns = document.querySelectorAll('.cable-library .category-filter-btn[data-category]');
      cableCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          cableCategoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          renderCableTables();
        });
      });
    }

    function setupCBCategoryFilters() {
      const cbCategoryBtns = document.querySelectorAll('.circuit-breaker-library .category-filter-btn[data-category]');
      cbCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          cbCategoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          renderCBTables();
        });
      });
    }

    function setupSwitchCategoryFilters() {
      const switchCategoryBtns = document.querySelectorAll('.switch-library .category-filter-btn[data-category]');
      switchCategoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          switchCategoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          renderSwitchTables();
        });
      });
    }

    // Call these functions after showing each library section, e.g.:
    // When showing Cable Library:
    // setupCableCategoryFilters();
    // When showing Circuit Breaker Library:
    // setupCBCategoryFilters();
    // When showing Switch Library:
    // setupSwitchCategoryFilters();

    // Also call the relevant setup function in DOMContentLoaded for the initially visible section (if any)
    document.addEventListener('DOMContentLoaded', function() {
      setupCableCategoryFilters();
      setupCBCategoryFilters();
      setupSwitchCategoryFilters();
    });
  </script>

  <script>
    // Add event listeners for the dropdowns to re-render tables on change
    document.addEventListener('DOMContentLoaded', function() {
      const cableCategoryDropdown = document.getElementById('cableCategoryDropdown');
      if (cableCategoryDropdown) cableCategoryDropdown.addEventListener('change', renderCableTables);
      const cbCategoryDropdown = document.getElementById('cbCategoryDropdown');
      if (cbCategoryDropdown) cbCategoryDropdown.addEventListener('change', renderCBTables);
      const switchCategoryDropdown = document.getElementById('switchCategoryDropdown');
      if (switchCategoryDropdown) switchCategoryDropdown.addEventListener('change', renderSwitchTables);
    });
  </script>

  <script>
    // Add event listener to the dropdown to re-run showMinimumComponents when changed
    document.addEventListener('DOMContentLoaded', function() {
      const minCompCableCategoryDropdown = document.getElementById('minCompCableCategoryDropdown');
      if (minCompCableCategoryDropdown) {
        minCompCableCategoryDropdown.addEventListener('change', function() {
          const value = parseFloat(document.getElementById('currentInput').value);
          if (!isNaN(value) && value > 0) {
            showMinimumComponents(value);
          }
        });
      }
    });
  </script>
</body>
</html> 
</html> 
